

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>buku &mdash; Buku  documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../genindex.html"/>
        <link rel="search" title="Search" href="../search.html"/>
    <link rel="top" title="Buku  documentation" href="../index.html"/>
        <link rel="up" title="Module code" href="index.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> Buku
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../source/buku.html">Buku</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Buku</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Module code</a> &raquo;</li>
        
      <li>buku</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for buku</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python3</span>
<span class="c1">#</span>
<span class="c1"># Bookmark management utility</span>
<span class="c1">#</span>
<span class="c1"># Copyright Â© 2015-2017 Arun Prakash Jana &lt;engineerarun@gmail.com&gt;</span>
<span class="c1">#</span>
<span class="c1"># This program is free software: you can redistribute it and/or modify</span>
<span class="c1"># it under the terms of the GNU General Public License as published by</span>
<span class="c1"># the Free Software Foundation, either version 3 of the License, or</span>
<span class="c1"># (at your option) any later version.</span>
<span class="c1">#</span>
<span class="c1"># This program is distributed in the hope that it will be useful,</span>
<span class="c1"># but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c1"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="c1"># GNU General Public License for more details.</span>
<span class="c1">#</span>
<span class="c1"># You should have received a copy of the GNU General Public License</span>
<span class="c1"># along with Buku.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">html.parser</span> <span class="k">as</span> <span class="nn">HTMLParser</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">readline</span>
    <span class="n">readline</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="k">pass</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">signal</span>
<span class="kn">import</span> <span class="nn">sqlite3</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">urllib3</span>
<span class="kn">from</span> <span class="nn">urllib3.util</span> <span class="k">import</span> <span class="n">parse_url</span><span class="p">,</span> <span class="n">make_headers</span>
<span class="kn">import</span> <span class="nn">webbrowser</span>

<span class="n">__version__</span> <span class="o">=</span> <span class="s1">&#39;3.2&#39;</span>
<span class="n">__author__</span> <span class="o">=</span> <span class="s1">&#39;Arun Prakash Jana &lt;engineerarun@gmail.com&gt;&#39;</span>
<span class="n">__license__</span> <span class="o">=</span> <span class="s1">&#39;GPLv3&#39;</span>

<span class="c1"># Global variables</span>
<span class="n">interrupted</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># Received SIGINT</span>
<span class="n">DELIM</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span>  <span class="c1"># Delimiter used to store tags in DB</span>
<span class="n">SKIP_MIMES</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;.pdf&#39;</span><span class="p">,</span> <span class="s1">&#39;.txt&#39;</span><span class="p">}</span>
<span class="n">promptmsg</span> <span class="o">=</span> <span class="s1">&#39;buku (? for help): &#39;</span>  <span class="c1"># Prompt message string</span>

<span class="c1"># Default format specifiers to print records</span>
<span class="n">ID_str</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%d</span><span class="s1">. </span><span class="si">%s</span><span class="s1"> [</span><span class="si">%s</span><span class="s1">]</span><span class="se">\n</span><span class="s1">&#39;</span>
<span class="n">ID_DB_str</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%d</span><span class="s1">. </span><span class="si">%s</span><span class="s1">&#39;</span>
<span class="n">MUTE_str</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> (L)</span><span class="se">\n</span><span class="s1">&#39;</span>
<span class="n">URL_str</span> <span class="o">=</span> <span class="s1">&#39;   &gt; </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span>
<span class="n">DESC_str</span> <span class="o">=</span> <span class="s1">&#39;   + </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span>
<span class="n">TAG_str</span> <span class="o">=</span> <span class="s1">&#39;   # </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span>

<span class="c1"># colormap for color output from &quot;googler&quot; project</span>
<span class="n">COLORMAP</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="s1">&#39;</span><span class="se">\x1b</span><span class="s1">[</span><span class="si">%s</span><span class="s1">m&#39;</span> <span class="o">%</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="p">{</span>
    <span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="s1">&#39;30&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="s1">&#39;31&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">:</span> <span class="s1">&#39;32&#39;</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">:</span> <span class="s1">&#39;33&#39;</span><span class="p">,</span>
    <span class="s1">&#39;e&#39;</span><span class="p">:</span> <span class="s1">&#39;34&#39;</span><span class="p">,</span> <span class="s1">&#39;f&#39;</span><span class="p">:</span> <span class="s1">&#39;35&#39;</span><span class="p">,</span> <span class="s1">&#39;g&#39;</span><span class="p">:</span> <span class="s1">&#39;36&#39;</span><span class="p">,</span> <span class="s1">&#39;h&#39;</span><span class="p">:</span> <span class="s1">&#39;37&#39;</span><span class="p">,</span>
    <span class="s1">&#39;i&#39;</span><span class="p">:</span> <span class="s1">&#39;90&#39;</span><span class="p">,</span> <span class="s1">&#39;j&#39;</span><span class="p">:</span> <span class="s1">&#39;91&#39;</span><span class="p">,</span> <span class="s1">&#39;k&#39;</span><span class="p">:</span> <span class="s1">&#39;92&#39;</span><span class="p">,</span> <span class="s1">&#39;l&#39;</span><span class="p">:</span> <span class="s1">&#39;93&#39;</span><span class="p">,</span>
    <span class="s1">&#39;m&#39;</span><span class="p">:</span> <span class="s1">&#39;94&#39;</span><span class="p">,</span> <span class="s1">&#39;n&#39;</span><span class="p">:</span> <span class="s1">&#39;95&#39;</span><span class="p">,</span> <span class="s1">&#39;o&#39;</span><span class="p">:</span> <span class="s1">&#39;96&#39;</span><span class="p">,</span> <span class="s1">&#39;p&#39;</span><span class="p">:</span> <span class="s1">&#39;97&#39;</span><span class="p">,</span>
    <span class="s1">&#39;A&#39;</span><span class="p">:</span> <span class="s1">&#39;30;1&#39;</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">:</span> <span class="s1">&#39;31;1&#39;</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">:</span> <span class="s1">&#39;32;1&#39;</span><span class="p">,</span> <span class="s1">&#39;D&#39;</span><span class="p">:</span> <span class="s1">&#39;33;1&#39;</span><span class="p">,</span>
    <span class="s1">&#39;E&#39;</span><span class="p">:</span> <span class="s1">&#39;34;1&#39;</span><span class="p">,</span> <span class="s1">&#39;F&#39;</span><span class="p">:</span> <span class="s1">&#39;35;1&#39;</span><span class="p">,</span> <span class="s1">&#39;G&#39;</span><span class="p">:</span> <span class="s1">&#39;36;1&#39;</span><span class="p">,</span> <span class="s1">&#39;H&#39;</span><span class="p">:</span> <span class="s1">&#39;37;1&#39;</span><span class="p">,</span>
    <span class="s1">&#39;I&#39;</span><span class="p">:</span> <span class="s1">&#39;90;1&#39;</span><span class="p">,</span> <span class="s1">&#39;J&#39;</span><span class="p">:</span> <span class="s1">&#39;91;1&#39;</span><span class="p">,</span> <span class="s1">&#39;K&#39;</span><span class="p">:</span> <span class="s1">&#39;92;1&#39;</span><span class="p">,</span> <span class="s1">&#39;L&#39;</span><span class="p">:</span> <span class="s1">&#39;93;1&#39;</span><span class="p">,</span>
    <span class="s1">&#39;M&#39;</span><span class="p">:</span> <span class="s1">&#39;94;1&#39;</span><span class="p">,</span> <span class="s1">&#39;N&#39;</span><span class="p">:</span> <span class="s1">&#39;95;1&#39;</span><span class="p">,</span> <span class="s1">&#39;O&#39;</span><span class="p">:</span> <span class="s1">&#39;96;1&#39;</span><span class="p">,</span> <span class="s1">&#39;P&#39;</span><span class="p">:</span> <span class="s1">&#39;97;1&#39;</span><span class="p">,</span>
    <span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="s1">&#39;7&#39;</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">:</span> <span class="s1">&#39;7;1&#39;</span><span class="p">,</span> <span class="s1">&#39;z&#39;</span><span class="p">:</span> <span class="s1">&#39;2&#39;</span><span class="p">,</span>
<span class="p">}</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

<span class="c1"># Disguise as Firefox on Ubuntu</span>
<span class="n">USER_AGENT</span> <span class="o">=</span> <span class="s1">&#39;Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:54.0) Gecko/20100101 Firefox/54.0&#39;</span>
<span class="n">myheaders</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Default dictionary of headers</span>
<span class="n">myproxy</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Default proxy</span>

<span class="c1"># Set up logging</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span>
<span class="n">logdbg</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">debug</span>
<span class="n">logerr</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">error</span>


<div class="viewcode-block" id="BukuHTMLParser"><a class="viewcode-back" href="../source/buku.html#buku.BukuHTMLParser">[docs]</a><span class="k">class</span> <span class="nc">BukuHTMLParser</span><span class="p">(</span><span class="n">HTMLParser</span><span class="o">.</span><span class="n">HTMLParser</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Class to parse and fetch the title from a HTML page, if available.</span>

<span class="sd">    .. note:: The methods in this class are custom implementations of the</span>
<span class="sd">              HTMLParser object.</span>

<span class="sd">              See docs https://docs.python.org/3/library/html.parser.html.</span>


<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    in_title_tag : bool</span>
<span class="sd">        True if HTML tag is a &lt;title&gt; tag. Initial value is False.</span>
<span class="sd">    data : str</span>
<span class="sd">        Initial value is empty string.</span>
<span class="sd">    prev_tag : None or str</span>
<span class="sd">        Initial value is None.</span>
<span class="sd">    parsed_title : None or str</span>
<span class="sd">        The parsed title from a title tag. Initial value is None.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">HTMLParser</span><span class="o">.</span><span class="n">HTMLParser</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">in_title_tag</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prev_tag</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parsed_title</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="BukuHTMLParser.handle_starttag"><a class="viewcode-back" href="../source/buku.html#buku.BukuHTMLParser.handle_starttag">[docs]</a>    <span class="k">def</span> <span class="nf">handle_starttag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">attrs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">in_title_tag</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;title&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">in_title_tag</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prev_tag</span> <span class="o">=</span> <span class="n">tag</span></div>

<div class="viewcode-block" id="BukuHTMLParser.handle_endtag"><a class="viewcode-back" href="../source/buku.html#buku.BukuHTMLParser.handle_endtag">[docs]</a>    <span class="k">def</span> <span class="nf">handle_endtag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;title&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">in_title_tag</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">parsed_title</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>  <span class="c1"># We have received title data, exit parsing</span></div>

<div class="viewcode-block" id="BukuHTMLParser.handle_data"><a class="viewcode-back" href="../source/buku.html#buku.BukuHTMLParser.handle_data">[docs]</a>    <span class="k">def</span> <span class="nf">handle_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_tag</span> <span class="o">==</span> <span class="s1">&#39;title&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_title_tag</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">+=</span> <span class="n">data</span></div>

<div class="viewcode-block" id="BukuHTMLParser.error"><a class="viewcode-back" href="../source/buku.html#buku.BukuHTMLParser.error">[docs]</a>    <span class="k">def</span> <span class="nf">error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="k">pass</span></div></div>


<div class="viewcode-block" id="BukuCrypt"><a class="viewcode-back" href="../source/buku.html#buku.BukuCrypt">[docs]</a><span class="k">class</span> <span class="nc">BukuCrypt</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Class to handle encryption and decryption of</span>
<span class="sd">    the database file. Functionally a separate entity.</span>

<span class="sd">    Involves late imports in the static functions but it</span>
<span class="sd">    saves ~100ms each time. Given that encrypt/decrypt are</span>
<span class="sd">    not done automatically and any one should be called at</span>
<span class="sd">    a time, this doesn&#39;t seem to be an outrageous approach.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Crypto constants</span>
    <span class="n">BLOCKSIZE</span> <span class="o">=</span> <span class="mh">0x10000</span>  <span class="c1"># 64 KB blocks</span>
    <span class="n">SALT_SIZE</span> <span class="o">=</span> <span class="mh">0x20</span>
    <span class="n">CHUNKSIZE</span> <span class="o">=</span> <span class="mh">0x80000</span>  <span class="c1"># Read/write 512 KB chunks</span>

<div class="viewcode-block" id="BukuCrypt.get_filehash"><a class="viewcode-back" href="../source/buku.html#buku.BukuCrypt.get_filehash">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_filehash</span><span class="p">(</span><span class="n">filepath</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the SHA256 hash of a file</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filepath : str</span>
<span class="sd">            Path to the file</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        hash : bytes</span>
<span class="sd">            Hash digest of file</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">hashlib</span> <span class="k">import</span> <span class="n">sha256</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
            <span class="n">hasher</span> <span class="o">=</span> <span class="n">sha256</span><span class="p">()</span>
            <span class="n">buf</span> <span class="o">=</span> <span class="n">fp</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">BukuCrypt</span><span class="o">.</span><span class="n">BLOCKSIZE</span><span class="p">)</span>
            <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">hasher</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
                <span class="n">buf</span> <span class="o">=</span> <span class="n">fp</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">BukuCrypt</span><span class="o">.</span><span class="n">BLOCKSIZE</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">hasher</span><span class="o">.</span><span class="n">digest</span><span class="p">()</span></div>

<div class="viewcode-block" id="BukuCrypt.encrypt_file"><a class="viewcode-back" href="../source/buku.html#buku.BukuCrypt.encrypt_file">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">encrypt_file</span><span class="p">(</span><span class="n">iterations</span><span class="p">,</span> <span class="n">dbfile</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Encrypt the bookmarks database file</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        iterations : int</span>
<span class="sd">            Number of iterations for key generation</span>
<span class="sd">        dbfile : str, optional</span>
<span class="sd">            Custom database file path (including filename)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">cryptography.hazmat.backends</span> <span class="k">import</span> <span class="n">default_backend</span>
            <span class="kn">from</span> <span class="nn">cryptography.hazmat.primitives.ciphers</span> <span class="k">import</span> <span class="p">(</span><span class="n">Cipher</span><span class="p">,</span> <span class="n">modes</span><span class="p">,</span> <span class="n">algorithms</span><span class="p">)</span>
            <span class="kn">from</span> <span class="nn">getpass</span> <span class="k">import</span> <span class="n">getpass</span>
            <span class="kn">from</span> <span class="nn">hashlib</span> <span class="k">import</span> <span class="n">sha256</span>
            <span class="kn">import</span> <span class="nn">struct</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="n">logerr</span><span class="p">(</span><span class="s1">&#39;cryptography lib(s) missing&#39;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">iterations</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">logerr</span><span class="p">(</span><span class="s1">&#39;Iterations must be &gt;= 1&#39;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">dbfile</span><span class="p">:</span>
            <span class="n">dbfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">BukuDb</span><span class="o">.</span><span class="n">get_default_dbdir</span><span class="p">(),</span> <span class="s1">&#39;bookmarks.db&#39;</span><span class="p">)</span>
        <span class="n">encfile</span> <span class="o">=</span> <span class="n">dbfile</span> <span class="o">+</span> <span class="s1">&#39;.enc&#39;</span>

        <span class="n">db_exists</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dbfile</span><span class="p">)</span>
        <span class="n">enc_exists</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">encfile</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">db_exists</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">enc_exists</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">db_exists</span><span class="p">:</span>
            <span class="n">logerr</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> missing. Already encrypted?&#39;</span><span class="p">,</span> <span class="n">dbfile</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># db_exists and enc_exists</span>
            <span class="n">logerr</span><span class="p">(</span><span class="s1">&#39;Both encrypted and flat DB files exist!&#39;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">password</span> <span class="o">=</span> <span class="n">getpass</span><span class="p">()</span>
        <span class="n">passconfirm</span> <span class="o">=</span> <span class="n">getpass</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">password</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">passconfirm</span><span class="p">:</span>
            <span class="n">logerr</span><span class="p">(</span><span class="s1">&#39;Empty password&#39;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">password</span> <span class="o">!=</span> <span class="n">passconfirm</span><span class="p">:</span>
            <span class="n">logerr</span><span class="p">(</span><span class="s1">&#39;Passwords do not match&#39;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Get SHA256 hash of DB file</span>
            <span class="n">dbhash</span> <span class="o">=</span> <span class="n">BukuCrypt</span><span class="o">.</span><span class="n">get_filehash</span><span class="p">(</span><span class="n">dbfile</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logerr</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Generate random 256-bit salt and key</span>
        <span class="n">salt</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">urandom</span><span class="p">(</span><span class="n">BukuCrypt</span><span class="o">.</span><span class="n">SALT_SIZE</span><span class="p">)</span>
        <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;</span><span class="si">%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">password</span><span class="p">,</span> <span class="n">salt</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="s1">&#39;replace&#39;</span><span class="p">)))</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">iterations</span><span class="p">):</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">sha256</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">digest</span><span class="p">()</span>

        <span class="n">iv</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">urandom</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
        <span class="n">encryptor</span> <span class="o">=</span> <span class="n">Cipher</span><span class="p">(</span>
            <span class="n">algorithms</span><span class="o">.</span><span class="n">AES</span><span class="p">(</span><span class="n">key</span><span class="p">),</span>
            <span class="n">modes</span><span class="o">.</span><span class="n">CBC</span><span class="p">(</span><span class="n">iv</span><span class="p">),</span>
            <span class="n">backend</span><span class="o">=</span><span class="n">default_backend</span><span class="p">()</span>
        <span class="p">)</span><span class="o">.</span><span class="n">encryptor</span><span class="p">()</span>
        <span class="n">filesize</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">dbfile</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">dbfile</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">infp</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="n">encfile</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outfp</span><span class="p">:</span>
                <span class="n">outfp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">&#39;&lt;Q&#39;</span><span class="p">,</span> <span class="n">filesize</span><span class="p">))</span>
                <span class="n">outfp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">salt</span><span class="p">)</span>
                <span class="n">outfp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">iv</span><span class="p">)</span>

                <span class="c1"># Embed DB file hash in encrypted file</span>
                <span class="n">outfp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">dbhash</span><span class="p">)</span>

                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">chunk</span> <span class="o">=</span> <span class="n">infp</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">BukuCrypt</span><span class="o">.</span><span class="n">CHUNKSIZE</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">break</span>
                    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span> <span class="o">%</span> <span class="mi">16</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">chunk</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">chunk</span><span class="p">,</span> <span class="s1">&#39; &#39;</span> <span class="o">*</span> <span class="p">(</span><span class="mi">16</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span> <span class="o">%</span> <span class="mi">16</span><span class="p">))</span>

                    <span class="n">outfp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">encryptor</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span> <span class="o">+</span> <span class="n">encryptor</span><span class="o">.</span><span class="n">finalize</span><span class="p">())</span>

            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">dbfile</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;File encrypted&#39;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logerr</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span></div>

<div class="viewcode-block" id="BukuCrypt.decrypt_file"><a class="viewcode-back" href="../source/buku.html#buku.BukuCrypt.decrypt_file">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">decrypt_file</span><span class="p">(</span><span class="n">iterations</span><span class="p">,</span> <span class="n">dbfile</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Decrypt the bookmarks database file</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        iterations : int</span>
<span class="sd">            Number of iterations for key generation</span>
<span class="sd">        dbfile : str, optional</span>
<span class="sd">            Custom database file path (including filename)</span>
<span class="sd">            The &#39;.enc&#39; suffix must be omitted.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">cryptography.hazmat.backends</span> <span class="k">import</span> <span class="n">default_backend</span>
            <span class="kn">from</span> <span class="nn">cryptography.hazmat.primitives.ciphers</span> <span class="k">import</span> <span class="p">(</span><span class="n">Cipher</span><span class="p">,</span> <span class="n">modes</span><span class="p">,</span> <span class="n">algorithms</span><span class="p">)</span>
            <span class="kn">from</span> <span class="nn">getpass</span> <span class="k">import</span> <span class="n">getpass</span>
            <span class="kn">from</span> <span class="nn">hashlib</span> <span class="k">import</span> <span class="n">sha256</span>
            <span class="kn">import</span> <span class="nn">struct</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="n">logerr</span><span class="p">(</span><span class="s1">&#39;cryptography lib(s) missing&#39;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">iterations</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">logerr</span><span class="p">(</span><span class="s1">&#39;Decryption failed&#39;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">dbfile</span><span class="p">:</span>
            <span class="n">dbfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">BukuDb</span><span class="o">.</span><span class="n">get_default_dbdir</span><span class="p">(),</span> <span class="s1">&#39;bookmarks.db&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dbfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">dbfile</span><span class="p">)</span>
            <span class="n">dbpath</span><span class="p">,</span> <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">dbfile</span><span class="p">)</span>

        <span class="n">encfile</span> <span class="o">=</span> <span class="n">dbfile</span> <span class="o">+</span> <span class="s1">&#39;.enc&#39;</span>

        <span class="n">enc_exists</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">encfile</span><span class="p">)</span>
        <span class="n">db_exists</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dbfile</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">enc_exists</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">db_exists</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">enc_exists</span><span class="p">:</span>
            <span class="n">logerr</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> missing&#39;</span><span class="p">,</span> <span class="n">encfile</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># db_exists and enc_exists</span>
            <span class="n">logerr</span><span class="p">(</span><span class="s1">&#39;Both encrypted and flat DB files exist!&#39;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">password</span> <span class="o">=</span> <span class="n">getpass</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">password</span><span class="p">:</span>
            <span class="n">logerr</span><span class="p">(</span><span class="s1">&#39;Decryption failed&#39;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">encfile</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">infp</span><span class="p">:</span>
                <span class="n">size</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;&lt;Q&#39;</span><span class="p">,</span> <span class="n">infp</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="s1">&#39;Q&#39;</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span>

                <span class="c1"># Read 256-bit salt and generate key</span>
                <span class="n">salt</span> <span class="o">=</span> <span class="n">infp</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>
                <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;</span><span class="si">%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">password</span><span class="p">,</span> <span class="n">salt</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="s1">&#39;replace&#39;</span><span class="p">)))</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">iterations</span><span class="p">):</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="n">sha256</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">digest</span><span class="p">()</span>

                <span class="n">iv</span> <span class="o">=</span> <span class="n">infp</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
                <span class="n">decryptor</span> <span class="o">=</span> <span class="n">Cipher</span><span class="p">(</span>
                    <span class="n">algorithms</span><span class="o">.</span><span class="n">AES</span><span class="p">(</span><span class="n">key</span><span class="p">),</span>
                    <span class="n">modes</span><span class="o">.</span><span class="n">CBC</span><span class="p">(</span><span class="n">iv</span><span class="p">),</span>
                    <span class="n">backend</span><span class="o">=</span><span class="n">default_backend</span><span class="p">(),</span>
                <span class="p">)</span><span class="o">.</span><span class="n">decryptor</span><span class="p">()</span>

                <span class="c1"># Get original DB file&#39;s SHA256 hash from encrypted file</span>
                <span class="n">enchash</span> <span class="o">=</span> <span class="n">infp</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>

                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">dbfile</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outfp</span><span class="p">:</span>
                    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="n">chunk</span> <span class="o">=</span> <span class="n">infp</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">BukuCrypt</span><span class="o">.</span><span class="n">CHUNKSIZE</span><span class="p">)</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="k">break</span>

                        <span class="n">outfp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">decryptor</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span> <span class="o">+</span> <span class="n">decryptor</span><span class="o">.</span><span class="n">finalize</span><span class="p">())</span>

                    <span class="n">outfp</span><span class="o">.</span><span class="n">truncate</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>

            <span class="c1"># Match hash of generated file with that of original DB file</span>
            <span class="n">dbhash</span> <span class="o">=</span> <span class="n">BukuCrypt</span><span class="o">.</span><span class="n">get_filehash</span><span class="p">(</span><span class="n">dbfile</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dbhash</span> <span class="o">!=</span> <span class="n">enchash</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">dbfile</span><span class="p">)</span>
                <span class="n">logerr</span><span class="p">(</span><span class="s1">&#39;Decryption failed&#39;</span><span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">encfile</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;File decrypted&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">struct</span><span class="o">.</span><span class="n">error</span><span class="p">:</span>
            <span class="n">logerr</span><span class="p">(</span><span class="s1">&#39;Tainted file&#39;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logerr</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="import_md"><a class="viewcode-back" href="../source/buku.html#buku.import_md">[docs]</a><span class="k">def</span> <span class="nf">import_md</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">newtag</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Parse bookmark markdown file</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filepath : str</span>
<span class="sd">        Path to markdown file</span>
<span class="sd">    newtag : str</span>
<span class="sd">        New tag for bookmarks in markdown file</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple</span>
<span class="sd">        Parsed result</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">infp</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">infp</span><span class="p">:</span>
            <span class="c1"># Supported markdown format: [title](url)</span>
            <span class="c1"># Find position of title end, url start delimiter combo</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;](&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">index</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="c1"># Find title start delimiter</span>
                <span class="n">title_start_delim</span> <span class="o">=</span> <span class="n">line</span><span class="p">[:</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">)</span>
                <span class="c1"># Reverse find the url end delimiter</span>
                <span class="n">url_end_delim</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="n">index</span> <span class="o">+</span> <span class="mi">2</span><span class="p">:]</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s1">&#39;)&#39;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">title_start_delim</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">url_end_delim</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># Parse title</span>
                    <span class="n">title</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="n">title_start_delim</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span><span class="n">index</span><span class="p">]</span>
                    <span class="c1"># Parse url</span>
                    <span class="n">url</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="n">index</span> <span class="o">+</span> <span class="mi">2</span><span class="p">:</span><span class="n">index</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">url_end_delim</span><span class="p">]</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">is_nongeneric_url</span><span class="p">(</span><span class="n">url</span><span class="p">)):</span>
                        <span class="k">continue</span>

                    <span class="k">yield</span> <span class="p">(</span>
                        <span class="n">url</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">delim_wrap</span><span class="p">(</span><span class="n">newtag</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">newtag</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">True</span>
                    <span class="p">)</span></div>


<div class="viewcode-block" id="import_html"><a class="viewcode-back" href="../source/buku.html#buku.import_html">[docs]</a><span class="k">def</span> <span class="nf">import_html</span><span class="p">(</span><span class="n">html_soup</span><span class="p">,</span> <span class="n">add_parent_folder_as_tag</span><span class="p">,</span> <span class="n">newtag</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Parse bookmark html</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    html_soup : BeautifulSoup object</span>
<span class="sd">        BeautifulSoup representation of bookmark html</span>
<span class="sd">    add_parent_folder_as_tag : bool</span>
<span class="sd">        True if bookmark parent folders should be added as tags else False</span>
<span class="sd">    newtag : str</span>
<span class="sd">        A new unique tag to add to imported bookmarks</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple</span>
<span class="sd">        Parsed result</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># compatibility</span>
    <span class="n">soup</span> <span class="o">=</span> <span class="n">html_soup</span>

    <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">soup</span><span class="o">.</span><span class="n">findAll</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">):</span>
        <span class="c1"># Extract comment from &lt;dd&gt; tag</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">is_nongeneric_url</span><span class="p">(</span><span class="n">tag</span><span class="p">[</span><span class="s1">&#39;href&#39;</span><span class="p">])):</span>
                <span class="k">continue</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">desc</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">comment_tag</span> <span class="o">=</span> <span class="n">tag</span><span class="o">.</span><span class="n">findNextSibling</span><span class="p">(</span><span class="s1">&#39;dd&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">comment_tag</span><span class="p">:</span>
            <span class="n">desc</span> <span class="o">=</span> <span class="n">comment_tag</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># add parent folder as tag</span>
        <span class="k">if</span> <span class="n">add_parent_folder_as_tag</span><span class="p">:</span>
            <span class="c1"># could be its folder or not</span>
            <span class="n">possible_folder</span> <span class="o">=</span> <span class="n">tag</span><span class="o">.</span><span class="n">find_previous</span><span class="p">(</span><span class="s1">&#39;h3&#39;</span><span class="p">)</span>
            <span class="c1"># get list of tags within that folder</span>
            <span class="n">tag_list</span> <span class="o">=</span> <span class="n">tag</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">find_parent</span><span class="p">(</span><span class="s1">&#39;dl&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="p">((</span><span class="n">possible_folder</span><span class="p">)</span> <span class="ow">and</span> <span class="n">possible_folder</span><span class="o">.</span><span class="n">parent</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">tag_list</span><span class="o">.</span><span class="n">parents</span><span class="p">)):</span>
                <span class="c1"># then it&#39;s the folder of this bookmark</span>
                <span class="k">if</span> <span class="n">tag</span><span class="o">.</span><span class="n">has_attr</span><span class="p">(</span><span class="s1">&#39;tags&#39;</span><span class="p">):</span>
                    <span class="n">tag</span><span class="p">[</span><span class="s1">&#39;tags&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">DELIM</span> <span class="o">+</span> <span class="n">possible_folder</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">tag</span><span class="p">[</span><span class="s1">&#39;tags&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">possible_folder</span><span class="o">.</span><span class="n">text</span>

        <span class="c1"># add unique tag if opted</span>
        <span class="k">if</span> <span class="n">newtag</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">tag</span><span class="o">.</span><span class="n">has_attr</span><span class="p">(</span><span class="s1">&#39;tags&#39;</span><span class="p">):</span>
                <span class="n">tag</span><span class="p">[</span><span class="s1">&#39;tags&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">DELIM</span> <span class="o">+</span> <span class="n">newtag</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tag</span><span class="p">[</span><span class="s1">&#39;tags&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">newtag</span>

        <span class="k">yield</span> <span class="p">(</span>
            <span class="n">tag</span><span class="p">[</span><span class="s1">&#39;href&#39;</span><span class="p">],</span> <span class="n">tag</span><span class="o">.</span><span class="n">string</span><span class="p">,</span> <span class="n">parse_tags</span><span class="p">([</span><span class="n">tag</span><span class="p">[</span><span class="s1">&#39;tags&#39;</span><span class="p">]])</span>
            <span class="k">if</span> <span class="n">tag</span><span class="o">.</span><span class="n">has_attr</span><span class="p">(</span><span class="s1">&#39;tags&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span> <span class="n">desc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">True</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="BukuDb"><a class="viewcode-back" href="../source/buku.html#buku.BukuDb">[docs]</a><span class="k">class</span> <span class="nc">BukuDb</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Abstracts all database operations</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    conn : sqlite database connection</span>
<span class="sd">    cur : sqlite database cursor</span>
<span class="sd">    json : bool</span>
<span class="sd">        True if results should be printed in json format else False</span>
<span class="sd">    field_filter : int</span>
<span class="sd">        Indicates format for displaying bookmarks. Default is 0.</span>
<span class="sd">    chatty : bool</span>
<span class="sd">        Sets the verbosity of the APIs. Default is False.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">field_filter</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">chatty</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dbfile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">colorize</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Database initialization API</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        json : bool, optional</span>
<span class="sd">            True if results should be printed in json format else False</span>
<span class="sd">        field_filter : int, optional</span>
<span class="sd">            Indicates format for displaying bookmarks. Default is 0.</span>
<span class="sd">        chatty : bool, optional</span>
<span class="sd">            Sets the verbosity of the APIs. Default is False.</span>
<span class="sd">        colorize : bool, optional</span>
<span class="sd">            Indicates whether color should be used in output. Default is True.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur</span> <span class="o">=</span> <span class="n">BukuDb</span><span class="o">.</span><span class="n">initdb</span><span class="p">(</span><span class="n">dbfile</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">json</span> <span class="o">=</span> <span class="n">json</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">field_filter</span> <span class="o">=</span> <span class="n">field_filter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chatty</span> <span class="o">=</span> <span class="n">chatty</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">colorize</span> <span class="o">=</span> <span class="n">colorize</span>

<div class="viewcode-block" id="BukuDb.get_default_dbdir"><a class="viewcode-back" href="../source/buku.html#buku.BukuDb.get_default_dbdir">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_default_dbdir</span><span class="p">():</span>
        <span class="sd">&quot;&quot;&quot;Determine the directory path where dbfile will be stored</span>

<span class="sd">        If the platform is Windows, use %APPDATA%</span>
<span class="sd">        else if $XDG_DATA_HOME is defined, use it</span>
<span class="sd">        else if $HOME exists, use it</span>
<span class="sd">        else use the current directory</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str</span>
<span class="sd">            Path to database file</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">data_home</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;XDG_DATA_HOME&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">data_home</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;HOME&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s1">&#39;win32&#39;</span><span class="p">:</span>
                    <span class="n">data_home</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;APPDATA&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">data_home</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">data_home</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;HOME&#39;</span><span class="p">),</span> <span class="s1">&#39;.local&#39;</span><span class="p">,</span> <span class="s1">&#39;share&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_home</span><span class="p">,</span> <span class="s1">&#39;buku&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="BukuDb.initdb"><a class="viewcode-back" href="../source/buku.html#buku.BukuDb.initdb">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">initdb</span><span class="p">(</span><span class="n">dbfile</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize the database connection.</span>

<span class="sd">        Create DB file and/or bookmarks table if they don&#39;t exist.</span>
<span class="sd">        Alert on encryption options on first execution.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        dbfile : str, optional</span>
<span class="sd">            Custom database file path (including filename)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        tuple</span>
<span class="sd">            (connection, cursor)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">dbfile</span><span class="p">:</span>
            <span class="n">dbpath</span> <span class="o">=</span> <span class="n">BukuDb</span><span class="o">.</span><span class="n">get_default_dbdir</span><span class="p">()</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;bookmarks.db&#39;</span>
            <span class="n">dbfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dbpath</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dbfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">dbfile</span><span class="p">)</span>
            <span class="n">dbpath</span><span class="p">,</span> <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">dbfile</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dbpath</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dbpath</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logerr</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">_exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">db_exists</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dbfile</span><span class="p">)</span>
        <span class="n">enc_exists</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dbfile</span> <span class="o">+</span> <span class="s1">&#39;.enc&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">db_exists</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">enc_exists</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">elif</span> <span class="n">enc_exists</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">db_exists</span><span class="p">:</span>
            <span class="n">logerr</span><span class="p">(</span><span class="s1">&#39;Unlock database first&#39;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">db_exists</span> <span class="ow">and</span> <span class="n">enc_exists</span><span class="p">:</span>
            <span class="n">logerr</span><span class="p">(</span><span class="s1">&#39;Both encrypted and flat DB files exist!&#39;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># not db_exists and not enc_exists</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;DB file is being created at </span><span class="si">%s</span><span class="s1">.</span><span class="se">\n</span><span class="s1">You should encrypt it.&#39;</span> <span class="o">%</span> <span class="n">dbfile</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Create a connection</span>
            <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">dbfile</span><span class="p">,</span> <span class="n">check_same_thread</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">create_function</span><span class="p">(</span><span class="s1">&#39;REGEXP&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">regexp</span><span class="p">)</span>
            <span class="n">cur</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

            <span class="c1"># Create table if it doesn&#39;t exist</span>
            <span class="c1"># flags: designed to be extended in future using bitwise masks</span>
            <span class="c1"># Masks:</span>
            <span class="c1">#     0b00000001: set title immutable</span>
            <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;CREATE TABLE if not exists bookmarks (&#39;</span>
                        <span class="s1">&#39;id integer PRIMARY KEY, &#39;</span>
                        <span class="s1">&#39;URL text NOT NULL UNIQUE, &#39;</span>
                        <span class="s1">&#39;metadata text default </span><span class="se">\&#39;\&#39;</span><span class="s1">, &#39;</span>
                        <span class="s1">&#39;tags text default </span><span class="se">\&#39;</span><span class="s1">,</span><span class="se">\&#39;</span><span class="s1">, &#39;</span>
                        <span class="s1">&#39;desc text default </span><span class="se">\&#39;\&#39;</span><span class="s1">, &#39;</span>
                        <span class="s1">&#39;flags integer default 0)&#39;</span><span class="p">)</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logerr</span><span class="p">(</span><span class="s1">&#39;initdb(): </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">cur</span><span class="p">)</span></div>

<div class="viewcode-block" id="BukuDb.get_rec_all"><a class="viewcode-back" href="../source/buku.html#buku.BukuDb.get_rec_all">[docs]</a>    <span class="k">def</span> <span class="nf">get_rec_all</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get all the bookmarks in the database</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list</span>
<span class="sd">            A list of tuples representing bookmark records</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;SELECT * FROM bookmarks&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span></div>

<div class="viewcode-block" id="BukuDb.get_rec_by_id"><a class="viewcode-back" href="../source/buku.html#buku.BukuDb.get_rec_by_id">[docs]</a>    <span class="k">def</span> <span class="nf">get_rec_by_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get a bookmark from database by its ID.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        index : int</span>
<span class="sd">            DB index of bookmark record</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        tuple or None</span>
<span class="sd">            Bookmark data, or None if index is not found</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;SELECT * FROM bookmarks WHERE id = ? LIMIT 1&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">index</span><span class="p">,))</span>
        <span class="n">resultset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">resultset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">resultset</span> <span class="k">else</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="BukuDb.get_rec_id"><a class="viewcode-back" href="../source/buku.html#buku.BukuDb.get_rec_id">[docs]</a>    <span class="k">def</span> <span class="nf">get_rec_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check if URL already exists in DB</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        url : str</span>
<span class="sd">            A URL to search for in the DB</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        int</span>
<span class="sd">            DB index, or -1 if URL not found in DB</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;SELECT id FROM bookmarks WHERE URL = ? LIMIT 1&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">url</span><span class="p">,))</span>
        <span class="n">resultset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">resultset</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">resultset</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span></div>

<div class="viewcode-block" id="BukuDb.get_max_id"><a class="viewcode-back" href="../source/buku.html#buku.BukuDb.get_max_id">[docs]</a>    <span class="k">def</span> <span class="nf">get_max_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Fetch the ID of the last record</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        int</span>
<span class="sd">            ID of the record if any record exists, else -1</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;SELECT MAX(id) from bookmarks&#39;</span><span class="p">)</span>
        <span class="n">resultset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="n">resultset</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">resultset</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span></div>

<div class="viewcode-block" id="BukuDb.add_rec"><a class="viewcode-back" href="../source/buku.html#buku.BukuDb.add_rec">[docs]</a>    <span class="k">def</span> <span class="nf">add_rec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">title_in</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tags_in</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">immutable</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">delay_commit</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a new bookmark</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        url : str</span>
<span class="sd">            URL to bookmark</span>
<span class="sd">        title_in :str, optional</span>
<span class="sd">            Title to add manually. Default is None.</span>
<span class="sd">        tags_in : str, optional</span>
<span class="sd">            Comma-separated tags to add manually.</span>
<span class="sd">            Must start and end with comma. Default is None.</span>
<span class="sd">        desc : str, optional</span>
<span class="sd">            Description of the bookmark. Default is None.</span>
<span class="sd">        immutable : int, optional</span>
<span class="sd">            Indicates whether to disable title fetch from web.</span>
<span class="sd">            Default is 0.</span>
<span class="sd">        delay_commit : bool, optional</span>
<span class="sd">            True if record should not be committed to the DB,</span>
<span class="sd">            leaving commit responsibility to caller. Default is False.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        int</span>
<span class="sd">            DB index of new bookmark on success, -1 on failure</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Return error for empty URL</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">url</span> <span class="ow">or</span> <span class="n">url</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">logerr</span><span class="p">(</span><span class="s1">&#39;Invalid URL&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>

        <span class="c1"># Ensure that the URL does not exist in DB already</span>
        <span class="nb">id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_rec_id</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">id</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">logerr</span><span class="p">(</span><span class="s1">&#39;URL [</span><span class="si">%s</span><span class="s1">] already exists at index </span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>

        <span class="c1"># Process title</span>
        <span class="k">if</span> <span class="n">title_in</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">meta</span> <span class="o">=</span> <span class="n">title_in</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">meta</span><span class="p">,</span> <span class="n">mime</span><span class="p">,</span> <span class="n">bad</span> <span class="o">=</span> <span class="n">network_handler</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">bad</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Malformed URL</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">mime</span><span class="p">:</span>
                <span class="n">logdbg</span><span class="p">(</span><span class="s1">&#39;HTTP HEAD requested&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">meta</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No title</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logdbg</span><span class="p">(</span><span class="s1">&#39;Title: [</span><span class="si">%s</span><span class="s1">]&#39;</span><span class="p">,</span> <span class="n">meta</span><span class="p">)</span>

        <span class="c1"># Fix up tags, if broken</span>
        <span class="k">if</span> <span class="n">tags_in</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">tags_in</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">tags_in</span> <span class="o">=</span> <span class="n">DELIM</span>
        <span class="k">elif</span> <span class="n">tags_in</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">DELIM</span><span class="p">:</span>
            <span class="n">tags_in</span> <span class="o">=</span> <span class="n">DELIM</span> <span class="o">+</span> <span class="n">tags_in</span>
        <span class="k">elif</span> <span class="n">tags_in</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">DELIM</span><span class="p">:</span>
            <span class="n">tags_in</span> <span class="o">=</span> <span class="n">tags_in</span> <span class="o">+</span> <span class="n">DELIM</span>

        <span class="c1"># Process description</span>
        <span class="k">if</span> <span class="n">desc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">desc</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">flagset</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">immutable</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">flagset</span> <span class="o">|=</span> <span class="n">immutable</span>

            <span class="n">qry</span> <span class="o">=</span> <span class="s1">&#39;INSERT INTO bookmarks(URL, metadata, tags, desc, flags) VALUES (?, ?, ?, ?, ?)&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">qry</span><span class="p">,</span> <span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">meta</span><span class="p">,</span> <span class="n">tags_in</span><span class="p">,</span> <span class="n">desc</span><span class="p">,</span> <span class="n">flagset</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">delay_commit</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">chatty</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">print_rec</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">lastrowid</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">lastrowid</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logerr</span><span class="p">(</span><span class="s1">&#39;add_rec(): </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span></div>

<div class="viewcode-block" id="BukuDb.append_tag_at_index"><a class="viewcode-back" href="../source/buku.html#buku.BukuDb.append_tag_at_index">[docs]</a>    <span class="k">def</span> <span class="nf">append_tag_at_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">tags_in</span><span class="p">,</span> <span class="n">delay_commit</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Append tags to bookmark tagset at index</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        index : int</span>
<span class="sd">            DB index of the record. 0 indicates all records.</span>
<span class="sd">        tags_in : str</span>
<span class="sd">            Comma-separated tags to add manually</span>
<span class="sd">        delay_commit : bool, optional</span>
<span class="sd">            True if record should not be committed to the DB,</span>
<span class="sd">            leaving commit responsibility to caller. Default is False.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">            True on success, False on failuree</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="n">read_in</span><span class="p">(</span><span class="s1">&#39;Append the tags to ALL bookmarks? (y/n): &#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">resp</span> <span class="o">!=</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;SELECT id, tags FROM bookmarks ORDER BY id ASC&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;SELECT id, tags FROM bookmarks WHERE id = ? LIMIT 1&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">index</span><span class="p">,))</span>

        <span class="n">resultset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">resultset</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;UPDATE bookmarks SET tags = ? WHERE id = ?&#39;</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">resultset</span><span class="p">:</span>
                <span class="n">tags</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">tags_in</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                <span class="n">tags</span> <span class="o">=</span> <span class="n">parse_tags</span><span class="p">([</span><span class="n">tags</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">tags</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],))</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">chatty</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">delay_commit</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">print_rec</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">delay_commit</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="BukuDb.delete_tag_at_index"><a class="viewcode-back" href="../source/buku.html#buku.BukuDb.delete_tag_at_index">[docs]</a>    <span class="k">def</span> <span class="nf">delete_tag_at_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">tags_in</span><span class="p">,</span> <span class="n">delay_commit</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Delete tags from bookmark tagset at index</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        index : int</span>
<span class="sd">            DB index of bookmark record. 0 indicates all records.</span>
<span class="sd">        tags_in : str</span>
<span class="sd">            Comma-separated tags to delete manually</span>
<span class="sd">        delay_commit : bool, optional</span>
<span class="sd">            True if record should not be committed to the DB,</span>
<span class="sd">            leaving commit responsibility to caller. Default is False.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">            True on success, False on failure</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">tags_to_delete</span> <span class="o">=</span> <span class="n">tags_in</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="n">DELIM</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">DELIM</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="n">read_in</span><span class="p">(</span><span class="s1">&#39;Delete the tag(s) from ALL bookmarks? (y/n): &#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">resp</span> <span class="o">!=</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>

            <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">match</span> <span class="o">=</span> <span class="s2">&quot;&#39;%&#39; || ? || &#39;%&#39;&quot;</span>
            <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">tags_to_delete</span><span class="p">:</span>
                <span class="n">tag</span> <span class="o">=</span> <span class="n">delim_wrap</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
                <span class="n">q</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;UPDATE bookmarks SET tags = replace(tags, &#39;</span><span class="si">%s</span><span class="s2">&#39;, &#39;</span><span class="si">%s</span><span class="s2">&#39;) WHERE tags LIKE </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">DELIM</span><span class="p">,</span> <span class="n">match</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="p">(</span><span class="n">tag</span><span class="p">,))</span>
                <span class="n">count</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">rowcount</span>

            <span class="k">if</span> <span class="n">count</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">delay_commit</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">chatty</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1"> record(s) updated&#39;</span> <span class="o">%</span> <span class="n">count</span><span class="p">)</span>

            <span class="k">return</span> <span class="kc">True</span>

        <span class="c1"># Process a single index</span>
        <span class="c1"># Use SELECT and UPDATE to handle multiple tags at once</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;SELECT id, tags FROM bookmarks WHERE id = ? LIMIT 1&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">index</span><span class="p">,))</span>
        <span class="n">resultset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">resultset</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;UPDATE bookmarks SET tags = ? WHERE id = ?&#39;</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">resultset</span><span class="p">:</span>
                <span class="n">tags</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

                <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">tags_to_delete</span><span class="p">:</span>
                    <span class="n">tags</span> <span class="o">=</span> <span class="n">tags</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">delim_wrap</span><span class="p">(</span><span class="n">tag</span><span class="p">),</span> <span class="n">DELIM</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">parse_tags</span><span class="p">([</span><span class="n">tags</span><span class="p">]),</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],))</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">chatty</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">delay_commit</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">print_rec</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">delay_commit</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="BukuDb.update_rec"><a class="viewcode-back" href="../source/buku.html#buku.BukuDb.update_rec">[docs]</a>    <span class="k">def</span> <span class="nf">update_rec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">title_in</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tags_in</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">immutable</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">threads</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update an existing record at index</span>

<span class="sd">        Update all records if index is 0 and url is not specified.</span>
<span class="sd">        URL is an exception because URLs are unique in DB.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        index : int</span>
<span class="sd">            DB index of record. 0 indicates all records.</span>
<span class="sd">        url : str, optional</span>
<span class="sd">            Bookmark address</span>
<span class="sd">        title_in : str, optional</span>
<span class="sd">            Title to add manually.</span>
<span class="sd">        tags_in : str, optional</span>
<span class="sd">            Comma-separated tags to add manually. Must start and end with comma.</span>
<span class="sd">            Prefix with &#39;+,&#39; to append to current tags.</span>
<span class="sd">            Prefix with &#39;-,&#39; to delete from current tags</span>
<span class="sd">        desc : str, optional</span>
<span class="sd">            Description of bookmark</span>
<span class="sd">        immutable : int, optional</span>
<span class="sd">            Diable title fetch from web if 1. Default is -1.</span>
<span class="sd">        threads : int, optional</span>
<span class="sd">            Number of threads to use to refresh full DB. Default is 4.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">            True on success, False on Failure</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">arguments</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;UPDATE bookmarks SET&#39;</span>
        <span class="n">to_update</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">tag_modified</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Update URL if passed as argument</span>
        <span class="k">if</span> <span class="n">url</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">url</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">logerr</span><span class="p">(</span><span class="s1">&#39;All URLs cannot be same&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="n">query</span> <span class="o">+=</span> <span class="s1">&#39; URL = ?,&#39;</span>
            <span class="n">arguments</span> <span class="o">+=</span> <span class="p">(</span><span class="n">url</span><span class="p">,)</span>
            <span class="n">to_update</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># Update tags if passed as argument</span>
        <span class="k">if</span> <span class="n">tags_in</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">tags_in</span> <span class="o">==</span> <span class="s1">&#39;+,&#39;</span> <span class="ow">or</span> <span class="n">tags_in</span> <span class="o">==</span> <span class="s1">&#39;-,&#39;</span><span class="p">:</span>
                <span class="n">logerr</span><span class="p">(</span><span class="s1">&#39;Please specify a tag&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>

            <span class="k">if</span> <span class="n">tags_in</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;+,&#39;</span><span class="p">):</span>
                <span class="n">chatty</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chatty</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">chatty</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">append_tag_at_index</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">tags_in</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">chatty</span> <span class="o">=</span> <span class="n">chatty</span>
                <span class="n">tag_modified</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">elif</span> <span class="n">tags_in</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;-,&#39;</span><span class="p">):</span>
                <span class="n">chatty</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chatty</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">chatty</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">delete_tag_at_index</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">tags_in</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">chatty</span> <span class="o">=</span> <span class="n">chatty</span>
                <span class="n">tag_modified</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Fix up tags, if broken</span>
                <span class="k">if</span> <span class="n">tags_in</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">tags_in</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                    <span class="n">tags_in</span> <span class="o">=</span> <span class="n">DELIM</span>
                <span class="k">elif</span> <span class="n">tags_in</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">DELIM</span><span class="p">:</span>
                    <span class="n">tags_in</span> <span class="o">=</span> <span class="n">DELIM</span> <span class="o">+</span> <span class="n">tags_in</span>
                <span class="k">elif</span> <span class="n">tags_in</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">DELIM</span><span class="p">:</span>
                    <span class="n">tags_in</span> <span class="o">=</span> <span class="n">tags_in</span> <span class="o">+</span> <span class="n">DELIM</span>

                <span class="n">query</span> <span class="o">+=</span> <span class="s1">&#39; tags = ?,&#39;</span>
                <span class="n">arguments</span> <span class="o">+=</span> <span class="p">(</span><span class="n">tags_in</span><span class="p">,)</span>
                <span class="n">to_update</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># Update description if passed as an argument</span>
        <span class="k">if</span> <span class="n">desc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">+=</span> <span class="s1">&#39; desc = ?,&#39;</span>
            <span class="n">arguments</span> <span class="o">+=</span> <span class="p">(</span><span class="n">desc</span><span class="p">,)</span>
            <span class="n">to_update</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># Update immutable flag if passed as argument</span>
        <span class="k">if</span> <span class="n">immutable</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">flagset</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">immutable</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">query</span> <span class="o">+=</span> <span class="s1">&#39; flags = flags | ?,&#39;</span>
            <span class="k">elif</span> <span class="n">immutable</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">query</span> <span class="o">+=</span> <span class="s1">&#39; flags = flags &amp; ?,&#39;</span>
                <span class="n">flagset</span> <span class="o">=</span> <span class="o">~</span><span class="n">flagset</span>

            <span class="n">arguments</span> <span class="o">+=</span> <span class="p">(</span><span class="n">flagset</span><span class="p">,)</span>
            <span class="n">to_update</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># Update title</span>
        <span class="c1">#</span>
        <span class="c1"># 1. if --title has no arguments, delete existing title</span>
        <span class="c1"># 2. if --title has arguments, update existing title</span>
        <span class="c1"># 3. if --title option is omitted at cmdline:</span>
        <span class="c1">#    if URL is passed, update the title from web using the URL</span>
        <span class="c1"># 4. if no other argument (url, tag, comment, immutable) passed,</span>
        <span class="c1">#    update title from web using DB URL (if title is mutable)</span>
        <span class="n">title_to_insert</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">title_in</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">title_to_insert</span> <span class="o">=</span> <span class="n">title_in</span>
        <span class="k">elif</span> <span class="n">url</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">url</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">title_to_insert</span><span class="p">,</span> <span class="n">mime</span><span class="p">,</span> <span class="n">bad</span> <span class="o">=</span> <span class="n">network_handler</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">bad</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Malformed URL</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">mime</span><span class="p">:</span>
                <span class="n">logdbg</span><span class="p">(</span><span class="s1">&#39;HTTP HEAD requested&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">title_to_insert</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No title</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logdbg</span><span class="p">(</span><span class="s1">&#39;Title: [</span><span class="si">%s</span><span class="s1">]&#39;</span><span class="p">,</span> <span class="n">title_to_insert</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">to_update</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">tag_modified</span><span class="p">:</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">refreshdb</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">threads</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ret</span> <span class="ow">and</span> <span class="n">index</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">chatty</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">print_rec</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ret</span>

        <span class="k">if</span> <span class="n">title_to_insert</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">+=</span> <span class="s1">&#39; metadata = ?,&#39;</span>
            <span class="n">arguments</span> <span class="o">+=</span> <span class="p">(</span><span class="n">title_to_insert</span><span class="p">,)</span>
            <span class="n">to_update</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">to_update</span><span class="p">:</span>  <span class="c1"># Nothing to update</span>
            <span class="c1"># Show bookmark if tags were appended to deleted</span>
            <span class="k">if</span> <span class="n">tag_modified</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">chatty</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">print_rec</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ret</span>

        <span class="k">if</span> <span class="n">index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Update all records</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="n">read_in</span><span class="p">(</span><span class="s1">&#39;Update ALL bookmarks? (y/n): &#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">resp</span> <span class="o">!=</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>

            <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; WHERE id = ?&#39;</span>
            <span class="n">arguments</span> <span class="o">+=</span> <span class="p">(</span><span class="n">index</span><span class="p">,)</span>

        <span class="n">logdbg</span><span class="p">(</span><span class="s1">&#39;query: &quot;</span><span class="si">%s</span><span class="s1">&quot;, args: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">arguments</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">arguments</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">rowcount</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">chatty</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">print_rec</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">rowcount</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">logerr</span><span class="p">(</span><span class="s1">&#39;No matching index </span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">IntegrityError</span><span class="p">:</span>
            <span class="n">logerr</span><span class="p">(</span><span class="s1">&#39;URL already exists&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="BukuDb.refreshdb"><a class="viewcode-back" href="../source/buku.html#buku.BukuDb.refreshdb">[docs]</a>    <span class="k">def</span> <span class="nf">refreshdb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">threads</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Refresh ALL records in the database.</span>

<span class="sd">        Fetch title for eachbookmark from the web and update the records.</span>
<span class="sd">        Doesn&#39;t update the record if title is empty.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">            This API doesn&#39;t change DB index, URL or tags of a bookmark.</span>
<span class="sd">            This API is verbose.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        index : int</span>
<span class="sd">            DB index of record to update. 0 indicates all records.</span>
<span class="sd">        threads: int</span>
<span class="sd">            Number of threads to use to refresh full DB. Default is 4.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;SELECT id, url, flags FROM bookmarks ORDER BY id ASC&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;SELECT id, url, flags FROM bookmarks WHERE id = ? LIMIT 1&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">index</span><span class="p">,))</span>

        <span class="n">resultset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="n">recs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">resultset</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">recs</span><span class="p">:</span>
            <span class="n">logerr</span><span class="p">(</span><span class="s1">&#39;No matching index or title immutable or empty DB&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Set up strings to be printed</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">colorize</span><span class="p">:</span>
            <span class="n">bad_url_str</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\x1b</span><span class="s1">[1mIndex </span><span class="si">%d</span><span class="s1">: Malformed URL</span><span class="se">\x1b</span><span class="s1">[0m</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="n">mime_str</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\x1b</span><span class="s1">[1mIndex </span><span class="si">%d</span><span class="s1">: HTTP HEAD requested</span><span class="se">\x1b</span><span class="s1">[0m</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="n">blank_URL_str</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\x1b</span><span class="s1">[1mIndex </span><span class="si">%d</span><span class="s1">: No title</span><span class="se">\x1b</span><span class="s1">[0m</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="n">success_str</span> <span class="o">=</span> <span class="s1">&#39;Title: [</span><span class="si">%s</span><span class="s1">]</span><span class="se">\n\x1b</span><span class="s1">[92mIndex </span><span class="si">%d</span><span class="s1">: updated</span><span class="se">\x1b</span><span class="s1">[0m</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">bad_url_str</span> <span class="o">=</span> <span class="s1">&#39;Index </span><span class="si">%d</span><span class="s1">: Malformed URL</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="n">mime_str</span> <span class="o">=</span> <span class="s1">&#39;Index </span><span class="si">%d</span><span class="s1">: HTTP HEAD requested</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="n">blank_URL_str</span> <span class="o">=</span> <span class="s1">&#39;Index </span><span class="si">%d</span><span class="s1">: No title</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="n">success_str</span> <span class="o">=</span> <span class="s1">&#39;Title: [</span><span class="si">%s</span><span class="s1">]</span><span class="se">\n</span><span class="s1">Index </span><span class="si">%d</span><span class="s1">: updated</span><span class="se">\n</span><span class="s1">&#39;</span>

        <span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;UPDATE bookmarks SET metadata = ? WHERE id = ?&#39;</span>
        <span class="n">done</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>  <span class="c1"># count threads completed</span>
        <span class="n">processed</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>  <span class="c1"># count number of records processed</span>

        <span class="c1"># An additional call to generate default headers</span>
        <span class="c1"># gen_headers() is called within network_handler()</span>
        <span class="c1"># However, this initial call to setup headers</span>
        <span class="c1"># ensures there is no race condition among the</span>
        <span class="c1"># initial threads to setup headers</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">myheaders</span><span class="p">:</span>
            <span class="n">gen_headers</span><span class="p">()</span>

        <span class="n">cond</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Condition</span><span class="p">()</span>
        <span class="n">cond</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">refresh</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="n">cond</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Inner function to fetch titles and update records</span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            count : int</span>
<span class="sd">                Dummy input to adhere to convention.</span>
<span class="sd">            cond : threading condition object</span>
<span class="sd">            &quot;&quot;&quot;</span>

            <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">cond</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">resultset</span><span class="p">:</span>
                    <span class="n">row</span> <span class="o">=</span> <span class="n">resultset</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">cond</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
                    <span class="k">break</span>
                <span class="n">cond</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

                <span class="n">title</span><span class="p">,</span> <span class="n">mime</span><span class="p">,</span> <span class="n">bad</span> <span class="o">=</span> <span class="n">network_handler</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="n">cond</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">bad</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">bad_url_str</span> <span class="o">%</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">cond</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
                    <span class="k">continue</span>
                <span class="k">elif</span> <span class="n">mime</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">chatty</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="n">mime_str</span> <span class="o">%</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">cond</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
                    <span class="k">continue</span>
                <span class="k">elif</span> <span class="n">title</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">blank_URL_str</span> <span class="o">%</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">cond</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
                    <span class="k">continue</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],))</span>
                <span class="c1"># Save after fetching 32 titles per thread</span>
                <span class="k">if</span> <span class="n">count</span> <span class="o">&amp;</span> <span class="mb">0b11111</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">chatty</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">success_str</span> <span class="o">%</span> <span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                <span class="n">cond</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

                <span class="k">if</span> <span class="n">interrupted</span><span class="p">:</span>
                    <span class="k">break</span>

            <span class="n">logdbg</span><span class="p">(</span><span class="s1">&#39;Thread </span><span class="si">%d</span><span class="s1">: processed </span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">threading</span><span class="o">.</span><span class="n">get_ident</span><span class="p">(),</span> <span class="n">count</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">cond</span><span class="p">:</span>
                <span class="n">done</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">processed</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">count</span>
                <span class="n">cond</span><span class="o">.</span><span class="n">notify</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">recs</span> <span class="o">&lt;</span> <span class="n">threads</span><span class="p">:</span>
            <span class="n">threads</span> <span class="o">=</span> <span class="n">recs</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">threads</span><span class="p">):</span>
            <span class="n">thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">refresh</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">cond</span><span class="p">))</span>
            <span class="n">thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

        <span class="k">while</span> <span class="n">done</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">threads</span><span class="p">:</span>
            <span class="n">cond</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
            <span class="n">logdbg</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1"> threads completed&#39;</span><span class="p">,</span> <span class="n">done</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">])</span>

        <span class="c1"># Guard: records found == total records processed</span>
        <span class="k">if</span> <span class="n">recs</span> <span class="o">!=</span> <span class="n">processed</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]:</span>
            <span class="n">logerr</span><span class="p">(</span><span class="s1">&#39;Records: </span><span class="si">%d</span><span class="s1">, processed: </span><span class="si">%d</span><span class="s1"> !!!&#39;</span><span class="p">,</span> <span class="n">recs</span><span class="p">,</span> <span class="n">processed</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">])</span>

        <span class="n">cond</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="BukuDb.edit_update_rec"><a class="viewcode-back" href="../source/buku.html#buku.BukuDb.edit_update_rec">[docs]</a>    <span class="k">def</span> <span class="nf">edit_update_rec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">immutable</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Edit in editor and update a record</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        index : int</span>
<span class="sd">            DB index of the record</span>
<span class="sd">        immutable : int, optional</span>
<span class="sd">            Diable title fetch from web if 1. Default is -1.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">            True if updated, else False</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">editor</span> <span class="o">=</span> <span class="n">get_system_editor</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">editor</span> <span class="o">==</span> <span class="s1">&#39;none&#39;</span><span class="p">:</span>
            <span class="n">logerr</span><span class="p">(</span><span class="s1">&#39;EDITOR must be set to use index with -w&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="n">rec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_rec_by_id</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">rec</span><span class="p">:</span>
            <span class="n">logerr</span><span class="p">(</span><span class="s1">&#39;No matching index </span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">edit_rec</span><span class="p">(</span><span class="n">editor</span><span class="p">,</span> <span class="n">rec</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">rec</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">rec</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">rec</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">url</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">tags</span><span class="p">,</span> <span class="n">desc</span> <span class="o">=</span> <span class="n">result</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_rec</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">tags</span><span class="p">,</span> <span class="n">desc</span><span class="p">,</span> <span class="n">immutable</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">immutable</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_rec</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">immutable</span><span class="p">)</span>

        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="BukuDb.searchdb"><a class="viewcode-back" href="../source/buku.html#buku.BukuDb.searchdb">[docs]</a>    <span class="k">def</span> <span class="nf">searchdb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keywords</span><span class="p">,</span> <span class="n">all_keywords</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">deep</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Search DB for entries where tags, URL, or title fields match keywords</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        keywords : list of str</span>
<span class="sd">            Keywords to search</span>
<span class="sd">        all_keywords : bool, optional</span>
<span class="sd">            True to return records matching ALL keywords.</span>
<span class="sd">            False (default value) to return records matching ANY keyword.</span>
<span class="sd">        deep : bool, optional</span>
<span class="sd">            True to search for matching substrings. Default is False.</span>
<span class="sd">        regex : bool, optional</span>
<span class="sd">            Match a regular expression if True. Default is False.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list or None</span>
<span class="sd">            List of search results, or None if no matches</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">keywords</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">q0</span> <span class="o">=</span> <span class="s1">&#39;SELECT id, url, metadata, tags, desc FROM bookmarks WHERE &#39;</span>
        <span class="c1"># Deep query string</span>
        <span class="n">q1</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;(tags LIKE (&#39;%&#39; || ? || &#39;%&#39;) OR &quot;</span>
              <span class="s2">&quot;URL LIKE (&#39;%&#39; || ? || &#39;%&#39;) OR &quot;</span>
              <span class="s2">&quot;metadata LIKE (&#39;%&#39; || ? || &#39;%&#39;) OR &quot;</span>
              <span class="s2">&quot;desc LIKE (&#39;%&#39; || ? || &#39;%&#39;)) &quot;</span><span class="p">)</span>
        <span class="c1"># Non-deep query string</span>
        <span class="n">q2</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;(tags REGEXP ? OR &#39;</span>
              <span class="s1">&#39;URL REGEXP ? OR &#39;</span>
              <span class="s1">&#39;metadata REGEXP ? OR &#39;</span>
              <span class="s1">&#39;desc REGEXP ?) &#39;</span><span class="p">)</span>
        <span class="n">qargs</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">regex</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">keywords</span><span class="p">:</span>
                <span class="n">q0</span> <span class="o">+=</span> <span class="n">q2</span> <span class="o">+</span> <span class="s1">&#39;OR &#39;</span>
                <span class="n">qargs</span> <span class="o">+=</span> <span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">token</span><span class="p">,)</span>
            <span class="n">q0</span> <span class="o">=</span> <span class="n">q0</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">all_keywords</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">keywords</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">keywords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;blank&#39;</span><span class="p">:</span>
                <span class="n">q0</span> <span class="o">=</span> <span class="s2">&quot;SELECT * FROM bookmarks WHERE metadata = &#39;&#39; OR tags = ? &quot;</span>
                <span class="n">qargs</span> <span class="o">+=</span> <span class="p">(</span><span class="n">DELIM</span><span class="p">,)</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">keywords</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">keywords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;immutable&#39;</span><span class="p">:</span>
                <span class="n">q0</span> <span class="o">=</span> <span class="s1">&#39;SELECT * FROM bookmarks WHERE flags &amp; 1 == 1 &#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">keywords</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">deep</span><span class="p">:</span>
                        <span class="n">q0</span> <span class="o">+=</span> <span class="n">q1</span> <span class="o">+</span> <span class="s1">&#39;AND &#39;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">token</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">b&#39;</span> <span class="o">+</span> <span class="n">token</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">b&#39;</span>
                        <span class="n">q0</span> <span class="o">+=</span> <span class="n">q2</span> <span class="o">+</span> <span class="s1">&#39;AND &#39;</span>

                    <span class="n">qargs</span> <span class="o">+=</span> <span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">token</span><span class="p">,)</span>
                <span class="n">q0</span> <span class="o">=</span> <span class="n">q0</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">all_keywords</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">keywords</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">deep</span><span class="p">:</span>
                    <span class="n">q0</span> <span class="o">+=</span> <span class="n">q1</span> <span class="o">+</span> <span class="s1">&#39;OR &#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">token</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">b&#39;</span> <span class="o">+</span> <span class="n">token</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">b&#39;</span>
                    <span class="n">q0</span> <span class="o">+=</span> <span class="n">q2</span> <span class="o">+</span> <span class="s1">&#39;OR &#39;</span>

                <span class="n">qargs</span> <span class="o">+=</span> <span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">token</span><span class="p">,)</span>
            <span class="n">q0</span> <span class="o">=</span> <span class="n">q0</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logerr</span><span class="p">(</span><span class="s1">&#39;Invalid search option&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">q0</span> <span class="o">+=</span> <span class="s1">&#39;ORDER BY id ASC&#39;</span>
        <span class="n">logdbg</span><span class="p">(</span><span class="s1">&#39;query: &quot;</span><span class="si">%s</span><span class="s1">&quot;, args: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">q0</span><span class="p">,</span> <span class="n">qargs</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">q0</span><span class="p">,</span> <span class="n">qargs</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">OperationalError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logerr</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span></div>

<div class="viewcode-block" id="BukuDb.search_by_tag"><a class="viewcode-back" href="../source/buku.html#buku.BukuDb.search_by_tag">[docs]</a>    <span class="k">def</span> <span class="nf">search_by_tag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tags</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Search bookmarks for entries with given tags</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        tags : str</span>
<span class="sd">            String of tags to search for.</span>
<span class="sd">            Retrieves entries matching ANY tag if tags are</span>
<span class="sd">            delimited with &#39;,&#39;.</span>
<span class="sd">            Retrieves entries matching ALL tags if tags are</span>
<span class="sd">            delimited with &#39;+&#39;.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list or None</span>
<span class="sd">            List of search results, or None if no matches</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># do not allow combination of search logics</span>
        <span class="k">if</span> <span class="s1">&#39; + &#39;</span> <span class="ow">in</span> <span class="n">tags</span> <span class="ow">and</span> <span class="s1">&#39;,&#39;</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">:</span>
            <span class="n">logerr</span><span class="p">(</span><span class="s2">&quot;Cannot use both &#39;+&#39; and &#39;,&#39; in same search&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">tags</span><span class="p">,</span> <span class="n">search_operator</span><span class="p">,</span> <span class="n">excluded_tags</span> <span class="o">=</span> <span class="n">prep_tag_search</span><span class="p">(</span><span class="n">tags</span><span class="p">)</span>

        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;SELECT id, url, metadata, tags, desc FROM bookmarks WHERE tags LIKE &#39;%&#39; || ? || &#39;%&#39; &quot;</span>
        <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="n">query</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> tags LIKE &#39;%&#39; || ? || &#39;%&#39; &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">search_operator</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">excluded_tags</span><span class="p">:</span>
            <span class="n">tags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">excluded_tags</span><span class="p">)</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;WHERE tags&#39;</span><span class="p">,</span> <span class="s1">&#39;WHERE (tags&#39;</span><span class="p">)</span>
            <span class="n">query</span> <span class="o">+=</span> <span class="s1">&#39;) AND tags NOT REGEXP ? &#39;</span>
        <span class="n">query</span> <span class="o">+=</span> <span class="s1">&#39;ORDER BY id ASC&#39;</span>

        <span class="n">logdbg</span><span class="p">(</span><span class="s1">&#39;query: &quot;</span><span class="si">%s</span><span class="s1">&quot;, args: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">tags</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">tags</span><span class="p">,</span> <span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span></div>

<div class="viewcode-block" id="BukuDb.compactdb"><a class="viewcode-back" href="../source/buku.html#buku.BukuDb.compactdb">[docs]</a>    <span class="k">def</span> <span class="nf">compactdb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">delay_commit</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;When an entry at index is deleted, move the</span>
<span class="sd">        last entry in DB to index, if index is lesser.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        index : int</span>
<span class="sd">            DB index of deleted entry</span>
<span class="sd">        delay_commit : bool, optional</span>
<span class="sd">            True if record should not be committed to the DB,</span>
<span class="sd">            leaving commit responsibility to caller. Default is False.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Return if the last index left in DB was just deleted</span>
        <span class="n">max_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_max_id</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">max_id</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">query1</span> <span class="o">=</span> <span class="s1">&#39;SELECT id, URL, metadata, tags, desc FROM bookmarks WHERE id = ? LIMIT 1&#39;</span>
        <span class="n">query2</span> <span class="o">=</span> <span class="s1">&#39;DELETE FROM bookmarks WHERE id = ?&#39;</span>
        <span class="n">query3</span> <span class="o">=</span> <span class="s1">&#39;INSERT INTO bookmarks(id, URL, metadata, tags, desc) VALUES (?, ?, ?, ?, ?)&#39;</span>

        <span class="k">if</span> <span class="n">max_id</span> <span class="o">&gt;</span> <span class="n">index</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query1</span><span class="p">,</span> <span class="p">(</span><span class="n">max_id</span><span class="p">,))</span>
            <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query2</span><span class="p">,</span> <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query3</span><span class="p">,</span> <span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="mi">4</span><span class="p">],))</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">delay_commit</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">chatty</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Index </span><span class="si">%d</span><span class="s1"> moved to </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">index</span><span class="p">))</span></div>

<div class="viewcode-block" id="BukuDb.delete_rec"><a class="viewcode-back" href="../source/buku.html#buku.BukuDb.delete_rec">[docs]</a>    <span class="k">def</span> <span class="nf">delete_rec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">low</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">is_range</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">delay_commit</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Delete a single record or remove the table if index is None</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        index : int</span>
<span class="sd">            DB index of deleted entry.</span>
<span class="sd">        low : int, optional</span>
<span class="sd">            Actual lower index of range.</span>
<span class="sd">        high : int, optional</span>
<span class="sd">            Actual higher index of range.</span>
<span class="sd">        is_range : bool, optional</span>
<span class="sd">            A range is passed using low and high arguments.</span>
<span class="sd">            An index is ignored if is_range is True (use dummy index).</span>
<span class="sd">            Default is False.</span>
<span class="sd">        delay_commit : bool, optional</span>
<span class="sd">            True if record should not be committed to the DB,</span>
<span class="sd">            leaving commit responsibility to caller. Default is False.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">            True on success, False on failure.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">is_range</span><span class="p">:</span>  <span class="c1"># Delete a range of indices</span>
            <span class="k">if</span> <span class="n">low</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">high</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">logerr</span><span class="p">(</span><span class="s1">&#39;Negative range boundary&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>

            <span class="k">if</span> <span class="n">low</span> <span class="o">&gt;</span> <span class="n">high</span><span class="p">:</span>
                <span class="n">low</span><span class="p">,</span> <span class="n">high</span> <span class="o">=</span> <span class="n">high</span><span class="p">,</span> <span class="n">low</span>

            <span class="c1"># If range starts from 0, delete all records</span>
            <span class="k">if</span> <span class="n">low</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cleardb</span><span class="p">()</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;DELETE from bookmarks where id BETWEEN ? AND ?&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Index </span><span class="si">%d</span><span class="s1">-</span><span class="si">%d</span><span class="s1">: </span><span class="si">%d</span><span class="s1"> deleted&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">rowcount</span><span class="p">))</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">rowcount</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">False</span>

                <span class="c1"># Compact DB by ascending order of index to ensure</span>
                <span class="c1"># the existing higher indices move only once</span>
                <span class="c1"># Delayed commit is forced</span>
                <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">low</span><span class="p">,</span> <span class="n">high</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">compactdb</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">delay_commit</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">delay_commit</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="n">logerr</span><span class="p">(</span><span class="s1">&#39;No matching index&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="n">index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Remove the table</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cleardb</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># Remove a single entry</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;DELETE FROM bookmarks WHERE id = ?&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">index</span><span class="p">,))</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">rowcount</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Index </span><span class="si">%d</span><span class="s1"> deleted&#39;</span> <span class="o">%</span> <span class="n">index</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">compactdb</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">delay_commit</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">delay_commit</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logerr</span><span class="p">(</span><span class="s1">&#39;No matching index </span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">False</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="n">logerr</span><span class="p">(</span><span class="s1">&#39;No matching index </span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="BukuDb.delete_resultset"><a class="viewcode-back" href="../source/buku.html#buku.BukuDb.delete_resultset">[docs]</a>    <span class="k">def</span> <span class="nf">delete_resultset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">results</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Delete search results in descending order of DB index.</span>

<span class="sd">        Indices are expected to be unique and in ascending order.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">            This API forces a delayed commit.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        results : list of tuples</span>
<span class="sd">            List of results to delete from DB.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">            True on success, False on failure</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="n">read_in</span><span class="p">(</span><span class="s1">&#39;Delete the search results? (y/n): &#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">resp</span> <span class="o">!=</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># delete records in reverse order</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">while</span> <span class="n">pos</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="n">pos</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">delete_rec</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">delay_commit</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># Commit at every 200th removal</span>
            <span class="k">if</span> <span class="n">pos</span> <span class="o">%</span> <span class="mi">200</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

            <span class="n">pos</span> <span class="o">-=</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="BukuDb.delete_rec_all"><a class="viewcode-back" href="../source/buku.html#buku.BukuDb.delete_rec_all">[docs]</a>    <span class="k">def</span> <span class="nf">delete_rec_all</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">delay_commit</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Removes all records in the Bookmarks table</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        delay_commit : bool, optional</span>
<span class="sd">            True if record should not be committed to the DB,</span>
<span class="sd">            leaving commit responsibility to caller. Default is False.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">            True on success, False on failure</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;DELETE FROM bookmarks&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">delay_commit</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logerr</span><span class="p">(</span><span class="s1">&#39;delete_rec_all(): </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="BukuDb.cleardb"><a class="viewcode-back" href="../source/buku.html#buku.BukuDb.cleardb">[docs]</a>    <span class="k">def</span> <span class="nf">cleardb</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Drops the bookmark table if it exists</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">            True on success, False on failure</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">resp</span> <span class="o">=</span> <span class="n">read_in</span><span class="p">(</span><span class="s1">&#39;Remove ALL bookmarks? (y/n): &#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">resp</span> <span class="o">!=</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No bookmarks deleted&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;DROP TABLE if exists bookmarks&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;All bookmarks deleted&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="BukuDb.print_rec"><a class="viewcode-back" href="../source/buku.html#buku.BukuDb.print_rec">[docs]</a>    <span class="k">def</span> <span class="nf">print_rec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">low</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">is_range</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Print bookmark details at index or all bookmarks if index is 0</span>

<span class="sd">        A negative index behaves like tail, if title is blank show &quot;Untitled&quot;</span>

<span class="sd">        Parameters</span>
<span class="sd">        -----------</span>
<span class="sd">        index : int, optional</span>
<span class="sd">            DB index of record to print. 0 prints all records.</span>
<span class="sd">        low : int, optional</span>
<span class="sd">            Actual lower index of range.</span>
<span class="sd">        high : int, optional</span>
<span class="sd">            Actual higher index of range.</span>
<span class="sd">        is_range : bool, optional</span>
<span class="sd">            A range is passed using low and high arguments.</span>
<span class="sd">            An index is ignored if is_range is True (use dummy index).</span>
<span class="sd">            Default is False.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="c1"># Show the last n records</span>
            <span class="n">_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_max_id</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">_id</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">logerr</span><span class="p">(</span><span class="s1">&#39;Empty database&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>

            <span class="n">low</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="n">_id</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="n">index</span> <span class="k">else</span> <span class="n">_id</span> <span class="o">+</span> <span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">high</span> <span class="o">=</span> <span class="n">_id</span>
            <span class="n">is_range</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">is_range</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">low</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">high</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">logerr</span><span class="p">(</span><span class="s1">&#39;Negative range boundary&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>

            <span class="k">if</span> <span class="n">low</span> <span class="o">&gt;</span> <span class="n">high</span><span class="p">:</span>
                <span class="n">low</span><span class="p">,</span> <span class="n">high</span> <span class="o">=</span> <span class="n">high</span><span class="p">,</span> <span class="n">low</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># If range starts from 0 print all records</span>
                <span class="k">if</span> <span class="n">low</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;SELECT * from bookmarks&#39;</span>
                    <span class="n">resultset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;SELECT * from bookmarks where id BETWEEN ? AND ?&#39;</span>
                    <span class="n">resultset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="n">logerr</span><span class="p">(</span><span class="s1">&#39;Index out of range&#39;</span><span class="p">)</span>
                <span class="k">return</span>
        <span class="k">elif</span> <span class="n">index</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Show record at index</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;SELECT * FROM bookmarks WHERE id = ? LIMIT 1&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">index</span><span class="p">,))</span>
                <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">results</span><span class="p">:</span>
                    <span class="n">logerr</span><span class="p">(</span><span class="s1">&#39;No matching index </span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
                    <span class="k">return</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="n">logerr</span><span class="p">(</span><span class="s1">&#39;No matching index </span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">field_filter</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">print_single_rec</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">field_filter</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="se">\t</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">field_filter</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="se">\t</span><span class="si">%s</span><span class="se">\t</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
                    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">field_filter</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="se">\t</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
                    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">field_filter</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="se">\t</span><span class="si">%s</span><span class="se">\t</span><span class="si">%s</span><span class="se">\t</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">format_json</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">field_filter</span><span class="p">))</span>

            <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># Show all entries</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;SELECT * FROM bookmarks&#39;</span><span class="p">)</span>
            <span class="n">resultset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">resultset</span><span class="p">:</span>
            <span class="n">logerr</span><span class="p">(</span><span class="s1">&#39;0 records&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">field_filter</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">resultset</span><span class="p">:</span>
                    <span class="n">print_single_rec</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">field_filter</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">resultset</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="se">\t</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">field_filter</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">resultset</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="se">\t</span><span class="si">%s</span><span class="se">\t</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">field_filter</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">resultset</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="se">\t</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">field_filter</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">resultset</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="se">\t</span><span class="si">%s</span><span class="se">\t</span><span class="si">%s</span><span class="se">\t</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">format_json</span><span class="p">(</span><span class="n">resultset</span><span class="p">,</span> <span class="n">field_filter</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">field_filter</span><span class="p">))</span></div>

<div class="viewcode-block" id="BukuDb.get_tag_all"><a class="viewcode-back" href="../source/buku.html#buku.BukuDb.get_tag_all">[docs]</a>    <span class="k">def</span> <span class="nf">get_tag_all</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get list of tags in DB</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        tuple</span>
<span class="sd">            (list of unique tags sorted alphabetically,</span>
<span class="sd">             dictionary of {tag: usage_count})</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">tags</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">unique_tags</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">dic</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">qry</span> <span class="o">=</span> <span class="s1">&#39;SELECT DISTINCT tags, COUNT(tags) FROM bookmarks GROUP BY tags&#39;</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">qry</span><span class="p">):</span>
            <span class="n">tagset</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="n">DELIM</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">DELIM</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">tagset</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">tag</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">:</span>
                    <span class="n">dic</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">tags</span> <span class="o">+=</span> <span class="p">(</span><span class="n">tag</span><span class="p">,)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">dic</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span> <span class="o">+=</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">tags</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">tags</span><span class="p">,</span> <span class="n">dic</span>

        <span class="k">if</span> <span class="n">tags</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">unique_tags</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">tags</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">unique_tags</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">tags</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">unique_tags</span><span class="p">,</span> <span class="n">dic</span></div>

<div class="viewcode-block" id="BukuDb.suggest_similar_tag"><a class="viewcode-back" href="../source/buku.html#buku.BukuDb.suggest_similar_tag">[docs]</a>    <span class="k">def</span> <span class="nf">suggest_similar_tag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tagstr</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Show list of tags those go together in DB</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        tagstr : str</span>
<span class="sd">            Original tag string.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str</span>
<span class="sd">            DELIM separated string of tags</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">tags</span> <span class="o">=</span> <span class="n">tagstr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">tags</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">tagstr</span>

        <span class="n">qry</span> <span class="o">=</span> <span class="s1">&#39;SELECT DISTINCT tags FROM bookmarks WHERE tags LIKE ?&#39;</span>
        <span class="n">tagset</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">unique_tags</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">qry</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;%&#39;</span> <span class="o">+</span> <span class="n">delim_wrap</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;%&#39;</span><span class="p">,))</span>
            <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">results</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
                    <span class="n">tagset</span> <span class="o">+=</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="n">DELIM</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">DELIM</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tagset</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">tagset</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">tag</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tags</span> <span class="ow">and</span> <span class="n">tag</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">unique_tags</span><span class="p">:</span>
                    <span class="n">unique_tags</span> <span class="o">+=</span> <span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_tags</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">tagstr</span>

        <span class="n">unique_tags</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">unique_tags</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;similar tags:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">unique_tags</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">. </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">unique_tags</span><span class="p">[</span><span class="n">count</span><span class="p">]))</span>
            <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">resp</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">select: &#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">resp</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">tagstr</span>

        <span class="n">tagset</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="n">tags</span> <span class="o">=</span> <span class="p">[</span><span class="n">tagstr</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">tagset</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">tags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">delim_wrap</span><span class="p">(</span><span class="n">unique_tags</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]))</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">continue</span>

        <span class="k">return</span> <span class="n">parse_tags</span><span class="p">(</span><span class="n">tags</span><span class="p">)</span></div>

<div class="viewcode-block" id="BukuDb.replace_tag"><a class="viewcode-back" href="../source/buku.html#buku.BukuDb.replace_tag">[docs]</a>    <span class="k">def</span> <span class="nf">replace_tag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">orig</span><span class="p">,</span> <span class="n">new</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Replace original tag by new tags in all records.</span>

<span class="sd">        Remove original tag if new tag is empty.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        orig : str</span>
<span class="sd">            Original tag.</span>
<span class="sd">        new : list</span>
<span class="sd">            Replacement tags.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">            True on success, False on failure.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">newtags</span> <span class="o">=</span> <span class="n">DELIM</span>

        <span class="n">orig</span> <span class="o">=</span> <span class="n">delim_wrap</span><span class="p">(</span><span class="n">orig</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">new</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">newtags</span> <span class="o">=</span> <span class="n">parse_tags</span><span class="p">(</span><span class="n">new</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">orig</span> <span class="o">==</span> <span class="n">newtags</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Tags are same.&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Remove original tag from DB if new tagset reduces to delimiter</span>
        <span class="k">if</span> <span class="n">newtags</span> <span class="o">==</span> <span class="n">DELIM</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">delete_tag_at_index</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">orig</span><span class="p">)</span>

        <span class="c1"># Update bookmarks with original tag</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;SELECT id, tags FROM bookmarks WHERE tags LIKE ?&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;%&#39;</span> <span class="o">+</span> <span class="n">orig</span> <span class="o">+</span> <span class="s1">&#39;%&#39;</span><span class="p">,))</span>
        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">results</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;UPDATE bookmarks SET tags = ? WHERE id = ?&#39;</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
                <span class="n">tags</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span> <span class="n">newtags</span><span class="p">)</span>
                <span class="n">tags</span> <span class="o">=</span> <span class="n">parse_tags</span><span class="p">([</span><span class="n">tags</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">tags</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Index </span><span class="si">%d</span><span class="s1"> updated&#39;</span> <span class="o">%</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="BukuDb.set_tag"><a class="viewcode-back" href="../source/buku.html#buku.BukuDb.set_tag">[docs]</a>    <span class="k">def</span> <span class="nf">set_tag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmdstr</span><span class="p">,</span> <span class="n">taglist</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Append, overwrite, remove tags using the symbols &gt;&gt;, &gt; and &lt;&lt; respectively.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        cmdstr : str</span>
<span class="sd">            Command pattern.</span>
<span class="sd">        taglist : list</span>
<span class="sd">            List of tags.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        int</span>
<span class="sd">            Number of indices updated on success, -1 on failure.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">cmdstr</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">taglist</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>

        <span class="n">flag</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># 0: invalid, 1: append, 2: overwrite, 3: remove</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">cmdstr</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;&gt;&gt;&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">index</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">cmdstr</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;&gt;&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">index</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">flag</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">index</span> <span class="o">=</span> <span class="n">cmdstr</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;&lt;&lt;&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">index</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">flag</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">flag</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">flag</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>

        <span class="n">tags</span> <span class="o">=</span> <span class="n">DELIM</span>
        <span class="n">id_list</span> <span class="o">=</span> <span class="n">cmdstr</span><span class="p">[:</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">id_list</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">is_int</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">int</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">tags</span> <span class="o">+=</span> <span class="n">taglist</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">DELIM</span>
                <span class="k">elif</span> <span class="s1">&#39;-&#39;</span> <span class="ow">in</span> <span class="nb">id</span><span class="p">:</span>
                    <span class="n">vals</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">id</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)]</span>
                    <span class="k">if</span> <span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">vals</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                        <span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vals</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                    <span class="k">for</span> <span class="n">_id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vals</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                        <span class="n">tags</span> <span class="o">+=</span> <span class="n">taglist</span><span class="p">[</span><span class="n">_id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">DELIM</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>

        <span class="k">if</span> <span class="n">flag</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">update_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;UPDATE bookmarks SET tags = ? WHERE id = ?&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">db_id_list</span> <span class="o">=</span> <span class="n">cmdstr</span><span class="p">[</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">db_id_list</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">is_int</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">int</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">flag</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">append_tag_at_index</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">tags</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
                            <span class="n">update_count</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">elif</span> <span class="n">flag</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="n">tags</span> <span class="o">=</span> <span class="n">parse_tags</span><span class="p">([</span><span class="n">tags</span><span class="p">])</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">tags</span><span class="p">,</span> <span class="nb">id</span><span class="p">,))</span>
                        <span class="n">update_count</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">rowcount</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">delete_tag_at_index</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">tags</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
                        <span class="n">update_count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">elif</span> <span class="s1">&#39;-&#39;</span> <span class="ow">in</span> <span class="nb">id</span><span class="p">:</span>
                    <span class="n">vals</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">id</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)]</span>
                    <span class="k">if</span> <span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">vals</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                        <span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vals</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                    <span class="k">for</span> <span class="n">_id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vals</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">flag</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">append_tag_at_index</span><span class="p">(</span><span class="n">_id</span><span class="p">,</span> <span class="n">tags</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
                                <span class="n">update_count</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">elif</span> <span class="n">flag</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                            <span class="n">tags</span> <span class="o">=</span> <span class="n">parse_tags</span><span class="p">([</span><span class="n">tags</span><span class="p">])</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">tags</span><span class="p">,</span> <span class="n">_id</span><span class="p">,))</span>
                            <span class="n">update_count</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">rowcount</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">delete_tag_at_index</span><span class="p">(</span><span class="n">_id</span><span class="p">,</span> <span class="n">tags</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
                                <span class="n">update_count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">IntegrityError</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>

        <span class="k">return</span> <span class="n">update_count</span></div>

<div class="viewcode-block" id="BukuDb.browse_by_index"><a class="viewcode-back" href="../source/buku.html#buku.BukuDb.browse_by_index">[docs]</a>    <span class="k">def</span> <span class="nf">browse_by_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">low</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">is_range</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Open URL at index or range of indies in browser</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        index : int</span>
<span class="sd">            Index to browse. 0 opens a random bookmark.</span>
<span class="sd">        low : int</span>
<span class="sd">            Actual lower index of range.</span>
<span class="sd">        high : int</span>
<span class="sd">            Higher index of range.</span>
<span class="sd">        is_range : bool</span>
<span class="sd">            A range is passed using low and high arguments.</span>
<span class="sd">            If True, index is ignored. Default is False.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">            True on success, False on failure.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">is_range</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">low</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">high</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">logerr</span><span class="p">(</span><span class="s1">&#39;Negative range boundary&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>

            <span class="k">if</span> <span class="n">low</span> <span class="o">&gt;</span> <span class="n">high</span><span class="p">:</span>
                <span class="n">low</span><span class="p">,</span> <span class="n">high</span> <span class="o">=</span> <span class="n">high</span><span class="p">,</span> <span class="n">low</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># If range starts from 0 throw an error</span>
                <span class="k">if</span> <span class="n">low</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">IndexError</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">qry</span> <span class="o">=</span> <span class="s1">&#39;SELECT URL from bookmarks where id BETWEEN ? AND ?&#39;</span>
                    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">qry</span><span class="p">,</span> <span class="p">(</span><span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">)):</span>
                        <span class="n">browse</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="k">return</span> <span class="kc">True</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="n">logerr</span><span class="p">(</span><span class="s1">&#39;Index out of range&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logerr</span><span class="p">(</span><span class="s1">&#39;Invalid index </span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">qry</span> <span class="o">=</span> <span class="s1">&#39;SELECT id from bookmarks ORDER BY RANDOM() LIMIT 1&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">qry</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>

            <span class="c1"># Return if no entries in DB</span>
            <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No bookmarks added yet ...&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>

            <span class="n">index</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">logdbg</span><span class="p">(</span><span class="s1">&#39;Opening random index </span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>

        <span class="n">qry</span> <span class="o">=</span> <span class="s1">&#39;SELECT URL FROM bookmarks WHERE id = ? LIMIT 1&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">qry</span><span class="p">,</span> <span class="p">(</span><span class="n">index</span><span class="p">,)):</span>
                <span class="n">browse</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="n">logerr</span><span class="p">(</span><span class="s1">&#39;No matching index </span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="n">logerr</span><span class="p">(</span><span class="s1">&#39;No matching index </span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>

        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="BukuDb.exportdb"><a class="viewcode-back" href="../source/buku.html#buku.BukuDb.exportdb">[docs]</a>    <span class="k">def</span> <span class="nf">exportdb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">,</span> <span class="n">taglist</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Export DB bookmarks to file.</span>

<span class="sd">        If destination file name ends with &#39;.md&#39;, bookmarks are</span>
<span class="sd">        exported to a markdown file. Otherwise, bookmarks are</span>
<span class="sd">        exported to a Firefox bookmarks.html formatted file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filepath : str</span>
<span class="sd">            Path to export destination file.</span>
<span class="sd">        taglist : list, optional</span>
<span class="sd">            Specific tags to export.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">            True on success, False on failure.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">import</span> <span class="nn">time</span>

        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">timestamp</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()))</span>
        <span class="n">arguments</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;SELECT * FROM bookmarks&#39;</span>
        <span class="n">is_tag_valid</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">taglist</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tagstr</span> <span class="o">=</span> <span class="n">parse_tags</span><span class="p">(</span><span class="n">taglist</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">tagstr</span> <span class="ow">or</span> <span class="n">tagstr</span> <span class="o">==</span> <span class="n">DELIM</span><span class="p">:</span>
                <span class="n">logerr</span><span class="p">(</span><span class="s1">&#39;Invalid tag&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>

            <span class="n">tags</span> <span class="o">=</span> <span class="n">tagstr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">DELIM</span><span class="p">)</span>
            <span class="n">query</span> <span class="o">+=</span> <span class="s1">&#39; WHERE&#39;</span>
            <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">tag</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                    <span class="n">is_tag_valid</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">query</span> <span class="o">+=</span> <span class="s2">&quot; tags LIKE &#39;%&#39; || ? || &#39;%&#39; OR&quot;</span>
                    <span class="n">tag</span> <span class="o">=</span> <span class="n">delim_wrap</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
                    <span class="n">arguments</span> <span class="o">+=</span> <span class="p">(</span><span class="n">tag</span><span class="p">,)</span>

            <span class="k">if</span> <span class="n">is_tag_valid</span><span class="p">:</span>
                <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="p">[:</span><span class="o">-</span><span class="mi">6</span><span class="p">]</span>

        <span class="n">logdbg</span><span class="p">(</span><span class="s1">&#39;(</span><span class="si">%s</span><span class="s1">), </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">arguments</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">arguments</span><span class="p">)</span>
        <span class="n">resultset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">resultset</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No bookmarks exported&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filepath</span><span class="p">):</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="n">read_in</span><span class="p">(</span><span class="n">filepath</span> <span class="o">+</span> <span class="s1">&#39; exists. Overwrite? (y/n): &#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">resp</span> <span class="o">!=</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">outfp</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logerr</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">filepath</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.md&#39;</span><span class="p">):</span>
            <span class="n">outfp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;List of buku bookmarks:</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">resultset</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                    <span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;- [Untitled](&#39;</span> <span class="o">+</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;)</span><span class="se">\n</span><span class="s1">&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;- [&#39;</span> <span class="o">+</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;](&#39;</span> <span class="o">+</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;)</span><span class="se">\n</span><span class="s1">&#39;</span>
                <span class="n">outfp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
                <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">outfp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&lt;!DOCTYPE NETSCAPE-Bookmark-file-1&gt;</span><span class="se">\n\n</span><span class="s1">&#39;</span>
                        <span class="s1">&#39;&lt;META HTTP-EQUIV=&quot;Content-Type&quot; CONTENT=&quot;text/html; charset=UTF-8&quot;&gt;</span><span class="se">\n</span><span class="s1">&#39;</span>
                        <span class="s1">&#39;&lt;TITLE&gt;Bookmarks&lt;/TITLE&gt;</span><span class="se">\n</span><span class="s1">&#39;</span>
                        <span class="s1">&#39;&lt;H1&gt;Bookmarks&lt;/H1&gt;</span><span class="se">\n\n</span><span class="s1">&#39;</span>
                        <span class="s1">&#39;&lt;DL&gt;&lt;p&gt;</span><span class="se">\n</span><span class="s1">&#39;</span>
                        <span class="s1">&#39;    &lt;DT&gt;&lt;H3 ADD_DATE=&quot;</span><span class="si">%s</span><span class="s1">&quot; LAST_MODIFIED=&quot;</span><span class="si">%s</span><span class="s1">&quot; PERSONAL_TOOLBAR_FOLDER=&quot;true&quot;&gt;Buku bookmarks&lt;/H3&gt;</span><span class="se">\n</span><span class="s1">&#39;</span>
                        <span class="s1">&#39;    &lt;DL&gt;&lt;p&gt;</span><span class="se">\n</span><span class="s1">&#39;</span>
                        <span class="o">%</span> <span class="p">(</span><span class="n">timestamp</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">))</span>

            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">resultset</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;        &lt;DT&gt;&lt;A HREF=&quot;</span><span class="si">%s</span><span class="s1">&quot; ADD_DATE=&quot;</span><span class="si">%s</span><span class="s1">&quot; LAST_MODIFIED=&quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">timestamp</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="n">DELIM</span><span class="p">:</span>
                    <span class="n">out</span> <span class="o">+=</span> <span class="s1">&#39; TAGS=&quot;&#39;</span> <span class="o">+</span> <span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span>
                <span class="n">out</span> <span class="o">+=</span> <span class="s1">&#39;&gt;&#39;</span> <span class="o">+</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;&lt;/A&gt;</span><span class="se">\n</span><span class="s1">&#39;</span>
                <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                    <span class="n">out</span> <span class="o">+=</span> <span class="s1">&#39;        &lt;DD&gt;&#39;</span> <span class="o">+</span> <span class="n">row</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>

                <span class="n">outfp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
                <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="n">outfp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;    &lt;/DL&gt;&lt;p&gt;</span><span class="se">\n</span><span class="s1">&lt;/DL&gt;&lt;p&gt;&#39;</span><span class="p">)</span>

        <span class="n">outfp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> exported&#39;</span> <span class="o">%</span> <span class="n">count</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="BukuDb.load_chrome_database"><a class="viewcode-back" href="../source/buku.html#buku.BukuDb.load_chrome_database">[docs]</a>    <span class="k">def</span> <span class="nf">load_chrome_database</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Open Chrome Bookmarks json file and import data.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        path : str</span>
<span class="sd">            Path to Google Chrome bookmarks file.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bookmarks : dict</span>
<span class="sd">            Dictionary holding Google Chroom bookmarks data.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">datafile</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">datafile</span><span class="p">)</span>

        <span class="n">other</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;roots&#39;</span><span class="p">][</span><span class="s1">&#39;other&#39;</span><span class="p">]</span>
        <span class="n">bookmark_bar</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;roots&#39;</span><span class="p">][</span><span class="s1">&#39;bookmark_bar&#39;</span><span class="p">]</span>
        <span class="n">bookmarks</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;children&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">bookmark_bar</span><span class="p">,</span> <span class="n">other</span><span class="p">]}</span>

        <span class="k">return</span> <span class="n">bookmarks</span></div>

<div class="viewcode-block" id="BukuDb.load_firefox_database"><a class="viewcode-back" href="../source/buku.html#buku.BukuDb.load_firefox_database">[docs]</a>    <span class="k">def</span> <span class="nf">load_firefox_database</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Connect to Firefox sqlite db and import bookmarks into BukuDb.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        path : str</span>
<span class="sd">            Path to Firefox bookmarks sqlite database.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Connect to input DB</span>
        <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">):</span>
            <span class="c1"># Python 3.4.4 and above</span>
            <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;file:</span><span class="si">%s</span><span class="s1">?mode=ro&#39;</span> <span class="o">%</span> <span class="n">path</span><span class="p">,</span> <span class="n">uri</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

        <span class="n">cur</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;SELECT lastModified, fk FROM moz_bookmarks WHERE type=1 ORDER BY lastModified&#39;</span><span class="p">)</span>
        <span class="c1"># get id&#39;s and remove duplicates</span>
        <span class="n">bookmarks_places_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()])</span>
        <span class="k">for</span> <span class="n">place_id</span> <span class="ow">in</span> <span class="n">bookmarks_places_ids</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;SELECT url FROM moz_places where id=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">place_id</span><span class="p">))</span>
            <span class="n">url</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

            <span class="c1"># get tags</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;SELECT parent FROM moz_bookmarks WHERE fk=</span><span class="si">{}</span><span class="s1"> AND title IS NULL&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">place_id</span><span class="p">))</span>
            <span class="n">bm_tag_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">tid</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span> <span class="k">for</span> <span class="n">tid</span> <span class="ow">in</span> <span class="n">item</span><span class="p">]</span>

            <span class="n">bookmark_tags</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">bm_tag_id</span> <span class="ow">in</span> <span class="n">bm_tag_ids</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;SELECT title FROM moz_bookmarks WHERE id=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bm_tag_id</span><span class="p">))</span>
                <span class="n">bookmark_tags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>

            <span class="c1"># get the url</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;SELECT url FROM moz_places WHERE id=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">place_id</span><span class="p">))</span>
            <span class="n">url</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">is_nongeneric_url</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="c1"># get the title</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;SELECT title FROM moz_bookmarks WHERE fk=</span><span class="si">{}</span><span class="s1"> AND title!=&quot;&quot; LIMIT 1&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">place_id</span><span class="p">))</span>
            <span class="n">title_data</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">title_data</span><span class="p">:</span>
                <span class="n">title</span> <span class="o">=</span> <span class="n">title_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="n">formatted_tags</span> <span class="o">=</span> <span class="p">[</span><span class="n">DELIM</span><span class="o">+</span><span class="n">tag</span> <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">bookmark_tags</span><span class="p">]</span>
            <span class="n">tags</span> <span class="o">=</span> <span class="n">parse_tags</span><span class="p">(</span><span class="n">formatted_tags</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_rec</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">tags</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cur</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error here&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="BukuDb.auto_import_from_browser"><a class="viewcode-back" href="../source/buku.html#buku.BukuDb.auto_import_from_browser">[docs]</a>    <span class="k">def</span> <span class="nf">auto_import_from_browser</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Import bookmarks from a browser default database file.</span>

<span class="sd">        Supports Firefox and Google Chrome.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">            True on success, False on failure.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;linux&#39;</span><span class="p">):</span>
            <span class="n">GC_BM_DB_PATH</span> <span class="o">=</span> <span class="s1">&#39;~/.config/google-chrome/Default/Bookmarks&#39;</span>

            <span class="n">DEFAULT_FF_FOLDER</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s1">&#39;~/.mozilla/firefox&#39;</span><span class="p">)</span>
            <span class="n">profile</span> <span class="o">=</span> <span class="n">get_firefox_profile_name</span><span class="p">(</span><span class="n">DEFAULT_FF_FOLDER</span><span class="p">)</span>
            <span class="n">FF_BM_DB_PATH</span> <span class="o">=</span> <span class="s1">&#39;~/.mozilla/firefox/</span><span class="si">{}</span><span class="s1">.default/places.sqlite&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">profile</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s1">&#39;darwin&#39;</span><span class="p">:</span>
            <span class="n">GC_BM_DB_PATH</span> <span class="o">=</span> <span class="s1">&#39;~/Library/Application Support/Google/Chrome/Default/Bookmarks&#39;</span>

            <span class="n">DEFAULT_FF_FOLDER</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s1">&#39;~/Library/Application Support/Firefox&#39;</span><span class="p">)</span>
            <span class="n">profile</span> <span class="o">=</span> <span class="n">get_firefox_profile_name</span><span class="p">(</span><span class="n">DEFAULT_FF_FOLDER</span><span class="p">)</span>
            <span class="n">FF_BM_DB_PATH</span> <span class="o">=</span> <span class="s1">&#39;~/Library/Application Support/Firefox/</span><span class="si">{}</span><span class="s1">.default/places.sqlite&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">profile</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s1">&#39;win32&#39;</span><span class="p">:</span>
            <span class="n">username</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getlogin</span><span class="p">()</span>
            <span class="n">GC_BM_DB_PATH</span> <span class="o">=</span> <span class="s1">&#39;C:/Users/</span><span class="si">{}</span><span class="s1">/AppData/Local/Google/Chrome/User Data/Default/Bookmarks&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>

            <span class="n">DEFAULT_FF_FOLDER</span> <span class="o">=</span> <span class="s1">&#39;C:/Users/</span><span class="si">{}</span><span class="s1">/AppData/Roaming/Mozilla/Firefox/Profiles&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
            <span class="n">profile</span> <span class="o">=</span> <span class="n">get_firefox_profile_name</span><span class="p">(</span><span class="n">DEFAULT_FF_FOLDER</span><span class="p">)</span>
            <span class="n">FF_BM_DB_PATH</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DEFAULT_FF_FOLDER</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">.default/places.sqlite&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">profile</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logerr</span><span class="p">(</span><span class="s1">&#39;Buku does not support </span><span class="si">{}</span><span class="s1"> yet&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">close_quit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">resp</span> <span class="o">=</span> <span class="s1">&#39;y&#39;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">chatty</span><span class="p">:</span>
                <span class="n">resp</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s1">&#39;Import bookmarks from google chrome? (y/n): &#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">resp</span> <span class="o">==</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span>
                <span class="n">webbrowser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;google-chrome&#39;</span><span class="p">)</span>
                <span class="n">bookmarks_database</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">GC_BM_DB_PATH</span><span class="p">)</span>
                <span class="n">walk</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">load_chrome_database</span><span class="p">(</span><span class="n">bookmarks_database</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">logerr</span><span class="p">(</span><span class="s1">&#39;Could not import from google-chrome&#39;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">chatty</span><span class="p">:</span>
                <span class="n">resp</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s1">&#39;Import bookmarks from firefox? (y/n): &#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">resp</span> <span class="o">==</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span>
                <span class="n">webbrowser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;firefox&#39;</span><span class="p">)</span>
                <span class="n">bookmarks_database</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">FF_BM_DB_PATH</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">load_firefox_database</span><span class="p">(</span><span class="n">bookmarks_database</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">logerr</span><span class="p">(</span><span class="s1">&#39;Could not import from firefox&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span></div>

<div class="viewcode-block" id="BukuDb.importdb"><a class="viewcode-back" href="../source/buku.html#buku.BukuDb.importdb">[docs]</a>    <span class="k">def</span> <span class="nf">importdb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">,</span> <span class="n">tacit</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Import bookmarks from a html or a markdown file.</span>

<span class="sd">        Supports Firefox, Google Chrome, and IE exported html bookmarks.</span>
<span class="sd">        Supports markdown files with extension &#39;.md&#39;.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filepath : str</span>
<span class="sd">            Path to file to import.</span>
<span class="sd">        tacit : bool, optional</span>
<span class="sd">            If True, no questions asked and folder names are automatically</span>
<span class="sd">            imported as tags. Default is False.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">            True on success, False on failure.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">tacit</span><span class="p">:</span>
            <span class="n">newtag</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s1">&#39;Specify unique tag for imports (Enter to skip): &#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">newtag</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">filepath</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.md&#39;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">import_md</span><span class="p">(</span><span class="n">filepath</span><span class="o">=</span><span class="n">filepath</span><span class="p">,</span> <span class="n">newtag</span><span class="o">=</span><span class="n">newtag</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_rec</span><span class="p">(</span><span class="o">*</span><span class="n">item</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">import</span> <span class="nn">bs4</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">infp</span><span class="p">:</span>
                    <span class="n">soup</span> <span class="o">=</span> <span class="n">bs4</span><span class="o">.</span><span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">infp</span><span class="p">,</span> <span class="s1">&#39;html.parser&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
                <span class="n">logerr</span><span class="p">(</span><span class="s1">&#39;Beautiful Soup not found&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logerr</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">tacit</span><span class="p">:</span>
                <span class="n">resp</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s1">&#39;Add parent folder names as tags? (y/n): &#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">resp</span> <span class="o">=</span> <span class="s1">&#39;y&#39;</span>

            <span class="n">add_parent_folder_as_tag</span> <span class="o">=</span> <span class="p">(</span><span class="n">resp</span> <span class="o">==</span> <span class="s1">&#39;y&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">import_html</span><span class="p">(</span><span class="n">soup</span><span class="p">,</span> <span class="n">add_parent_folder_as_tag</span><span class="p">,</span> <span class="n">newtag</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_rec</span><span class="p">(</span><span class="o">*</span><span class="n">item</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="n">infp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="BukuDb.mergedb"><a class="viewcode-back" href="../source/buku.html#buku.BukuDb.mergedb">[docs]</a>    <span class="k">def</span> <span class="nf">mergedb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Merge bookmarks from another Buku database file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        path : str</span>
<span class="sd">            Path to DB file to merge.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">            True on success, False on failure.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Connect to input DB</span>
            <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">):</span>
                <span class="c1"># Python 3.4.4 and above</span>
                <span class="n">indb_conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;file:</span><span class="si">%s</span><span class="s1">?mode=ro&#39;</span> <span class="o">%</span> <span class="n">path</span><span class="p">,</span> <span class="n">uri</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">indb_conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

            <span class="n">indb_cur</span> <span class="o">=</span> <span class="n">indb_conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
            <span class="n">indb_cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;SELECT * FROM bookmarks&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logerr</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="n">resultset</span> <span class="o">=</span> <span class="n">indb_cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">resultset</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">resultset</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_rec</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="kc">True</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">indb_cur</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">indb_conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="BukuDb.tnyfy_url"><a class="viewcode-back" href="../source/buku.html#buku.BukuDb.tnyfy_url">[docs]</a>    <span class="k">def</span> <span class="nf">tnyfy_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">shorten</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Shorten a URL using Google URL shortener.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        index : int, optional (if URL is provided)</span>
<span class="sd">            DB index of the bookmark with the URL to shorten. Default is 0.</span>
<span class="sd">        url : str, optional (if index is provided)</span>
<span class="sd">            URL to shorten</span>
<span class="sd">        shorten : bool, optional</span>
<span class="sd">            True to shorten, False to expand. Default is False.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str</span>
<span class="sd">            Shortened url on success, None on failure.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">index</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">url</span><span class="p">:</span>
            <span class="n">logerr</span><span class="p">(</span><span class="s1">&#39;Either a valid DB index or URL required&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">index</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;SELECT url FROM bookmarks WHERE id = ? LIMIT 1&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">index</span><span class="p">,))</span>
            <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">results</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>

            <span class="n">url</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">proxies</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;https&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;https_proxy&#39;</span><span class="p">),</span>
        <span class="p">}</span>

        <span class="kn">from</span> <span class="nn">urllib.parse</span> <span class="k">import</span> <span class="n">quote_plus</span> <span class="k">as</span> <span class="n">qp</span>

        <span class="n">urlbase</span> <span class="o">=</span> <span class="s1">&#39;https://tny.im/yourls-api.php?action=&#39;</span>
        <span class="k">if</span> <span class="n">shorten</span><span class="p">:</span>
            <span class="n">_u</span> <span class="o">=</span> <span class="n">urlbase</span> <span class="o">+</span> <span class="s1">&#39;shorturl&amp;format=simple&amp;url=&#39;</span> <span class="o">+</span> <span class="n">qp</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_u</span> <span class="o">=</span> <span class="n">urlbase</span> <span class="o">+</span> <span class="s1">&#39;expand&amp;format=simple&amp;shorturl=&#39;</span> <span class="o">+</span> <span class="n">qp</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">_u</span><span class="p">,</span>
                              <span class="n">headers</span><span class="o">=</span><span class="p">{</span>
                                       <span class="s1">&#39;content-type&#39;</span><span class="p">:</span> <span class="s1">&#39;application/json&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;User-Agent&#39;</span><span class="p">:</span> <span class="n">USER_AGENT</span>
                                      <span class="p">},</span>
                              <span class="n">proxies</span><span class="o">=</span><span class="n">proxies</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logerr</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
            <span class="n">logerr</span><span class="p">(</span><span class="s1">&#39;[</span><span class="si">%s</span><span class="s1">] </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">reason</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="n">text</span></div>

<div class="viewcode-block" id="BukuDb.fixtags"><a class="viewcode-back" href="../source/buku.html#buku.BukuDb.fixtags">[docs]</a>    <span class="k">def</span> <span class="nf">fixtags</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Undocumented API to fix tags set in earlier versions.</span>

<span class="sd">        Functionalities:</span>

<span class="sd">        1. Remove duplicate tags</span>
<span class="sd">        2. Sort tags</span>
<span class="sd">        3. Use lower case to store tags</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">to_commit</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;SELECT id, tags FROM bookmarks ORDER BY id ASC&#39;</span><span class="p">)</span>
        <span class="n">resultset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;UPDATE bookmarks SET tags = ? WHERE id = ?&#39;</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">resultset</span><span class="p">:</span>
            <span class="n">oldtags</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">oldtags</span> <span class="o">==</span> <span class="n">DELIM</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">tags</span> <span class="o">=</span> <span class="n">parse_tags</span><span class="p">([</span><span class="n">oldtags</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">tags</span> <span class="o">==</span> <span class="n">oldtags</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">tags</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],))</span>
            <span class="n">to_commit</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">to_commit</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span></div>

<div class="viewcode-block" id="BukuDb.close_quit"><a class="viewcode-back" href="../source/buku.html#buku.BukuDb.close_quit">[docs]</a>    <span class="k">def</span> <span class="nf">close_quit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exitval</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Close a DB connection and exit.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        exitval : int, optional</span>
<span class="sd">            Program exit value.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="c1"># ignore errors here, we&#39;re closing down</span>
                <span class="k">pass</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">exitval</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="ExtendedArgumentParser"><a class="viewcode-back" href="../source/buku.html#buku.ExtendedArgumentParser">[docs]</a><span class="k">class</span> <span class="nc">ExtendedArgumentParser</span><span class="p">(</span><span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Extend classic argument parser&quot;&quot;&quot;</span>

<div class="viewcode-block" id="ExtendedArgumentParser.program_info"><a class="viewcode-back" href="../source/buku.html#buku.ExtendedArgumentParser.program_info">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">program_info</span><span class="p">(</span><span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Print program info.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        file : file, optional</span>
<span class="sd">            File to write program info to. Default is sys.stdout.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s1">&#39;win32&#39;</span> <span class="ow">and</span> <span class="n">file</span> <span class="o">==</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">:</span>
            <span class="n">file</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span>

        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">SYMBOLS:</span>
<span class="s1">      &gt;                    url</span>
<span class="s1">      +                    comment</span>
<span class="s1">      #                    tags</span>

<span class="s1">Version </span><span class="si">%s</span><span class="s1"></span>
<span class="s1">Copyright Â© 2015-2017 </span><span class="si">%s</span><span class="s1"></span>
<span class="s1">License: </span><span class="si">%s</span><span class="s1"></span>
<span class="s1">Webpage: https://github.com/jarun/Buku</span>
<span class="s1">&#39;&#39;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">__version__</span><span class="p">,</span> <span class="n">__author__</span><span class="p">,</span> <span class="n">__license__</span><span class="p">))</span></div>

<div class="viewcode-block" id="ExtendedArgumentParser.prompt_help"><a class="viewcode-back" href="../source/buku.html#buku.ExtendedArgumentParser.prompt_help">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">prompt_help</span><span class="p">(</span><span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Print prompt help.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        file : file, optional</span>
<span class="sd">            File to write program info to. Default is sys.stdout.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">PROMPT KEYS:</span>
<span class="s1">    1-N                    browse search result indices and/or ranges</span>
<span class="s1">    a                      open all results in browser</span>
<span class="s1">    s keyword [...]        search for records with ANY keyword</span>
<span class="s1">    S keyword [...]        search for records with ALL keywords</span>
<span class="s1">    d                      match substrings (&#39;pen&#39; matches &#39;opened&#39;)</span>
<span class="s1">    r expression           run a regex search</span>
<span class="s1">    t [...]                search bookmarks by tags or show taglist</span>
<span class="s1">                           list index after a tag listing shows records with the tag</span>
<span class="s1">    o id|range [...]       browse bookmarks by indices and/or ranges</span>
<span class="s1">    p id|range [...]       print bookmarks by indices and/or ranges</span>
<span class="s1">    g [taglist id|range ...] [&gt;&gt;|&gt;|&lt;&lt;] record id|range [...]</span>
<span class="s1">                           append, set, remove (all or specific) tags</span>
<span class="s1">    w [editor|id]          edit and add or update a bookmark</span>
<span class="s1">    ?                      show this help</span>
<span class="s1">    q, ^D, double Enter    exit buku</span>

<span class="s1">&#39;&#39;&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="ExtendedArgumentParser.is_colorstr"><a class="viewcode-back" href="../source/buku.html#buku.ExtendedArgumentParser.is_colorstr">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">is_colorstr</span><span class="p">(</span><span class="n">arg</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check if a string is a valid color string.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        arg : str</span>
<span class="sd">            Color string to validate.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str</span>
<span class="sd">            Same color string that was passed as an argument.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ArgumentTypeError</span>
<span class="sd">            If the arg is not a valid color string.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="o">==</span> <span class="mi">5</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">arg</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">COLORMAP</span>
        <span class="k">except</span> <span class="ne">AssertionError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentTypeError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> is not a valid color string&#39;</span> <span class="o">%</span> <span class="n">arg</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">arg</span></div>

    <span class="c1"># Help</span>
<div class="viewcode-block" id="ExtendedArgumentParser.print_help"><a class="viewcode-back" href="../source/buku.html#buku.ExtendedArgumentParser.print_help">[docs]</a>    <span class="k">def</span> <span class="nf">print_help</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Print help prompt.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        file : file, optional</span>
<span class="sd">            File to write program info to. Default is sys.stdout.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ExtendedArgumentParser</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">print_help</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">program_info</span><span class="p">(</span><span class="n">file</span><span class="p">)</span></div></div>


<span class="c1"># ----------------</span>
<span class="c1"># Helper functions</span>
<span class="c1"># ----------------</span>

<div class="viewcode-block" id="get_firefox_profile_name"><a class="viewcode-back" href="../source/buku.html#buku.get_firefox_profile_name">[docs]</a><span class="k">def</span> <span class="nf">get_firefox_profile_name</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;List folder and detect default Firefox profile name.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    profile : str</span>
<span class="sd">        Firefox profile name.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">names</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">profile</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span><span class="p">[:</span><span class="o">-</span><span class="mi">8</span><span class="p">]</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span> <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.default&#39;</span><span class="p">)][</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">profile</span></div>


<div class="viewcode-block" id="walk"><a class="viewcode-back" href="../source/buku.html#buku.walk">[docs]</a><span class="k">def</span> <span class="nf">walk</span><span class="p">(</span><span class="n">root</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Recursively iterate over json.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    root : json element</span>
<span class="sd">        Base node of the json data.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">root</span><span class="p">[</span><span class="s1">&#39;children&#39;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">element</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;url&#39;</span><span class="p">:</span>
            <span class="n">url</span> <span class="o">=</span> <span class="n">element</span><span class="p">[</span><span class="s1">&#39;url&#39;</span><span class="p">]</span>
            <span class="n">title</span> <span class="o">=</span> <span class="n">element</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
            <span class="k">yield</span> <span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">walk</span><span class="p">(</span><span class="n">element</span><span class="p">)</span></div>


<div class="viewcode-block" id="is_bad_url"><a class="viewcode-back" href="../source/buku.html#buku.is_bad_url">[docs]</a><span class="k">def</span> <span class="nf">is_bad_url</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Check if URL is malformed.</span>

<span class="sd">    .. note:: This API is not bulletproof but works in most cases.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    url : str</span>
<span class="sd">        URL to scan.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    bool</span>
<span class="sd">        True if URL is malformed, False otherwise.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Get the netloc token</span>
    <span class="n">netloc</span> <span class="o">=</span> <span class="n">parse_url</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">netloc</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">netloc</span><span class="p">:</span>
        <span class="c1"># Try of prepend &#39;//&#39; and get netloc</span>
        <span class="n">netloc</span> <span class="o">=</span> <span class="n">parse_url</span><span class="p">(</span><span class="s1">&#39;//&#39;</span> <span class="o">+</span> <span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">netloc</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">netloc</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>

    <span class="n">logdbg</span><span class="p">(</span><span class="s1">&#39;netloc: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">netloc</span><span class="p">)</span>

    <span class="c1"># netloc cannot start or end with a &#39;.&#39;</span>
    <span class="k">if</span> <span class="n">netloc</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">netloc</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="c1"># netloc should have at least one &#39;.&#39;</span>
    <span class="k">if</span> <span class="n">netloc</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="is_nongeneric_url"><a class="viewcode-back" href="../source/buku.html#buku.is_nongeneric_url">[docs]</a><span class="k">def</span> <span class="nf">is_nongeneric_url</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns True for URLs which are non-http and non-generic.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    url : str</span>
<span class="sd">        URL to scan.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    bool</span>
<span class="sd">        True if URL is a nongeneric URL, False otherwise.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">ignored_prefix</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;place:&#39;</span><span class="p">,</span> <span class="s1">&#39;file://&#39;</span><span class="p">,</span> <span class="s1">&#39;apt:&#39;</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">prefix</span> <span class="ow">in</span> <span class="n">ignored_prefix</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">url</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">prefix</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">True</span>

    <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="is_ignored_mime"><a class="viewcode-back" href="../source/buku.html#buku.is_ignored_mime">[docs]</a><span class="k">def</span> <span class="nf">is_ignored_mime</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Check if URL links to ignored MIME.</span>

<span class="sd">    .. note:: Only a &#39;HEAD&#39; request is made for these URLs.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    url : str</span>
<span class="sd">        URL to scan.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    bool</span>
<span class="sd">        True if URL links to ignored MIME, False otherwise.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">for</span> <span class="n">mime</span> <span class="ow">in</span> <span class="n">SKIP_MIMES</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">url</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">mime</span><span class="p">):</span>
            <span class="n">logdbg</span><span class="p">(</span><span class="s1">&#39;matched MIME: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">mime</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>

    <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="get_page_title"><a class="viewcode-back" href="../source/buku.html#buku.get_page_title">[docs]</a><span class="k">def</span> <span class="nf">get_page_title</span><span class="p">(</span><span class="n">resp</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Invoke HTML parser and extract title from HTTP response.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    resp : HTTP response</span>
<span class="sd">        Response from GET request.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        Title fetched from parsed page.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">parser</span> <span class="o">=</span> <span class="n">BukuHTMLParser</span><span class="p">()</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">feed</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">errors</span><span class="o">=</span><span class="s1">&#39;replace&#39;</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c1"># Suppress Exception due to intentional self.reset() in BHTMLParser</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">logger</span><span class="o">.</span><span class="n">isEnabledFor</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;we should not get here!&#39;</span><span class="p">):</span>
            <span class="n">logerr</span><span class="p">(</span><span class="s1">&#39;get_page_title(): </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">parser</span><span class="o">.</span><span class="n">parsed_title</span></div>


<div class="viewcode-block" id="gen_headers"><a class="viewcode-back" href="../source/buku.html#buku.gen_headers">[docs]</a><span class="k">def</span> <span class="nf">gen_headers</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Generate headers for network connection.&quot;&quot;&quot;</span>

    <span class="k">global</span> <span class="n">myheaders</span><span class="p">,</span> <span class="n">myproxy</span>

    <span class="n">myheaders</span> <span class="o">=</span> <span class="p">{</span>
                 <span class="s1">&#39;Accept-Encoding&#39;</span><span class="p">:</span> <span class="s1">&#39;gzip,deflate&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;User-Agent&#39;</span><span class="p">:</span> <span class="n">USER_AGENT</span><span class="p">,</span>
                 <span class="s1">&#39;Accept&#39;</span><span class="p">:</span> <span class="s1">&#39;*/*&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;Cookie&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;DNT&#39;</span><span class="p">:</span> <span class="s1">&#39;1&#39;</span>
                <span class="p">}</span>

    <span class="n">myproxy</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;https_proxy&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">myproxy</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">url</span> <span class="o">=</span> <span class="n">parse_url</span><span class="p">(</span><span class="n">myproxy</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logerr</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># Strip username and password (if present) and update headers</span>
        <span class="k">if</span> <span class="n">url</span><span class="o">.</span><span class="n">auth</span><span class="p">:</span>
            <span class="n">myproxy</span> <span class="o">=</span> <span class="n">myproxy</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">url</span><span class="o">.</span><span class="n">auth</span> <span class="o">+</span> <span class="s1">&#39;@&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">auth_headers</span> <span class="o">=</span> <span class="n">make_headers</span><span class="p">(</span><span class="n">basic_auth</span><span class="o">=</span><span class="n">url</span><span class="o">.</span><span class="n">auth</span><span class="p">)</span>
            <span class="n">myheaders</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">auth_headers</span><span class="p">)</span>

        <span class="n">logdbg</span><span class="p">(</span><span class="s1">&#39;proxy: [</span><span class="si">%s</span><span class="s1">]&#39;</span><span class="p">,</span> <span class="n">myproxy</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_PoolManager"><a class="viewcode-back" href="../source/buku.html#buku.get_PoolManager">[docs]</a><span class="k">def</span> <span class="nf">get_PoolManager</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Creates a pool manager with proxy support, if applicable.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ProxyManager or PoolManager</span>
<span class="sd">        ProxyManager if https_proxy is defined, PoolManager otherwise.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">myproxy</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">urllib3</span><span class="o">.</span><span class="n">ProxyManager</span><span class="p">(</span><span class="n">myproxy</span><span class="p">,</span> <span class="n">num_pools</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">myheaders</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">urllib3</span><span class="o">.</span><span class="n">PoolManager</span><span class="p">(</span><span class="n">num_pools</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">myheaders</span><span class="p">)</span></div>


<div class="viewcode-block" id="network_handler"><a class="viewcode-back" href="../source/buku.html#buku.network_handler">[docs]</a><span class="k">def</span> <span class="nf">network_handler</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">http_head</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Handle server connection and redirections.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    url : str</span>
<span class="sd">        URL to fetch.</span>
<span class="sd">    http_head : bool</span>
<span class="sd">        If True, send only HTTP HEAD request. Default is False.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple</span>
<span class="sd">        (title, recognized mime, bad url)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">page_title</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">is_bad_url</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">is_ignored_mime</span><span class="p">(</span><span class="n">url</span><span class="p">)</span> <span class="ow">or</span> <span class="n">http_head</span><span class="p">:</span>
        <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;HEAD&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;GET&#39;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">myheaders</span><span class="p">:</span>
        <span class="n">gen_headers</span><span class="p">()</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">http_handler</span> <span class="o">=</span> <span class="n">get_PoolManager</span><span class="p">()</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="n">http_handler</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">40</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;GET&#39;</span><span class="p">:</span>
                    <span class="n">page_title</span> <span class="o">=</span> <span class="n">get_page_title</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">403</span> <span class="ow">and</span> <span class="n">url</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">):</span>
                <span class="c1"># HTTP response Forbidden</span>
                <span class="c1"># Handle URLs in the form of https://www.domain.com/</span>
                <span class="c1"># which fail when trying to fetch resource &#39;/&#39;</span>
                <span class="c1"># retry without trailing &#39;/&#39;</span>

                <span class="n">logdbg</span><span class="p">(</span><span class="s1">&#39;Received status 403: retrying...&#39;</span><span class="p">)</span>
                <span class="c1"># Remove trailing /</span>
                <span class="n">url</span> <span class="o">=</span> <span class="n">url</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">resp</span><span class="o">.</span><span class="n">release_conn</span><span class="p">()</span>
                <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logerr</span><span class="p">(</span><span class="s1">&#39;[</span><span class="si">%s</span><span class="s1">] </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">resp</span><span class="o">.</span><span class="n">status</span><span class="p">,</span> <span class="n">resp</span><span class="o">.</span><span class="n">reason</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">resp</span><span class="p">:</span>
                <span class="n">resp</span><span class="o">.</span><span class="n">release_conn</span><span class="p">()</span>

            <span class="k">break</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logerr</span><span class="p">(</span><span class="s1">&#39;network_handler(): </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">http_handler</span><span class="p">:</span>
            <span class="n">http_handler</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;HEAD&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">page_title</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">page_title</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span></div>


<div class="viewcode-block" id="parse_tags"><a class="viewcode-back" href="../source/buku.html#buku.parse_tags">[docs]</a><span class="k">def</span> <span class="nf">parse_tags</span><span class="p">(</span><span class="n">keywords</span><span class="o">=</span><span class="p">[]):</span>
    <span class="sd">&quot;&quot;&quot;Format and get tag string from tokens.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    keywords : list, optional</span>
<span class="sd">        List of tags to parse. Default is empty list.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        Comma-delimited string of tags.</span>
<span class="sd">    DELIM : str</span>
<span class="sd">        If no keywords, returns the delimiter.</span>
<span class="sd">    None</span>
<span class="sd">        If keywords is None.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">keywords</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">keywords</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">DELIM</span>

    <span class="n">tags</span> <span class="o">=</span> <span class="n">DELIM</span>

    <span class="c1"># Cleanse and get the tags</span>
    <span class="n">tagstr</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">keywords</span><span class="p">)</span>
    <span class="n">marker</span> <span class="o">=</span> <span class="n">tagstr</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">DELIM</span><span class="p">)</span>

    <span class="k">while</span> <span class="n">marker</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">token</span> <span class="o">=</span> <span class="n">tagstr</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">marker</span><span class="p">]</span>
        <span class="n">tagstr</span> <span class="o">=</span> <span class="n">tagstr</span><span class="p">[</span><span class="n">marker</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]</span>
        <span class="n">marker</span> <span class="o">=</span> <span class="n">tagstr</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">DELIM</span><span class="p">)</span>
        <span class="n">token</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">token</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">tags</span> <span class="o">+=</span> <span class="n">token</span> <span class="o">+</span> <span class="n">DELIM</span>

    <span class="n">tagstr</span> <span class="o">=</span> <span class="n">tagstr</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">tagstr</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="n">tags</span> <span class="o">+=</span> <span class="n">tagstr</span> <span class="o">+</span> <span class="n">DELIM</span>

    <span class="n">logdbg</span><span class="p">(</span><span class="s1">&#39;keywords: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">keywords</span><span class="p">)</span>
    <span class="n">logdbg</span><span class="p">(</span><span class="s1">&#39;parsed tags: [</span><span class="si">%s</span><span class="s1">]&#39;</span><span class="p">,</span> <span class="n">tags</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">tags</span> <span class="o">==</span> <span class="n">DELIM</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">tags</span>

    <span class="n">orig_tags</span> <span class="o">=</span> <span class="n">tags</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="n">DELIM</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">DELIM</span><span class="p">)</span>

    <span class="c1"># Add unique tags in lower case</span>
    <span class="n">unique_tags</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">orig_tags</span><span class="p">:</span>
        <span class="n">tag</span> <span class="o">=</span> <span class="n">tag</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">tag</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">unique_tags</span><span class="p">:</span>
            <span class="n">unique_tags</span> <span class="o">+=</span> <span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="p">)</span>

    <span class="c1"># Sort the tags</span>
    <span class="n">sorted_tags</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">unique_tags</span><span class="p">)</span>

    <span class="c1"># Wrap with delimiter</span>
    <span class="k">return</span> <span class="n">delim_wrap</span><span class="p">(</span><span class="n">DELIM</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sorted_tags</span><span class="p">))</span></div>


<div class="viewcode-block" id="prep_tag_search"><a class="viewcode-back" href="../source/buku.html#buku.prep_tag_search">[docs]</a><span class="k">def</span> <span class="nf">prep_tag_search</span><span class="p">(</span><span class="n">tags</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Prepare list of tags to search and determine search operator.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    tags : str</span>
<span class="sd">        String list of tags to search.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple</span>
<span class="sd">        (list of formatted tags to search,</span>
<span class="sd">         a string indicating query search operator (either OR or AND),</span>
<span class="sd">         a regex string of tags or None if &#39; - &#39; delimiter not in tags)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">excluded_tags</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="s1">&#39; - &#39;</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">:</span>
        <span class="n">tags</span><span class="p">,</span> <span class="n">excluded_tags</span> <span class="o">=</span> <span class="n">tags</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; - &#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">excluded_taglist</span> <span class="o">=</span> <span class="p">[</span><span class="n">delim_wrap</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">excluded_tags</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)]</span>
        <span class="c1"># join with pipe to construct regex string</span>
        <span class="n">excluded_tags</span> <span class="o">=</span> <span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">excluded_taglist</span><span class="p">)</span>

    <span class="n">search_operator</span> <span class="o">=</span> <span class="s1">&#39;OR&#39;</span>
    <span class="n">tag_delim</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span>
    <span class="k">if</span> <span class="s1">&#39; + &#39;</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">:</span>
        <span class="n">search_operator</span> <span class="o">=</span> <span class="s1">&#39;AND&#39;</span>
        <span class="n">tag_delim</span> <span class="o">=</span> <span class="s1">&#39; + &#39;</span>

    <span class="n">tags</span> <span class="o">=</span> <span class="p">[</span><span class="n">delim_wrap</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tags</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">tag_delim</span><span class="p">)]</span>

    <span class="k">return</span> <span class="n">tags</span><span class="p">,</span> <span class="n">search_operator</span><span class="p">,</span> <span class="n">excluded_tags</span></div>


<div class="viewcode-block" id="edit_at_prompt"><a class="viewcode-back" href="../source/buku.html#buku.edit_at_prompt">[docs]</a><span class="k">def</span> <span class="nf">edit_at_prompt</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">nav</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Edit and add or update a bookmark.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    obj : BukuDb instance</span>
<span class="sd">        A valid instance of BukuDb class.</span>
<span class="sd">    nav : str</span>
<span class="sd">        Navigation command argument passed at prompt by user.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">nav</span> <span class="o">==</span> <span class="s1">&#39;w&#39;</span><span class="p">:</span>
        <span class="n">editor</span> <span class="o">=</span> <span class="n">get_system_editor</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_editor_valid</span><span class="p">(</span><span class="n">editor</span><span class="p">):</span>
            <span class="k">return</span>
    <span class="k">elif</span> <span class="n">is_int</span><span class="p">(</span><span class="n">nav</span><span class="p">[</span><span class="mi">2</span><span class="p">:]):</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">edit_update_rec</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">nav</span><span class="p">[</span><span class="mi">2</span><span class="p">:]))</span>
        <span class="k">return</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">editor</span> <span class="o">=</span> <span class="n">nav</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">edit_rec</span><span class="p">(</span><span class="n">editor</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">DELIM</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">url</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">tags</span><span class="p">,</span> <span class="n">desc</span> <span class="o">=</span> <span class="n">result</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">add_rec</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">tags</span><span class="p">,</span> <span class="n">desc</span><span class="p">)</span></div>


<div class="viewcode-block" id="taglist_subprompt"><a class="viewcode-back" href="../source/buku.html#buku.taglist_subprompt">[docs]</a><span class="k">def</span> <span class="nf">taglist_subprompt</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">noninteractive</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Additional prompt to show unique tag list.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    obj : BukuDb instance</span>
<span class="sd">        A valid instance of BukuDb class.</span>
<span class="sd">    noninteractive : bool, optional</span>
<span class="sd">        If True, does not seek user input. Default is False.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        New command string.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">unique_tags</span><span class="p">,</span> <span class="n">dic</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">get_tag_all</span><span class="p">()</span>
    <span class="n">new_results</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">new_results</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">unique_tags</span><span class="p">:</span>
                <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;0 tags&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">count</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">unique_tags</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%6d</span><span class="s1">. </span><span class="si">%s</span><span class="s1"> (</span><span class="si">%d</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">dic</span><span class="p">[</span><span class="n">tag</span><span class="p">]))</span>
                    <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="nb">print</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">noninteractive</span><span class="p">:</span>
                <span class="k">return</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">nav</span> <span class="o">=</span> <span class="n">read_in</span><span class="p">(</span><span class="n">promptmsg</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">nav</span><span class="p">:</span>
                <span class="n">nav</span> <span class="o">=</span> <span class="n">read_in</span><span class="p">(</span><span class="n">promptmsg</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">nav</span><span class="p">:</span>
                    <span class="c1"># Quit on double enter</span>
                    <span class="k">return</span> <span class="s1">&#39;q&#39;</span>
            <span class="n">nav</span> <span class="o">=</span> <span class="n">nav</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">EOFError</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;q&#39;</span>

        <span class="k">if</span> <span class="n">is_int</span><span class="p">(</span><span class="n">nav</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">int</span><span class="p">(</span><span class="n">nav</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">int</span><span class="p">(</span><span class="n">nav</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;t &#39;</span> <span class="o">+</span> <span class="n">unique_tags</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">nav</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">is_int</span><span class="p">(</span><span class="n">nav</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No matching index </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">nav</span><span class="p">)</span>
            <span class="n">new_results</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="n">nav</span> <span class="o">==</span> <span class="s1">&#39;t&#39;</span><span class="p">:</span>
            <span class="n">new_results</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">nav</span> <span class="o">==</span> <span class="s1">&#39;q&#39;</span> <span class="ow">or</span> <span class="n">nav</span> <span class="o">==</span> <span class="s1">&#39;d&#39;</span> <span class="ow">or</span> <span class="n">nav</span> <span class="o">==</span> <span class="s1">&#39;?&#39;</span> <span class="ow">or</span>
              <span class="n">nav</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;s &#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">nav</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;S &#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">nav</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;r &#39;</span><span class="p">)</span> <span class="ow">or</span>
              <span class="n">nav</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;t &#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">nav</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;o &#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">nav</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;p &#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">nav</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;g &#39;</span><span class="p">)):</span>
            <span class="k">return</span> <span class="n">nav</span>
        <span class="k">elif</span> <span class="n">nav</span> <span class="o">==</span> <span class="s1">&#39;w&#39;</span> <span class="ow">or</span> <span class="n">nav</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;w &#39;</span><span class="p">):</span>
            <span class="n">edit_at_prompt</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">nav</span><span class="p">)</span>
            <span class="n">new_results</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Invalid input&#39;</span><span class="p">)</span>
            <span class="n">new_results</span> <span class="o">=</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="prompt"><a class="viewcode-back" href="../source/buku.html#buku.prompt">[docs]</a><span class="k">def</span> <span class="nf">prompt</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">results</span><span class="p">,</span> <span class="n">noninteractive</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">deep</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">subprompt</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Show each matching result from a search and prompt.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    obj : BukuDb instance</span>
<span class="sd">        A valid instance of BukuDb class.</span>
<span class="sd">    results : list</span>
<span class="sd">        Search result set from a DB query.</span>
<span class="sd">    noninteractive : bool, optional</span>
<span class="sd">        If True, does not seek user input. Default is False.</span>
<span class="sd">    deep : bool, optional</span>
<span class="sd">        Use deep search. Default is False.</span>
<span class="sd">    subprompt : bool, optional</span>
<span class="sd">        If True, jump directly to subprompt.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="ow">is</span> <span class="n">BukuDb</span><span class="p">:</span>
        <span class="n">logerr</span><span class="p">(</span><span class="s1">&#39;Not a BukuDb instance&#39;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="n">new_results</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">subprompt</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">new_results</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">results</span><span class="p">:</span>
                    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>

                    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
                        <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">print_single_rec</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;0 results&#39;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">noninteractive</span><span class="p">:</span>
                    <span class="k">return</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">nav</span> <span class="o">=</span> <span class="n">read_in</span><span class="p">(</span><span class="n">promptmsg</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">nav</span><span class="p">:</span>
                    <span class="n">nav</span> <span class="o">=</span> <span class="n">read_in</span><span class="p">(</span><span class="n">promptmsg</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">nav</span><span class="p">:</span>
                        <span class="c1"># Quit on double enter</span>
                        <span class="k">break</span>
                <span class="n">nav</span> <span class="o">=</span> <span class="n">nav</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">EOFError</span><span class="p">:</span>
                <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nav</span> <span class="o">=</span> <span class="s1">&#39;t&#39;</span>
            <span class="n">subprompt</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># list tags with &#39;t&#39;</span>
        <span class="k">if</span> <span class="n">nav</span> <span class="o">==</span> <span class="s1">&#39;t&#39;</span><span class="p">:</span>
            <span class="n">nav</span> <span class="o">=</span> <span class="n">taglist_subprompt</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">noninteractive</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">noninteractive</span><span class="p">:</span>
                <span class="k">return</span>

        <span class="c1"># search ANY match with new keywords</span>
        <span class="k">if</span> <span class="n">nav</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;s &#39;</span><span class="p">):</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">searchdb</span><span class="p">(</span><span class="n">nav</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span><span class="o">.</span><span class="n">split</span><span class="p">(),</span> <span class="kc">False</span><span class="p">,</span> <span class="n">deep</span><span class="p">)</span>
            <span class="n">new_results</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">continue</span>

        <span class="c1"># search ALL match with new keywords</span>
        <span class="k">if</span> <span class="n">nav</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;S &#39;</span><span class="p">):</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">searchdb</span><span class="p">(</span><span class="n">nav</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span><span class="o">.</span><span class="n">split</span><span class="p">(),</span> <span class="kc">True</span><span class="p">,</span> <span class="n">deep</span><span class="p">)</span>
            <span class="n">new_results</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">continue</span>

        <span class="c1"># regular expressions search with new keywords</span>
        <span class="k">if</span> <span class="n">nav</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;r &#39;</span><span class="p">):</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">searchdb</span><span class="p">(</span><span class="n">nav</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span><span class="o">.</span><span class="n">split</span><span class="p">(),</span> <span class="kc">True</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">new_results</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">continue</span>

        <span class="c1"># tag search with new keywords</span>
        <span class="k">if</span> <span class="n">nav</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;t &#39;</span><span class="p">):</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">search_by_tag</span><span class="p">(</span><span class="n">nav</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span>
            <span class="n">new_results</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">continue</span>

        <span class="c1"># quit with &#39;q&#39;</span>
        <span class="k">if</span> <span class="n">nav</span> <span class="o">==</span> <span class="s1">&#39;q&#39;</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># No new results fetched beyond this point</span>
        <span class="n">new_results</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># toggle deep search with &#39;d&#39;</span>
        <span class="k">if</span> <span class="n">nav</span> <span class="o">==</span> <span class="s1">&#39;d&#39;</span><span class="p">:</span>
            <span class="n">deep</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">deep</span>
            <span class="k">if</span> <span class="n">deep</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;deep search on&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;deep search off&#39;</span><span class="p">)</span>

            <span class="k">continue</span>

        <span class="c1"># Show help with &#39;?&#39;</span>
        <span class="k">if</span> <span class="n">nav</span> <span class="o">==</span> <span class="s1">&#39;?&#39;</span><span class="p">:</span>
            <span class="n">ExtendedArgumentParser</span><span class="o">.</span><span class="n">prompt_help</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="c1"># Edit and add or update</span>
        <span class="k">if</span> <span class="n">nav</span> <span class="o">==</span> <span class="s1">&#39;w&#39;</span> <span class="ow">or</span> <span class="n">nav</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;w &#39;</span><span class="p">):</span>
            <span class="n">edit_at_prompt</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">nav</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="c1"># Append or overwrite tags</span>
        <span class="k">if</span> <span class="n">nav</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;g &#39;</span><span class="p">):</span>
            <span class="n">unique_tags</span><span class="p">,</span> <span class="n">dic</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">get_tag_all</span><span class="p">()</span>
            <span class="n">_count</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">set_tag</span><span class="p">(</span><span class="n">nav</span><span class="p">[</span><span class="mi">2</span><span class="p">:],</span> <span class="n">unique_tags</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">_count</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Invalid input&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1"> updated&#39;</span> <span class="o">%</span> <span class="n">_count</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="c1"># Print bookmarks by DB index</span>
        <span class="k">if</span> <span class="n">nav</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;p &#39;</span><span class="p">):</span>
            <span class="n">id_list</span> <span class="o">=</span> <span class="n">nav</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">id_list</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">is_int</span><span class="p">(</span><span class="nb">id</span><span class="p">):</span>
                        <span class="n">obj</span><span class="o">.</span><span class="n">print_rec</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">id</span><span class="p">))</span>
                    <span class="k">elif</span> <span class="s1">&#39;-&#39;</span> <span class="ow">in</span> <span class="nb">id</span><span class="p">:</span>
                        <span class="n">vals</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">id</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)]</span>
                        <span class="n">obj</span><span class="o">.</span><span class="n">print_rec</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vals</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="kc">True</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Invalid input&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Invalid input&#39;</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="c1"># Browse bookmarks by DB index</span>
        <span class="k">if</span> <span class="n">nav</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;o &#39;</span><span class="p">):</span>
            <span class="n">id_list</span> <span class="o">=</span> <span class="n">nav</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">id_list</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">is_int</span><span class="p">(</span><span class="nb">id</span><span class="p">):</span>
                        <span class="n">obj</span><span class="o">.</span><span class="n">browse_by_index</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">id</span><span class="p">))</span>
                    <span class="k">elif</span> <span class="s1">&#39;-&#39;</span> <span class="ow">in</span> <span class="nb">id</span><span class="p">:</span>
                        <span class="n">vals</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">id</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)]</span>
                        <span class="n">obj</span><span class="o">.</span><span class="n">browse_by_index</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vals</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="kc">True</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Invalid input&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Invalid input&#39;</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="c1"># Nothing to browse if there are no results</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">results</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Not in a search context&#39;</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="c1"># open all results and re-prompt with &#39;a&#39;</span>
        <span class="k">if</span> <span class="n">nav</span> <span class="o">==</span> <span class="s1">&#39;a&#39;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">count</span><span class="p">):</span>
                <span class="n">browse</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">continue</span>

        <span class="c1"># iterate over white-space separated indices</span>
        <span class="k">for</span> <span class="n">nav</span> <span class="ow">in</span> <span class="n">nav</span><span class="o">.</span><span class="n">split</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">is_int</span><span class="p">(</span><span class="n">nav</span><span class="p">):</span>
                <span class="n">index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">nav</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">index</span> <span class="o">&gt;=</span> <span class="n">count</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No matching index </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">nav</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="n">browse</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">elif</span> <span class="s1">&#39;-&#39;</span> <span class="ow">in</span> <span class="n">nav</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">vals</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">nav</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)]</span>
                    <span class="k">if</span> <span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">vals</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                        <span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vals</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                    <span class="k">for</span> <span class="n">_id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">vals</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
                        <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">_id</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">:</span>
                            <span class="n">browse</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="n">_id</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No matching index </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">_id</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Invalid input&#39;</span><span class="p">)</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Invalid input&#39;</span><span class="p">)</span>
                <span class="k">break</span></div>


<div class="viewcode-block" id="print_single_rec"><a class="viewcode-back" href="../source/buku.html#buku.print_single_rec">[docs]</a><span class="k">def</span> <span class="nf">print_single_rec</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">idx</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>  <span class="c1"># NOQA</span>
    <span class="sd">&quot;&quot;&quot;Print a single DB record.</span>

<span class="sd">    Handles both search results and individual record</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    row : tuple</span>
<span class="sd">        Tuple representing bookmark record data.</span>
<span class="sd">    idx : int, optional</span>
<span class="sd">        Search result index. If 0, print with DB index.</span>
<span class="sd">        Default is 0.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">str_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Start with index and title</span>
    <span class="k">if</span> <span class="n">idx</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">id_title_res</span> <span class="o">=</span> <span class="n">ID_str</span> <span class="o">%</span> <span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;Untitled&#39;</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">id_title_res</span> <span class="o">=</span> <span class="n">ID_DB_str</span> <span class="o">%</span> <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;Untitled&#39;</span><span class="p">)</span>
        <span class="c1"># Indicate if record is immutable</span>
        <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">id_title_res</span> <span class="o">=</span> <span class="n">MUTE_str</span> <span class="o">%</span> <span class="p">(</span><span class="n">id_title_res</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">id_title_res</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>

    <span class="n">str_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">id_title_res</span><span class="p">)</span>
    <span class="n">str_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">URL_str</span> <span class="o">%</span> <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="mi">4</span><span class="p">]:</span>
        <span class="n">str_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">DESC_str</span> <span class="o">%</span> <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">4</span><span class="p">]))</span>
    <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="n">DELIM</span><span class="p">:</span>
        <span class="n">str_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">TAG_str</span> <span class="o">%</span> <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">str_list</span><span class="p">))</span></div>


<div class="viewcode-block" id="format_json"><a class="viewcode-back" href="../source/buku.html#buku.format_json">[docs]</a><span class="k">def</span> <span class="nf">format_json</span><span class="p">(</span><span class="n">resultset</span><span class="p">,</span> <span class="n">single_record</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">field_filter</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return results in json format.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    resultset : list</span>
<span class="sd">        Search results from DB query.</span>
<span class="sd">    single_record : bool, optional</span>
<span class="sd">        If True, indicates only one record. Default is False.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    json</span>
<span class="sd">        Record(s) in json format.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">single_record</span><span class="p">:</span>
        <span class="n">marks</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">resultset</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">field_filter</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">marks</span><span class="p">[</span><span class="s1">&#39;uri&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">field_filter</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">marks</span><span class="p">[</span><span class="s1">&#39;uri&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">marks</span><span class="p">[</span><span class="s1">&#39;tags&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">field_filter</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">marks</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">field_filter</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                <span class="n">marks</span><span class="p">[</span><span class="s1">&#39;uri&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">marks</span><span class="p">[</span><span class="s1">&#39;tags&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">marks</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">marks</span><span class="p">[</span><span class="s1">&#39;index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">marks</span><span class="p">[</span><span class="s1">&#39;uri&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">marks</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">marks</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
                <span class="n">marks</span><span class="p">[</span><span class="s1">&#39;tags&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">marks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">resultset</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">field_filter</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">record</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;uri&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]}</span>
            <span class="k">elif</span> <span class="n">field_filter</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">record</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;uri&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;tags&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]}</span>
            <span class="k">elif</span> <span class="n">field_filter</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">record</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]}</span>
            <span class="k">elif</span> <span class="n">field_filter</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                <span class="n">record</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;uri&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="s1">&#39;tags&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">record</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;index&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;uri&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="s1">&#39;tags&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]}</span>

            <span class="n">marks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">marks</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span></div>


<div class="viewcode-block" id="is_int"><a class="viewcode-back" href="../source/buku.html#buku.is_int">[docs]</a><span class="k">def</span> <span class="nf">is_int</span><span class="p">(</span><span class="n">string</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Check if a string is a digit.</span>

<span class="sd">    string : str</span>
<span class="sd">        Input string to check.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    bool</span>
<span class="sd">        True on success, False on exception.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="nb">int</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="browse"><a class="viewcode-back" href="../source/buku.html#buku.browse">[docs]</a><span class="k">def</span> <span class="nf">browse</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Duplicate stdin, stdout and open URL in default browser</span>

<span class="sd">    .. note:: Duplicates stdin and stdout in order to</span>
<span class="sd">              suppress showing errors on the terminal.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    url : str</span>
<span class="sd">        URL to open in browser.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">parse_url</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">scheme</span><span class="p">:</span>
        <span class="c1"># Prefix with &#39;http://&#39; if no scheme</span>
        <span class="c1"># Otherwise, opening in browser fails anyway</span>
        <span class="c1"># We expect http to https redirection</span>
        <span class="c1"># will happen for https-only websites</span>
        <span class="n">logerr</span><span class="p">(</span><span class="s1">&#39;scheme missing in URI, trying http&#39;</span><span class="p">)</span>
        <span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;http://&#39;</span> <span class="o">+</span> <span class="n">url</span>

    <span class="n">_stderr</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">dup</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">_stdout</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">dup</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">fd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">devnull</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">O_RDWR</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">dup2</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">dup2</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">!=</span> <span class="s1">&#39;win32&#39;</span><span class="p">:</span>
            <span class="n">webbrowser</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">new</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># On Windows, the webbrowser module does not fork.</span>
            <span class="c1"># Use threads instead.</span>
            <span class="k">def</span> <span class="nf">browserthread</span><span class="p">():</span>
                <span class="n">webbrowser</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">new</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

            <span class="n">t</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">browserthread</span><span class="p">)</span>
            <span class="n">t</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logerr</span><span class="p">(</span><span class="s1">&#39;browse(): </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">dup2</span><span class="p">(</span><span class="n">_stderr</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">dup2</span><span class="p">(</span><span class="n">_stdout</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span></div>


<div class="viewcode-block" id="check_upstream_release"><a class="viewcode-back" href="../source/buku.html#buku.check_upstream_release">[docs]</a><span class="k">def</span> <span class="nf">check_upstream_release</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Check and report the latest upstream release version.&quot;&quot;&quot;</span>

    <span class="n">proxies</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;https&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;https_proxy&#39;</span><span class="p">),</span>
    <span class="p">}</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                         <span class="s1">&#39;https://api.github.com/repos/jarun/buku/releases?per_page=1&#39;</span><span class="p">,</span>
                         <span class="n">proxies</span><span class="o">=</span><span class="n">proxies</span>
                        <span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logerr</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
        <span class="n">logerr</span><span class="p">(</span><span class="s1">&#39;[</span><span class="si">%s</span><span class="s1">] </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">reason</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">latest</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;tag_name&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">latest</span> <span class="o">==</span> <span class="s1">&#39;v&#39;</span> <span class="o">+</span> <span class="n">__version__</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;This is the latest release&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Latest upstream release is </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">latest</span><span class="p">)</span></div>


<div class="viewcode-block" id="regexp"><a class="viewcode-back" href="../source/buku.html#buku.regexp">[docs]</a><span class="k">def</span> <span class="nf">regexp</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Perform a regular expression search.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    expr : regex</span>
<span class="sd">        Regular expression to search for.</span>
<span class="sd">    item : str</span>
<span class="sd">        Item on which to perform regex search.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    bool</span>
<span class="sd">        True if result of search is not None, returns None otherwise.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="delim_wrap"><a class="viewcode-back" href="../source/buku.html#buku.delim_wrap">[docs]</a><span class="k">def</span> <span class="nf">delim_wrap</span><span class="p">(</span><span class="n">token</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns token string wrapped in delimiters.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    token : str</span>
<span class="sd">        String item to wrap with DELIM.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        Token string wrapped by DELIM.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="n">DELIM</span> <span class="o">+</span> <span class="n">token</span> <span class="o">+</span> <span class="n">DELIM</span></div>


<div class="viewcode-block" id="read_in"><a class="viewcode-back" href="../source/buku.html#buku.read_in">[docs]</a><span class="k">def</span> <span class="nf">read_in</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A wrapper to handle input() with interrupts disabled.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    msg : str</span>
<span class="sd">        String to pass to to input()</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">disable_sigint_handler</span><span class="p">()</span>
    <span class="n">message</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">message</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Interrupted.&#39;</span><span class="p">)</span>

    <span class="n">enable_sigint_handler</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">message</span></div>


<div class="viewcode-block" id="sigint_handler"><a class="viewcode-back" href="../source/buku.html#buku.sigint_handler">[docs]</a><span class="k">def</span> <span class="nf">sigint_handler</span><span class="p">(</span><span class="n">signum</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Custom SIGINT handler.</span>

<span class="sd">    .. note:: Neither signum nor frame are used in</span>
<span class="sd">              this custom handler. However, they are</span>
<span class="sd">              required parameters for signal handlers.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    signum : int</span>
<span class="sd">        Signal number.</span>
<span class="sd">    frame : frame object or None</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">global</span> <span class="n">interrupted</span>

    <span class="n">interrupted</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Interrupted.&#39;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>

    <span class="c1"># Do a hard exit from here</span>
    <span class="n">os</span><span class="o">.</span><span class="n">_exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span></div>

<span class="n">DEFAULT_HANDLER</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGINT</span><span class="p">,</span> <span class="n">sigint_handler</span><span class="p">)</span>


<div class="viewcode-block" id="disable_sigint_handler"><a class="viewcode-back" href="../source/buku.html#buku.disable_sigint_handler">[docs]</a><span class="k">def</span> <span class="nf">disable_sigint_handler</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Disable signint handler.&quot;&quot;&quot;</span>
    <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGINT</span><span class="p">,</span> <span class="n">DEFAULT_HANDLER</span><span class="p">)</span></div>


<div class="viewcode-block" id="enable_sigint_handler"><a class="viewcode-back" href="../source/buku.html#buku.enable_sigint_handler">[docs]</a><span class="k">def</span> <span class="nf">enable_sigint_handler</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Enable sigint handler.&quot;&quot;&quot;</span>
    <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGINT</span><span class="p">,</span> <span class="n">sigint_handler</span><span class="p">)</span></div>

<span class="c1"># ---------------------</span>
<span class="c1"># Editor mode functions</span>
<span class="c1"># ---------------------</span>


<div class="viewcode-block" id="get_system_editor"><a class="viewcode-back" href="../source/buku.html#buku.get_system_editor">[docs]</a><span class="k">def</span> <span class="nf">get_system_editor</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Returns default system editor is $EDITOR is set&quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;EDITOR&#39;</span><span class="p">,</span> <span class="s1">&#39;none&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="is_editor_valid"><a class="viewcode-back" href="../source/buku.html#buku.is_editor_valid">[docs]</a><span class="k">def</span> <span class="nf">is_editor_valid</span><span class="p">(</span><span class="n">editor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Check if the editor string is valid</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    editor : str</span>
<span class="sd">        Editor string.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    bool</span>
<span class="sd">        True if string is valid, else False.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">editor</span> <span class="o">==</span> <span class="s1">&#39;none&#39;</span><span class="p">:</span>
        <span class="n">logerr</span><span class="p">(</span><span class="s1">&#39;EDITOR is not set&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="n">editor</span> <span class="o">==</span> <span class="s1">&#39;0&#39;</span><span class="p">:</span>
        <span class="n">logerr</span><span class="p">(</span><span class="s1">&#39;Cannot edit index 0&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="to_temp_file_content"><a class="viewcode-back" href="../source/buku.html#buku.to_temp_file_content">[docs]</a><span class="k">def</span> <span class="nf">to_temp_file_content</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">title_in</span><span class="p">,</span> <span class="n">tags_in</span><span class="p">,</span> <span class="n">desc</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Generate temporary file content string</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    url : str</span>
<span class="sd">        URL to open.</span>
<span class="sd">    title_in : str</span>
<span class="sd">        Title to add manually.</span>
<span class="sd">    tags_in : str</span>
<span class="sd">        Comma-separated tags to add manually.</span>
<span class="sd">    desc : str</span>
<span class="sd">        String description.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        Lines as newline separated string.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">strings</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;# Lines beginning with &quot;#&quot; will be stripped.</span><span class="se">\n</span><span class="s1">&#39;</span>
                <span class="s1">&#39;# Add URL in next line (single line).&#39;</span><span class="p">),</span> <span class="p">]</span>

    <span class="c1"># URL</span>
    <span class="k">if</span> <span class="n">url</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">strings</span> <span class="o">+=</span> <span class="p">(</span><span class="n">url</span><span class="p">,)</span>

    <span class="c1"># TITLE</span>
    <span class="n">strings</span> <span class="o">+=</span> <span class="p">((</span><span class="s1">&#39;# Add TITLE in next line (single line). Leave blank to web fetch, &quot;-&quot; for no title.&#39;</span><span class="p">),)</span>
    <span class="k">if</span> <span class="n">title_in</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">title_in</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">elif</span> <span class="n">title_in</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="n">title_in</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span>
    <span class="n">strings</span> <span class="o">+=</span> <span class="p">(</span><span class="n">title_in</span><span class="p">,)</span>

    <span class="c1"># TAGS</span>
    <span class="n">strings</span> <span class="o">+=</span> <span class="p">(</span><span class="s1">&#39;# Add comma-separated TAGS in next line (single line).&#39;</span><span class="p">,)</span>
    <span class="n">strings</span> <span class="o">+=</span> <span class="p">(</span><span class="n">tags_in</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="n">DELIM</span><span class="p">),)</span> <span class="k">if</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>

    <span class="c1"># DESC</span>
    <span class="n">strings</span> <span class="o">+=</span> <span class="p">(</span><span class="s1">&#39;# Add COMMENTS in next line(s).&#39;</span><span class="p">,)</span>
    <span class="k">if</span> <span class="n">desc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">desc</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="n">strings</span> <span class="o">+=</span> <span class="p">(</span><span class="n">desc</span><span class="p">,)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">strings</span> <span class="o">+=</span> <span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,)</span>
    <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">strings</span><span class="p">)</span></div>


<div class="viewcode-block" id="parse_temp_file_content"><a class="viewcode-back" href="../source/buku.html#buku.parse_temp_file_content">[docs]</a><span class="k">def</span> <span class="nf">parse_temp_file_content</span><span class="p">(</span><span class="n">content</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Parse and return temporary file content.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    content : str</span>
<span class="sd">        String of content</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple</span>
<span class="sd">        (url, title, tags, comments)</span>

<span class="sd">        url: URL to open</span>
<span class="sd">        title: string title to add manually</span>
<span class="sd">        tags: string of comma-separated tags to add manually</span>
<span class="sd">        comments: string description</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">content</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">content</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">content</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">c</span> <span class="ow">or</span> <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;#&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">content</span> <span class="ow">or</span> <span class="n">content</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Edit aborted&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">url</span> <span class="o">=</span> <span class="n">content</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">title</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">content</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">title</span> <span class="o">=</span> <span class="n">content</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">title</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="n">title</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">elif</span> <span class="n">title</span> <span class="o">==</span> <span class="s1">&#39;-&#39;</span><span class="p">:</span>
        <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

    <span class="n">tags</span> <span class="o">=</span> <span class="n">DELIM</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">content</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">tags</span> <span class="o">=</span> <span class="n">parse_tags</span><span class="p">([</span><span class="n">content</span><span class="p">[</span><span class="mi">2</span><span class="p">]])</span>

    <span class="n">comments</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">content</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">comments</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">content</span><span class="p">[</span><span class="mi">3</span><span class="p">:]]</span>
        <span class="c1"># need to remove all empty line that are at the end</span>
        <span class="c1"># and not those in the middle of the text</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">comments</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">comments</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="k">break</span>

        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">comments</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">comments</span> <span class="o">=</span> <span class="n">comments</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">comments</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">comments</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">url</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">tags</span><span class="p">,</span> <span class="n">comments</span></div>


<div class="viewcode-block" id="edit_rec"><a class="viewcode-back" href="../source/buku.html#buku.edit_rec">[docs]</a><span class="k">def</span> <span class="nf">edit_rec</span><span class="p">(</span><span class="n">editor</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">title_in</span><span class="p">,</span> <span class="n">tags_in</span><span class="p">,</span> <span class="n">desc</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Edit a bookmark record</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    editor : str</span>
<span class="sd">        Editor to open.</span>
<span class="sd">    URL : str</span>
<span class="sd">        URL to open.</span>
<span class="sd">    title_in : str</span>
<span class="sd">        Title to add manually.</span>
<span class="sd">    tags_in : str</span>
<span class="sd">        Comma-separated tags to add manually.</span>
<span class="sd">    desc : str</span>
<span class="sd">        Bookmark description.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple</span>
<span class="sd">        Parsed results from parse_temp_file_content().</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">import</span> <span class="nn">tempfile</span>
    <span class="kn">import</span> <span class="nn">subprocess</span>

    <span class="n">temp_file_content</span> <span class="o">=</span> <span class="n">to_temp_file_content</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">title_in</span><span class="p">,</span> <span class="n">tags_in</span><span class="p">,</span> <span class="n">desc</span><span class="p">)</span>

    <span class="n">fd</span><span class="p">,</span> <span class="n">tmpfile</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkstemp</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;buku-edit-&#39;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">tmpfile</span><span class="p">,</span> <span class="s1">&#39;w+&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
            <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">temp_file_content</span><span class="p">)</span>
            <span class="n">fp</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="n">logdbg</span><span class="p">(</span><span class="s1">&#39;Edited content written to </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">tmpfile</span><span class="p">)</span>

        <span class="n">cmd</span> <span class="o">=</span> <span class="n">editor</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
        <span class="n">cmd</span> <span class="o">+=</span> <span class="p">(</span><span class="n">tmpfile</span><span class="p">,)</span>
        <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">tmpfile</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">content</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">tmpfile</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">tmpfile</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">tmpfile</span><span class="p">)</span>
            <span class="n">logerr</span><span class="p">(</span><span class="s1">&#39;Cannot open editor&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logerr</span><span class="p">(</span><span class="s1">&#39;Cannot open tempfile&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">parsed_content</span> <span class="o">=</span> <span class="n">parse_temp_file_content</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">parsed_content</span></div>


<div class="viewcode-block" id="setup_logger"><a class="viewcode-back" href="../source/buku.html#buku.setup_logger">[docs]</a><span class="k">def</span> <span class="nf">setup_logger</span><span class="p">(</span><span class="n">logger</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Setup logger with color.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    logger : logger object</span>
<span class="sd">        Logger to colorize.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">decorate_emit</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">new</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
            <span class="n">levelno</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">levelno</span>

            <span class="k">if</span> <span class="n">levelno</span> <span class="o">==</span> <span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">:</span>
                <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\x1b</span><span class="s1">[35m&#39;</span>
            <span class="k">elif</span> <span class="n">levelno</span> <span class="o">==</span> <span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">:</span>
                <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\x1b</span><span class="s1">[31m&#39;</span>
            <span class="k">elif</span> <span class="n">levelno</span> <span class="o">==</span> <span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">:</span>
                <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\x1b</span><span class="s1">[33m&#39;</span>
            <span class="k">elif</span> <span class="n">levelno</span> <span class="o">==</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">:</span>
                <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\x1b</span><span class="s1">[32m&#39;</span>
            <span class="k">elif</span> <span class="n">levelno</span> <span class="o">==</span> <span class="n">logging</span><span class="o">.</span><span class="n">CRITICAL</span><span class="p">:</span>
                <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\x1b</span><span class="s1">[31m&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\x1b</span><span class="s1">[0m&#39;</span>

            <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">[</span><span class="si">{}</span><span class="s1">]</span><span class="se">\x1b</span><span class="s1">[0m </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">levelname</span><span class="p">,</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">fn</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">new</span>

    <span class="n">sh</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">()</span>
    <span class="n">sh</span><span class="o">.</span><span class="n">emit</span> <span class="o">=</span> <span class="n">decorate_emit</span><span class="p">(</span><span class="n">sh</span><span class="o">.</span><span class="n">emit</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">sh</span><span class="p">)</span></div>


<div class="viewcode-block" id="piped_input"><a class="viewcode-back" href="../source/buku.html#buku.piped_input">[docs]</a><span class="k">def</span> <span class="nf">piped_input</span><span class="p">(</span><span class="n">argv</span><span class="p">,</span> <span class="n">pipeargs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Handle piped input.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    pipeargs : str</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">isatty</span><span class="p">():</span>
        <span class="n">pipeargs</span> <span class="o">+=</span> <span class="n">argv</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;waiting for input&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="p">:</span>
            <span class="n">pipeargs</span> <span class="o">+=</span> <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">()</span></div>


<div class="viewcode-block" id="setcolors"><a class="viewcode-back" href="../source/buku.html#buku.setcolors">[docs]</a><span class="k">def</span> <span class="nf">setcolors</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get colors from user and separate into &#39;result&#39; list for use in arg.colors.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    args : str</span>
<span class="sd">        Color string.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">Colors</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;Colors&#39;</span><span class="p">,</span> <span class="s1">&#39; ID_srch, ID_str, URL_str, DESC_str, TAG_str&#39;</span><span class="p">)</span>
    <span class="n">colors</span> <span class="o">=</span> <span class="n">Colors</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">COLORMAP</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">args</span><span class="p">])</span>
    <span class="n">id_col</span> <span class="o">=</span> <span class="n">colors</span><span class="o">.</span><span class="n">ID_srch</span>
    <span class="n">id_str_col</span> <span class="o">=</span> <span class="n">colors</span><span class="o">.</span><span class="n">ID_str</span>
    <span class="n">url_col</span> <span class="o">=</span> <span class="n">colors</span><span class="o">.</span><span class="n">URL_str</span>
    <span class="n">desc_col</span> <span class="o">=</span> <span class="n">colors</span><span class="o">.</span><span class="n">DESC_str</span>
    <span class="n">tag_col</span> <span class="o">=</span> <span class="n">colors</span><span class="o">.</span><span class="n">TAG_str</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="n">id_col</span><span class="p">,</span> <span class="n">id_str_col</span><span class="p">,</span> <span class="n">url_col</span><span class="p">,</span> <span class="n">desc_col</span><span class="p">,</span> <span class="n">tag_col</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">result</span></div>

<span class="c1"># main starts here</span>
<div class="viewcode-block" id="main"><a class="viewcode-back" href="../source/buku.html#buku.main">[docs]</a><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Main.&quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">ID_str</span><span class="p">,</span> <span class="n">ID_DB_str</span><span class="p">,</span> <span class="n">MUTE_str</span><span class="p">,</span> <span class="n">URL_str</span><span class="p">,</span> <span class="n">DESC_str</span><span class="p">,</span> <span class="n">TAG_str</span><span class="p">,</span> <span class="n">promptmsg</span>

    <span class="n">title_in</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">tags_in</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">desc_in</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">pipeargs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">colorstr_env</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;BUKU_COLORS&#39;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">piped_input</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">,</span> <span class="n">pipeargs</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="c1"># If piped input, set argument vector</span>
    <span class="k">if</span> <span class="n">pipeargs</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">argv</span> <span class="o">=</span> <span class="n">pipeargs</span>

    <span class="c1"># Setup custom argument parser</span>
    <span class="n">argparser</span> <span class="o">=</span> <span class="n">ExtendedArgumentParser</span><span class="p">(</span>
        <span class="n">description</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;Powerful command-line bookmark manager. Your mini web!</span>

<span class="s1">POSITIONAL ARGUMENTS:</span>
<span class="s1">      KEYWORD              search keywords&#39;&#39;&#39;</span><span class="p">,</span>
        <span class="n">formatter_class</span><span class="o">=</span><span class="n">argparse</span><span class="o">.</span><span class="n">RawTextHelpFormatter</span><span class="p">,</span>
        <span class="n">usage</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;buku [OPTIONS] [KEYWORD [KEYWORD ...]]&#39;&#39;&#39;</span><span class="p">,</span>
        <span class="n">add_help</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>
    <span class="n">HIDE</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">SUPPRESS</span>

    <span class="n">argparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;keywords&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;KEYWORD&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="n">HIDE</span><span class="p">)</span>

    <span class="c1"># ---------------------</span>
    <span class="c1"># GENERAL OPTIONS GROUP</span>
    <span class="c1"># ---------------------</span>

    <span class="n">general_grp</span> <span class="o">=</span> <span class="n">argparser</span><span class="o">.</span><span class="n">add_argument_group</span><span class="p">(</span>
        <span class="n">title</span><span class="o">=</span><span class="s1">&#39;GENERAL OPTIONS&#39;</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;    -a, --add URL [tag, ...]</span>
<span class="s1">                         bookmark URL with comma-separated tags</span>
<span class="s1">    -u, --update [...]   update fields of an existing bookmark</span>
<span class="s1">                         accepts indices and ranges</span>
<span class="s1">                         refresh the title, if no edit options</span>
<span class="s1">                         if no arguments:</span>
<span class="s1">                         - update results when used with search</span>
<span class="s1">                         - otherwise refresh all titles</span>
<span class="s1">    -w, --write [editor|index]</span>
<span class="s1">                         open editor to edit a fresh bookmark</span>
<span class="s1">                         to update by index, EDITOR must be set</span>
<span class="s1">    -d, --delete [...]   remove bookmarks from DB</span>
<span class="s1">                         accepts indices or a single range</span>
<span class="s1">                         if no arguments:</span>
<span class="s1">                         - delete results when used with search</span>
<span class="s1">                         - otherwise delete all bookmarks</span>
<span class="s1">    -h, --help           show this information and exit</span>
<span class="s1">    -v, --version        show the program version and exit&#39;&#39;&#39;</span><span class="p">)</span>
    <span class="n">addarg</span> <span class="o">=</span> <span class="n">general_grp</span><span class="o">.</span><span class="n">add_argument</span>
    <span class="n">addarg</span><span class="p">(</span><span class="s1">&#39;-a&#39;</span><span class="p">,</span> <span class="s1">&#39;--add&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="n">HIDE</span><span class="p">)</span>
    <span class="n">addarg</span><span class="p">(</span><span class="s1">&#39;-u&#39;</span><span class="p">,</span> <span class="s1">&#39;--update&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="n">HIDE</span><span class="p">)</span>
    <span class="n">addarg</span><span class="p">(</span><span class="s1">&#39;-w&#39;</span><span class="p">,</span> <span class="s1">&#39;--write&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="n">const</span><span class="o">=</span><span class="n">get_system_editor</span><span class="p">(),</span> <span class="n">help</span><span class="o">=</span><span class="n">HIDE</span><span class="p">)</span>
    <span class="n">addarg</span><span class="p">(</span><span class="s1">&#39;-d&#39;</span><span class="p">,</span> <span class="s1">&#39;--delete&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="n">HIDE</span><span class="p">)</span>
    <span class="n">addarg</span><span class="p">(</span><span class="s1">&#39;-h&#39;</span><span class="p">,</span> <span class="s1">&#39;--help&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="n">HIDE</span><span class="p">)</span>
    <span class="n">addarg</span><span class="p">(</span><span class="s1">&#39;-v&#39;</span><span class="p">,</span> <span class="s1">&#39;--version&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;version&#39;</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="n">__version__</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="n">HIDE</span><span class="p">)</span>

    <span class="c1"># ------------------</span>
    <span class="c1"># EDIT OPTIONS GROUP</span>
    <span class="c1"># ------------------</span>

    <span class="n">edit_grp</span> <span class="o">=</span> <span class="n">argparser</span><span class="o">.</span><span class="n">add_argument_group</span><span class="p">(</span>
        <span class="n">title</span><span class="o">=</span><span class="s1">&#39;EDIT OPTIONS&#39;</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;    --url keyword        bookmark link</span>
<span class="s1">    --tag [+|-] [...]    comma-separated tags</span>
<span class="s1">                         clear bookmark tagset, if no arguments</span>
<span class="s1">                         &#39;+&#39; appends to, &#39;-&#39; removes from tagset</span>
<span class="s1">    --title [...]        bookmark title; if no arguments:</span>
<span class="s1">                         -a: do not set title, -u: clear title</span>
<span class="s1">    -c, --comment [...]  notes or description of the bookmark</span>
<span class="s1">                         clears description, if no arguments</span>
<span class="s1">    --immutable N        disable title fetch from web on update</span>
<span class="s1">                         N=0: mutable (default), N=1: immutable&#39;&#39;&#39;</span><span class="p">)</span>
    <span class="n">addarg</span> <span class="o">=</span> <span class="n">edit_grp</span><span class="o">.</span><span class="n">add_argument</span>
    <span class="n">addarg</span><span class="p">(</span><span class="s1">&#39;--url&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="n">HIDE</span><span class="p">)</span>
    <span class="n">addarg</span><span class="p">(</span><span class="s1">&#39;--tag&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="n">HIDE</span><span class="p">)</span>
    <span class="n">addarg</span><span class="p">(</span><span class="s1">&#39;--title&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="n">HIDE</span><span class="p">)</span>
    <span class="n">addarg</span><span class="p">(</span><span class="s1">&#39;-c&#39;</span><span class="p">,</span> <span class="s1">&#39;--comment&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="n">HIDE</span><span class="p">)</span>
    <span class="n">addarg</span><span class="p">(</span><span class="s1">&#39;--immutable&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span> <span class="n">help</span><span class="o">=</span><span class="n">HIDE</span><span class="p">)</span>

    <span class="c1"># --------------------</span>
    <span class="c1"># SEARCH OPTIONS GROUP</span>
    <span class="c1"># --------------------</span>

    <span class="n">search_grp</span> <span class="o">=</span> <span class="n">argparser</span><span class="o">.</span><span class="n">add_argument_group</span><span class="p">(</span>
        <span class="n">title</span><span class="o">=</span><span class="s1">&#39;SEARCH OPTIONS&#39;</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;    -s, --sany           find records with ANY matching keyword</span>
<span class="s1">                         this is the default search option</span>
<span class="s1">    -S, --sall           find records matching ALL the keywords</span>
<span class="s1">                         special keywords -</span>
<span class="s1">                         &quot;blank&quot;: entries with empty title/tag</span>
<span class="s1">                         &quot;immutable&quot;: entries with locked title</span>
<span class="s1">    --deep               match substrings (&#39;pen&#39; matches &#39;opens&#39;)</span>
<span class="s1">    -r, --sreg           run a regex search</span>
<span class="s1">    -t, --stag [tag [,|+] ...] [- tag, ...]</span>
<span class="s1">                         search bookmarks by tags</span>
<span class="s1">                         use &#39;,&#39; to find entries matching ANY tag</span>
<span class="s1">                         use &#39;+&#39; to find entries matching ALL tags</span>
<span class="s1">                         excludes entries matching tags following &#39; - &#39;</span>
<span class="s1">                         list all tags, if no search keywords&#39;&#39;&#39;</span><span class="p">)</span>
    <span class="n">addarg</span> <span class="o">=</span> <span class="n">search_grp</span><span class="o">.</span><span class="n">add_argument</span>
    <span class="n">addarg</span><span class="p">(</span><span class="s1">&#39;-s&#39;</span><span class="p">,</span> <span class="s1">&#39;--sany&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="n">HIDE</span><span class="p">)</span>
    <span class="n">addarg</span><span class="p">(</span><span class="s1">&#39;-S&#39;</span><span class="p">,</span> <span class="s1">&#39;--sall&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="n">HIDE</span><span class="p">)</span>
    <span class="n">addarg</span><span class="p">(</span><span class="s1">&#39;-r&#39;</span><span class="p">,</span> <span class="s1">&#39;--sreg&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="n">HIDE</span><span class="p">)</span>
    <span class="n">addarg</span><span class="p">(</span><span class="s1">&#39;--deep&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="n">HIDE</span><span class="p">)</span>
    <span class="n">addarg</span><span class="p">(</span><span class="s1">&#39;-t&#39;</span><span class="p">,</span> <span class="s1">&#39;--stag&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="n">HIDE</span><span class="p">)</span>

    <span class="c1"># ------------------------</span>
    <span class="c1"># ENCRYPTION OPTIONS GROUP</span>
    <span class="c1"># ------------------------</span>

    <span class="n">crypto_grp</span> <span class="o">=</span> <span class="n">argparser</span><span class="o">.</span><span class="n">add_argument_group</span><span class="p">(</span>
        <span class="n">title</span><span class="o">=</span><span class="s1">&#39;ENCRYPTION OPTIONS&#39;</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;    -l, --lock [N]       encrypt DB file with N (&gt; 0, default 8)</span>
<span class="s1">                         hash iterations to generate key</span>
<span class="s1">    -k, --unlock [N]     decrypt DB file with N (&gt; 0, default 8)</span>
<span class="s1">                         hash iterations to generate key&#39;&#39;&#39;</span><span class="p">)</span>
    <span class="n">addarg</span> <span class="o">=</span> <span class="n">crypto_grp</span><span class="o">.</span><span class="n">add_argument</span>
    <span class="n">addarg</span><span class="p">(</span><span class="s1">&#39;-k&#39;</span><span class="p">,</span> <span class="s1">&#39;--unlock&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">const</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="n">HIDE</span><span class="p">)</span>
    <span class="n">addarg</span><span class="p">(</span><span class="s1">&#39;-l&#39;</span><span class="p">,</span> <span class="s1">&#39;--lock&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">const</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="n">HIDE</span><span class="p">)</span>

    <span class="c1"># ----------------</span>
    <span class="c1"># POWER TOYS GROUP</span>
    <span class="c1"># ----------------</span>

    <span class="n">power_grp</span> <span class="o">=</span> <span class="n">argparser</span><span class="o">.</span><span class="n">add_argument_group</span><span class="p">(</span>
        <span class="n">title</span><span class="o">=</span><span class="s1">&#39;POWER TOYS&#39;</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;    --ai                 auto-import from Firefox and Chrome</span>
<span class="s1">    -e, --export file    export bookmarks in Firefox format html</span>
<span class="s1">                         export markdown, if file ends with &#39;.md&#39;</span>
<span class="s1">                         format: [title](url), 1 entry per line</span>
<span class="s1">                         use --tag to export only specific tags</span>
<span class="s1">    -i, --import file    import Firefox or Chrome bookmarks html</span>
<span class="s1">                         import markdown, if file ends with &#39;.md&#39;</span>
<span class="s1">    -m, --merge file     add bookmarks from another buku DB file</span>
<span class="s1">    -p, --print [...]    show record details by indices, ranges</span>
<span class="s1">                         print all bookmarks, if no arguments</span>
<span class="s1">                         -n shows the last n results (like tail)</span>
<span class="s1">    -f, --format N       limit fields in -p or Json search output</span>
<span class="s1">                         N=1: URL, N=2: URL and tag, N=3: title,</span>
<span class="s1">                         N=4: URL, title and tag</span>
<span class="s1">    -j, --json           Json formatted output for -p and search</span>
<span class="s1">    --colors COLORS      set output colors in five-letter string</span>
<span class="s1">    --nc                 disable color output</span>
<span class="s1">    --np                 do not show the prompt, run and exit</span>
<span class="s1">    -o, --open [...]     browse bookmarks by indices and ranges</span>
<span class="s1">                         open a random bookmark, if no arguments</span>
<span class="s1">    --oa                 browse all search results immediately</span>
<span class="s1">    --replace old new    replace old tag with new tag everywhere</span>
<span class="s1">                         delete old tag, if new tag not specified</span>
<span class="s1">    --shorten index|URL  fetch shortened url from tny.im service</span>
<span class="s1">    --expand index|URL   expand a tny.im shortened url</span>
<span class="s1">    --suggest            show similar tags when adding bookmarks</span>
<span class="s1">    --tacit              reduce verbosity</span>
<span class="s1">    --threads N          max network connections in full refresh</span>
<span class="s1">                         default N=4, min N=1, max N=10</span>
<span class="s1">    -V                   check latest upstream version available</span>
<span class="s1">    -z, --debug          show debug information and verbose logs&#39;&#39;&#39;</span><span class="p">)</span>
    <span class="n">addarg</span> <span class="o">=</span> <span class="n">power_grp</span><span class="o">.</span><span class="n">add_argument</span>
    <span class="n">addarg</span><span class="p">(</span><span class="s1">&#39;--ai&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="n">HIDE</span><span class="p">)</span>
    <span class="n">addarg</span><span class="p">(</span><span class="s1">&#39;-e&#39;</span><span class="p">,</span> <span class="s1">&#39;--export&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="n">HIDE</span><span class="p">)</span>
    <span class="n">addarg</span><span class="p">(</span><span class="s1">&#39;-i&#39;</span><span class="p">,</span> <span class="s1">&#39;--import&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;importfile&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="n">HIDE</span><span class="p">)</span>
    <span class="n">addarg</span><span class="p">(</span><span class="s1">&#39;-m&#39;</span><span class="p">,</span> <span class="s1">&#39;--merge&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="n">HIDE</span><span class="p">)</span>
    <span class="n">addarg</span><span class="p">(</span><span class="s1">&#39;-p&#39;</span><span class="p">,</span> <span class="s1">&#39;--print&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="n">HIDE</span><span class="p">)</span>
    <span class="n">addarg</span><span class="p">(</span><span class="s1">&#39;-f&#39;</span><span class="p">,</span> <span class="s1">&#39;--format&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">},</span> <span class="n">help</span><span class="o">=</span><span class="n">HIDE</span><span class="p">)</span>
    <span class="n">addarg</span><span class="p">(</span><span class="s1">&#39;-j&#39;</span><span class="p">,</span> <span class="s1">&#39;--json&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="n">HIDE</span><span class="p">)</span>
    <span class="n">addarg</span><span class="p">(</span><span class="s1">&#39;--colors&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;colorstr&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">argparser</span><span class="o">.</span><span class="n">is_colorstr</span><span class="p">,</span>
           <span class="n">default</span><span class="o">=</span><span class="n">colorstr_env</span> <span class="k">if</span> <span class="n">colorstr_env</span> <span class="k">else</span> <span class="s1">&#39;oKlxm&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;COLORS&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="n">HIDE</span><span class="p">)</span>
    <span class="n">addarg</span><span class="p">(</span><span class="s1">&#39;--nc&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="n">HIDE</span><span class="p">)</span>
    <span class="n">addarg</span><span class="p">(</span><span class="s1">&#39;--np&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="n">HIDE</span><span class="p">)</span>
    <span class="n">addarg</span><span class="p">(</span><span class="s1">&#39;-o&#39;</span><span class="p">,</span> <span class="s1">&#39;--open&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="n">HIDE</span><span class="p">)</span>
    <span class="n">addarg</span><span class="p">(</span><span class="s1">&#39;--oa&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="n">HIDE</span><span class="p">)</span>
    <span class="n">addarg</span><span class="p">(</span><span class="s1">&#39;--replace&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="n">HIDE</span><span class="p">)</span>
    <span class="n">addarg</span><span class="p">(</span><span class="s1">&#39;--shorten&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="n">HIDE</span><span class="p">)</span>
    <span class="n">addarg</span><span class="p">(</span><span class="s1">&#39;--expand&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="n">HIDE</span><span class="p">)</span>
    <span class="n">addarg</span><span class="p">(</span><span class="s1">&#39;--suggest&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="n">HIDE</span><span class="p">)</span>
    <span class="n">addarg</span><span class="p">(</span><span class="s1">&#39;--tacit&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="n">HIDE</span><span class="p">)</span>
    <span class="n">addarg</span><span class="p">(</span><span class="s1">&#39;--threads&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">),</span> <span class="n">help</span><span class="o">=</span><span class="n">HIDE</span><span class="p">)</span>
    <span class="n">addarg</span><span class="p">(</span><span class="s1">&#39;-V&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;upstream&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="n">HIDE</span><span class="p">)</span>
    <span class="n">addarg</span><span class="p">(</span><span class="s1">&#39;-z&#39;</span><span class="p">,</span> <span class="s1">&#39;--debug&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="n">HIDE</span><span class="p">)</span>
    <span class="c1"># Undocumented APIs</span>
    <span class="n">addarg</span><span class="p">(</span><span class="s1">&#39;--fixtags&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="n">HIDE</span><span class="p">)</span>
    <span class="n">addarg</span><span class="p">(</span><span class="s1">&#39;--db&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="n">HIDE</span><span class="p">)</span>

    <span class="c1"># Show help and exit if no arguments</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">argparser</span><span class="o">.</span><span class="n">print_help</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Parse the arguments</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">argparser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

    <span class="c1"># Show help and exit if help requested</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">help</span><span class="p">:</span>
        <span class="n">argparser</span><span class="o">.</span><span class="n">print_help</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Handle color output preference</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">nc</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="nb">format</span><span class="o">=</span><span class="s1">&#39;[</span><span class="si">%(levelname)s</span><span class="s1">] </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Set colors</span>
        <span class="n">ID</span> <span class="o">=</span> <span class="n">setcolors</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">colorstr</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="si">%d</span><span class="s1">. &#39;</span> <span class="o">+</span> <span class="n">COLORMAP</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span>
        <span class="n">ID_DB_dim</span> <span class="o">=</span> <span class="n">COLORMAP</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;[</span><span class="si">%s</span><span class="s1">]</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">COLORMAP</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span>
        <span class="n">ID_str</span> <span class="o">=</span> <span class="n">ID</span> <span class="o">+</span> <span class="n">setcolors</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">colorstr</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> &#39;</span> <span class="o">+</span> <span class="n">COLORMAP</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">ID_DB_dim</span>
        <span class="n">ID_DB_str</span> <span class="o">=</span> <span class="n">ID</span> <span class="o">+</span> <span class="n">setcolors</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">colorstr</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">COLORMAP</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span>
        <span class="n">MUTE_str</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> </span><span class="se">\x1b</span><span class="s1">[2m(L)</span><span class="se">\x1b</span><span class="s1">[0m</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">URL_str</span> <span class="o">=</span> <span class="n">COLORMAP</span><span class="p">[</span><span class="s1">&#39;j&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;   &gt; &#39;</span> <span class="o">+</span> <span class="n">setcolors</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">colorstr</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">COLORMAP</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span>
        <span class="n">DESC_str</span> <span class="o">=</span> <span class="n">COLORMAP</span><span class="p">[</span><span class="s1">&#39;j&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;   + &#39;</span> <span class="o">+</span> <span class="n">setcolors</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">colorstr</span><span class="p">)[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">COLORMAP</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span>
        <span class="n">TAG_str</span> <span class="o">=</span> <span class="n">COLORMAP</span><span class="p">[</span><span class="s1">&#39;j&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;   # &#39;</span> <span class="o">+</span> <span class="n">setcolors</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">colorstr</span><span class="p">)[</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">COLORMAP</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span>

        <span class="c1"># Enable color in logs</span>
        <span class="n">setup_logger</span><span class="p">(</span><span class="n">logger</span><span class="p">)</span>

        <span class="c1"># Enable prompt with reverse video</span>
        <span class="n">promptmsg</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\x1b</span><span class="s1">[7mbuku (? for help)</span><span class="se">\x1b</span><span class="s1">[0m &#39;</span>

    <span class="c1"># Set up debugging</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
        <span class="n">logdbg</span><span class="p">(</span><span class="s1">&#39;Version </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">__version__</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">disable</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">)</span>
        <span class="n">urllib3</span><span class="o">.</span><span class="n">disable_warnings</span><span class="p">()</span>

    <span class="c1"># Handle encrypt/decrypt options at top priority</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">lock</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">BukuCrypt</span><span class="o">.</span><span class="n">encrypt_file</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">lock</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">unlock</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">BukuCrypt</span><span class="o">.</span><span class="n">decrypt_file</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">unlock</span><span class="p">)</span>

    <span class="c1"># Set up title</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">title</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">title</span><span class="p">:</span>
            <span class="n">title_in</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">title</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">title_in</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

    <span class="c1"># Set up tags</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">tag</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">tag</span><span class="p">:</span>
            <span class="n">tags_in</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">tag</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tags_in</span> <span class="o">=</span> <span class="p">[</span><span class="n">DELIM</span><span class="p">,</span> <span class="p">]</span>

    <span class="c1"># Set up comment</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">comment</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">comment</span><span class="p">:</span>
            <span class="n">desc_in</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">comment</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">desc_in</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

    <span class="c1"># Initialize the database and get handles, set verbose by default</span>
    <span class="n">bdb</span> <span class="o">=</span> <span class="n">BukuDb</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">json</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">format</span><span class="p">,</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">tacit</span><span class="p">,</span> <span class="n">dbfile</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">db</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span> <span class="n">colorize</span><span class="o">=</span><span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">nc</span><span class="p">)</span>

    <span class="c1"># Editor mode</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">write</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_editor_valid</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">write</span><span class="p">):</span>
            <span class="n">bdb</span><span class="o">.</span><span class="n">close_quit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">is_int</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">write</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">bdb</span><span class="o">.</span><span class="n">edit_update_rec</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">write</span><span class="p">),</span> <span class="n">args</span><span class="o">.</span><span class="n">immutable</span><span class="p">):</span>
                <span class="n">bdb</span><span class="o">.</span><span class="n">close_quit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">add</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Edit and add a new bookmark</span>
            <span class="c1"># Parse tags into a comma-separated string</span>
            <span class="k">if</span> <span class="n">tags_in</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">tags_in</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;+&#39;</span><span class="p">:</span>
                    <span class="n">tags</span> <span class="o">=</span> <span class="s1">&#39;+&#39;</span> <span class="o">+</span> <span class="n">parse_tags</span><span class="p">(</span><span class="n">tags_in</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
                <span class="k">elif</span> <span class="n">tags_in</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;-&#39;</span><span class="p">:</span>
                    <span class="n">tags</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="n">parse_tags</span><span class="p">(</span><span class="n">tags_in</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">tags</span> <span class="o">=</span> <span class="n">parse_tags</span><span class="p">(</span><span class="n">tags_in</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tags</span> <span class="o">=</span> <span class="n">DELIM</span>

            <span class="n">result</span> <span class="o">=</span> <span class="n">edit_rec</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">write</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">title_in</span><span class="p">,</span> <span class="n">tags</span><span class="p">,</span> <span class="n">desc_in</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">url</span><span class="p">,</span> <span class="n">title_in</span><span class="p">,</span> <span class="n">tags</span><span class="p">,</span> <span class="n">desc_in</span> <span class="o">=</span> <span class="n">result</span>
                <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">suggest</span><span class="p">:</span>
                    <span class="n">tags</span> <span class="o">=</span> <span class="n">bdb</span><span class="o">.</span><span class="n">suggest_similar_tag</span><span class="p">(</span><span class="n">tags</span><span class="p">)</span>
                <span class="n">bdb</span><span class="o">.</span><span class="n">add_rec</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">title_in</span><span class="p">,</span> <span class="n">tags</span><span class="p">,</span> <span class="n">desc_in</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">immutable</span><span class="p">)</span>

    <span class="c1"># Add record</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">add</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">url</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">args</span><span class="o">.</span><span class="n">update</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logerr</span><span class="p">(</span><span class="s1">&#39;Bookmark a single URL at a time&#39;</span><span class="p">)</span>
            <span class="n">bdb</span><span class="o">.</span><span class="n">close_quit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Parse tags into a comma-separated string</span>
        <span class="n">tags</span> <span class="o">=</span> <span class="n">DELIM</span>
        <span class="n">keywords</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">add</span>
        <span class="k">if</span> <span class="n">tags_in</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">tags_in</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;+&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tags_in</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="c1"># The case: buku -a url tag1, tag2 --tag + tag3, tag4</span>
                    <span class="n">tags_in</span> <span class="o">=</span> <span class="n">tags_in</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                    <span class="c1"># In case of add, args.add may have URL followed by tags</span>
                    <span class="c1"># Add delimiter as url+tags may not end with one</span>
                    <span class="n">keywords</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">add</span> <span class="o">+</span> <span class="p">[</span><span class="n">DELIM</span><span class="p">]</span> <span class="o">+</span> <span class="n">tags_in</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">keywords</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">add</span> <span class="o">+</span> <span class="p">[</span><span class="n">DELIM</span><span class="p">]</span> <span class="o">+</span> <span class="n">tags_in</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">keywords</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">tags</span> <span class="o">=</span> <span class="n">parse_tags</span><span class="p">(</span><span class="n">keywords</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>

        <span class="n">url</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">add</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">write</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_int</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">write</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">edit_rec</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">write</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">title_in</span><span class="p">,</span> <span class="n">tags</span><span class="p">,</span> <span class="n">desc_in</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">url</span><span class="p">,</span> <span class="n">title_in</span><span class="p">,</span> <span class="n">tags</span><span class="p">,</span> <span class="n">desc_in</span> <span class="o">=</span> <span class="n">result</span>

        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">suggest</span><span class="p">:</span>
            <span class="n">tags</span> <span class="o">=</span> <span class="n">bdb</span><span class="o">.</span><span class="n">suggest_similar_tag</span><span class="p">(</span><span class="n">tags</span><span class="p">)</span>
        <span class="n">bdb</span><span class="o">.</span><span class="n">add_rec</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">title_in</span><span class="p">,</span> <span class="n">tags</span><span class="p">,</span> <span class="n">desc_in</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">immutable</span><span class="p">)</span>

    <span class="c1"># Search record</span>
    <span class="n">search_results</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">search_opted</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">update_search_results</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">sany</span><span class="p">:</span>
        <span class="c1"># Search URLs, titles, tags for any keyword</span>
        <span class="n">search_results</span> <span class="o">=</span> <span class="n">bdb</span><span class="o">.</span><span class="n">searchdb</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">keywords</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">deep</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">sall</span><span class="p">:</span>
        <span class="c1"># Search URLs, titles, tags with all keywords</span>
        <span class="n">search_results</span> <span class="o">=</span> <span class="n">bdb</span><span class="o">.</span><span class="n">searchdb</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">keywords</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">deep</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">sreg</span><span class="p">:</span>
        <span class="c1"># Run a regular expression search</span>
        <span class="n">search_results</span> <span class="o">=</span> <span class="n">bdb</span><span class="o">.</span><span class="n">searchdb</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">keywords</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">stag</span><span class="p">:</span>
        <span class="c1"># Search bookmarks by tag</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">keywords</span><span class="p">:</span>
            <span class="n">search_results</span> <span class="o">=</span> <span class="n">bdb</span><span class="o">.</span><span class="n">search_by_tag</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">keywords</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Use sub prompt to list all tags</span>
            <span class="n">prompt</span><span class="p">(</span><span class="n">bdb</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">np</span><span class="p">,</span> <span class="n">subprompt</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">keywords</span><span class="p">:</span>
        <span class="n">search_results</span> <span class="o">=</span> <span class="n">bdb</span><span class="o">.</span><span class="n">searchdb</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">keywords</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">deep</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">search_opted</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># Add cmdline search options to readline history</span>
    <span class="k">if</span> <span class="n">search_opted</span> <span class="ow">and</span> <span class="n">args</span><span class="o">.</span><span class="n">keywords</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">readline</span><span class="o">.</span><span class="n">add_history</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">keywords</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">if</span> <span class="n">search_results</span><span class="p">:</span>
        <span class="n">oneshot</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">np</span>
        <span class="n">to_delete</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Open all results in browser right away if args.oa</span>
        <span class="c1"># is specified. The has priority over delete/update.</span>
        <span class="c1"># URLs are opened first and updated/deleted later.</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">oa</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">search_results</span><span class="p">:</span>
                <span class="n">browse</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="c1"># In case of search and delete/update,</span>
        <span class="c1"># prompt should be non-interactive</span>
        <span class="c1"># delete gets priority over update</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">delete</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">delete</span><span class="p">:</span>
            <span class="n">oneshot</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">to_delete</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">update</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">update</span><span class="p">:</span>
            <span class="n">oneshot</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">update_search_results</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">json</span><span class="p">:</span>
            <span class="n">prompt</span><span class="p">(</span><span class="n">bdb</span><span class="p">,</span> <span class="n">search_results</span><span class="p">,</span> <span class="n">oneshot</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">deep</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Printing in Json format is non-interactive</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">format_json</span><span class="p">(</span><span class="n">search_results</span><span class="p">,</span> <span class="n">field_filter</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">format</span><span class="p">))</span>

        <span class="c1"># Delete search results if opted</span>
        <span class="k">if</span> <span class="n">to_delete</span><span class="p">:</span>
            <span class="n">bdb</span><span class="o">.</span><span class="n">delete_resultset</span><span class="p">(</span><span class="n">search_results</span><span class="p">)</span>

    <span class="c1"># Update record</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">update</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">url</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">url_in</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">url</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">url_in</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

        <span class="c1"># Parse tags into a comma-separated string</span>
        <span class="k">if</span> <span class="n">tags_in</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">tags_in</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;+&#39;</span><span class="p">:</span>
                <span class="n">tags</span> <span class="o">=</span> <span class="s1">&#39;+&#39;</span> <span class="o">+</span> <span class="n">parse_tags</span><span class="p">(</span><span class="n">tags_in</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
            <span class="k">elif</span> <span class="n">tags_in</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;-&#39;</span><span class="p">:</span>
                <span class="n">tags</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="n">parse_tags</span><span class="p">(</span><span class="n">tags_in</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tags</span> <span class="o">=</span> <span class="n">parse_tags</span><span class="p">(</span><span class="n">tags_in</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tags</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># No arguments to --update, update all</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">update</span><span class="p">:</span>
            <span class="c1"># Update all records only if search was not opted</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">search_opted</span><span class="p">:</span>
                <span class="n">bdb</span><span class="o">.</span><span class="n">update_rec</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">url_in</span><span class="p">,</span> <span class="n">title_in</span><span class="p">,</span> <span class="n">tags</span><span class="p">,</span> <span class="n">desc_in</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">immutable</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">threads</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">update_search_results</span> <span class="ow">and</span> <span class="n">search_results</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">tacit</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Updated results:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

                <span class="n">pos</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">search_results</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="k">while</span> <span class="n">pos</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">idx</span> <span class="o">=</span> <span class="n">search_results</span><span class="p">[</span><span class="n">pos</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">bdb</span><span class="o">.</span><span class="n">update_rec</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">url_in</span><span class="p">,</span> <span class="n">title_in</span><span class="p">,</span> <span class="n">tags</span><span class="p">,</span> <span class="n">desc_in</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">immutable</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">threads</span><span class="p">)</span>

                    <span class="c1"># Commit at every 200th removal</span>
                    <span class="k">if</span> <span class="n">pos</span> <span class="o">%</span> <span class="mi">200</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">bdb</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

                    <span class="n">pos</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">args</span><span class="o">.</span><span class="n">update</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">is_int</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
                    <span class="n">bdb</span><span class="o">.</span><span class="n">update_rec</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">idx</span><span class="p">),</span> <span class="n">url_in</span><span class="p">,</span> <span class="n">title_in</span><span class="p">,</span> <span class="n">tags</span><span class="p">,</span> <span class="n">desc_in</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">immutable</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">threads</span><span class="p">)</span>
                <span class="k">elif</span> <span class="s1">&#39;-&#39;</span> <span class="ow">in</span> <span class="n">idx</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">vals</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">idx</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)]</span>
                        <span class="k">if</span> <span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">vals</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                            <span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vals</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                        <span class="c1"># Update only once if range starts from 0 (all)</span>
                        <span class="k">if</span> <span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">bdb</span><span class="o">.</span><span class="n">update_rec</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">url_in</span><span class="p">,</span> <span class="n">title_in</span><span class="p">,</span> <span class="n">tags</span><span class="p">,</span> <span class="n">desc_in</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">immutable</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">threads</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">_id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vals</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                                <span class="n">bdb</span><span class="o">.</span><span class="n">update_rec</span><span class="p">(</span><span class="n">_id</span><span class="p">,</span> <span class="n">url_in</span><span class="p">,</span> <span class="n">title_in</span><span class="p">,</span> <span class="n">tags</span><span class="p">,</span> <span class="n">desc_in</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">immutable</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">threads</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">interrupted</span><span class="p">:</span>
                                    <span class="k">break</span>
                    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                        <span class="n">logerr</span><span class="p">(</span><span class="s1">&#39;Invalid index or range to update&#39;</span><span class="p">)</span>
                        <span class="n">bdb</span><span class="o">.</span><span class="n">close_quit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">interrupted</span><span class="p">:</span>
                    <span class="k">break</span>

    <span class="c1"># Delete record</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">delete</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">delete</span><span class="p">:</span>
            <span class="c1"># Attempt delete-all only if search was not opted</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">search_opted</span><span class="p">:</span>
                <span class="n">bdb</span><span class="o">.</span><span class="n">cleardb</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">delete</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="s1">&#39;-&#39;</span> <span class="ow">in</span> <span class="n">args</span><span class="o">.</span><span class="n">delete</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">vals</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">args</span><span class="o">.</span><span class="n">delete</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">bdb</span><span class="o">.</span><span class="n">delete_rec</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vals</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="kc">True</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">logerr</span><span class="p">(</span><span class="s1">&#39;Invalid index or range to delete&#39;</span><span class="p">)</span>
                <span class="n">bdb</span><span class="o">.</span><span class="n">close_quit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ids</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c1"># Select the unique indices</span>
            <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">args</span><span class="o">.</span><span class="n">delete</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">idx</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">:</span>
                    <span class="n">ids</span> <span class="o">+=</span> <span class="p">(</span><span class="n">idx</span><span class="p">,)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Index delete order - highest to lowest</span>
                <span class="n">ids</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">:</span>
                    <span class="n">bdb</span><span class="o">.</span><span class="n">delete_rec</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">logerr</span><span class="p">(</span><span class="s1">&#39;Invalid index or range or combination&#39;</span><span class="p">)</span>
                <span class="n">bdb</span><span class="o">.</span><span class="n">close_quit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Print record</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">print</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">print</span><span class="p">:</span>
            <span class="n">bdb</span><span class="o">.</span><span class="n">print_rec</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">args</span><span class="o">.</span><span class="n">print</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">is_int</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
                        <span class="n">bdb</span><span class="o">.</span><span class="n">print_rec</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>
                    <span class="k">elif</span> <span class="s1">&#39;-&#39;</span> <span class="ow">in</span> <span class="n">idx</span><span class="p">:</span>
                        <span class="n">vals</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">idx</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)]</span>
                        <span class="n">bdb</span><span class="o">.</span><span class="n">print_rec</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vals</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="kc">True</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">logerr</span><span class="p">(</span><span class="s1">&#39;Invalid index or range to print&#39;</span><span class="p">)</span>
                <span class="n">bdb</span><span class="o">.</span><span class="n">close_quit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Replace a tag in DB</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">replace</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">replace</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">bdb</span><span class="o">.</span><span class="n">delete_tag_at_index</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">replace</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">bdb</span><span class="o">.</span><span class="n">replace_tag</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">replace</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">args</span><span class="o">.</span><span class="n">replace</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>

    <span class="c1"># Export bookmarks</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">export</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">tag</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">bdb</span><span class="o">.</span><span class="n">exportdb</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">export</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">tag</span><span class="p">:</span>
            <span class="n">logerr</span><span class="p">(</span><span class="s1">&#39;Missing tag&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">bdb</span><span class="o">.</span><span class="n">exportdb</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">export</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">args</span><span class="o">.</span><span class="n">tag</span><span class="p">)</span>

    <span class="c1"># Import bookmarks</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">importfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">bdb</span><span class="o">.</span><span class="n">importdb</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">importfile</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">args</span><span class="o">.</span><span class="n">tacit</span><span class="p">)</span>

    <span class="c1"># Import bookmarks from browser</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">ai</span><span class="p">:</span>
        <span class="n">bdb</span><span class="o">.</span><span class="n">auto_import_from_browser</span><span class="p">()</span>

    <span class="c1"># Merge a database file and exit</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">merge</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">bdb</span><span class="o">.</span><span class="n">mergedb</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">merge</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="c1"># Open URL in browser</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">open</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">open</span><span class="p">:</span>
            <span class="n">bdb</span><span class="o">.</span><span class="n">browse_by_index</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">args</span><span class="o">.</span><span class="n">open</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">is_int</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
                        <span class="n">bdb</span><span class="o">.</span><span class="n">browse_by_index</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>
                    <span class="k">elif</span> <span class="s1">&#39;-&#39;</span> <span class="ow">in</span> <span class="n">idx</span><span class="p">:</span>
                        <span class="n">vals</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">idx</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)]</span>
                        <span class="n">bdb</span><span class="o">.</span><span class="n">browse_by_index</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vals</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="kc">True</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">logerr</span><span class="p">(</span><span class="s1">&#39;Invalid index or range to open&#39;</span><span class="p">)</span>
                <span class="n">bdb</span><span class="o">.</span><span class="n">close_quit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Shorten URL</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">shorten</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">is_int</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">shorten</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">shorturl</span> <span class="o">=</span> <span class="n">bdb</span><span class="o">.</span><span class="n">tnyfy_url</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">shorten</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">shorturl</span> <span class="o">=</span> <span class="n">bdb</span><span class="o">.</span><span class="n">tnyfy_url</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">shorten</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">shorturl</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">shorturl</span><span class="p">)</span>

    <span class="c1"># Expand URL</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">expand</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">is_int</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">expand</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">url</span> <span class="o">=</span> <span class="n">bdb</span><span class="o">.</span><span class="n">tnyfy_url</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">expand</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">shorten</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">url</span> <span class="o">=</span> <span class="n">bdb</span><span class="o">.</span><span class="n">tnyfy_url</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">expand</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">shorten</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">url</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>

    <span class="c1"># Report upstream version</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">upstream</span><span class="p">:</span>
        <span class="n">check_upstream_release</span><span class="p">()</span>

    <span class="c1"># Fix tags</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">fixtags</span><span class="p">:</span>
        <span class="n">bdb</span><span class="o">.</span><span class="n">fixtags</span><span class="p">()</span>

    <span class="c1"># Close DB connection and quit</span>
    <span class="n">bdb</span><span class="o">.</span><span class="n">close_quit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span></div>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>

           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, Arun Prakash Jana.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>